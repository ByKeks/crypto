/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(t,v){"function"===typeof define&&define.amd?define(["gostObject","gostCoding","gostSyntax","gostCrypto"],v):"object"===typeof exports?module.exports=v(require("gostObject"),require("gostCoding"),require("gostSyntax"),require("gostCrypto")):t.GostPKIX=v(t.gostObject,t.gostCoding,t.gostSyntax,t.gostCrypto)})(this,function(t,v,S,F){function m(a){return(S||(S=p.gostSyntax))[a]}function k(){return(F||(F=p.gostCrypto)).subtle}function u(a){try{a()}catch(b){}}function r(a,b){return"string"===typeof a||
a instanceof String||a instanceof ArrayBuffer?m(b).decode(a):a}function A(a){if("string"===typeof a||a instanceof String)a=(v||(v=p.gostCoding)).PEM.decode(a);if(!(a instanceof ArrayBuffer))throw Error("Type of data must be FormatedData");return a}function C(a){a=new Uint8Array(a);(F||(F=p.gostCrypto)).getRandomValues(a);return a.buffer}function z(a,b){for(var f in a)if("buffer"!==f&&("undefined"===typeof b[f]||a[f]!==b[f]))return!1;for(f in b)if("buffer"!==f&&("undefined"===typeof a[f]||a[f]!==b[f]))return!1;
return!0}function O(a){var b=typeof a;if("undefined"===b||""===a)return"0";a="number"===b||a instanceof Number?a.toString(16):a.replace("0x","");return a.toLowerCase()}function P(a,b){a=O(a);b=O(b);var f=Math.max(a.length,b.length),c=a;a=(Array(f+1).join("0")+c).slice(-f);c=b;b=(Array(f+1).join("0")+c).slice(-f);return a>b?1:a<b?-1:0}function Q(a,b){var f=new Uint8Array(a),c=new Uint8Array(b);if(f.length>c.length)return 1;if(f.length<c.length)return-1;for(var d=0,e=f.length;d<e;d++){if(f[d]>c[d])return 1;
if(f[d]<c[d])return-1}return 0}function T(a,b){return a&&b&&(!b.issuer||z(a.tbsCertificate.issuer,b.issuer))&&(!b.serialNumber||0===P(a.tbsCertificate.serialNumber,b.serialNumber))&&(!b.subjectKeyIdentifier||0===Q(a.tbsCertificate.extensions.subjectKeyIdentifier,b.subjectKeyIdentifier))&&(!b.subject||z(a.tbsCertificate.subject,b.subject))&&(!b.date||a.tbsCertificate.validity.notBefore.getTime()<b.date.getTime()&&a.tbsCertificate.validity.notAfter.getTime()>b.date.getTime())}function K(a,b){for(var f=
[],c=0,d=a.length;c<d;c++)T(a[c],b)&&f.push(a[c]);return f}function G(a,b){return K(a.getAllCertificates(),b)}function U(a,b){for(var f=[],c=0,d=a.length;c<d;c++){var e=a[c],g=b;g.issuer&&!z(e.tbsCertList.issuer,g.issuer)||g.date&&!(e.tbsCertList.thisUpdate.getTime()<g.date.getTime())||f.push(a[c])}return f}function V(a,b,f,c){for(var d=[];a;){d.push(a);var e={subject:a.tbsCertificate.issuer,date:c};if(a.tbsCertificate.extensions&&a.tbsCertificate.extensions.authorityKeyIdentifier){var g=a.tbsCertificate.extensions.authorityKeyIdentifier;
e.subjectKeyIdentifier=g.keyIdentifier;g.authorityCertIssuer&&g.authorityCertIssuer[0].directoryName&&(e.issuer=g.authorityCertIssuer[0].directoryName);g.authorityCertSerialNumber&&(e.serialNumber=(v||(v=p.gostCoding)).Int16.encode(g.authorityCertSerialNumber))}if(z(a.tbsCertificate.subject,a.tbsCertificate.issuer))a=!1;else if((a=K(b,e))&&0<a.length){a=a[0];if(e=f)a:{for(var g=a,e=f,e=U(e,{issuer:g.tbsCertificate.issuer,date:void 0}),g=g.tbsCertificate.serialNumber,h=0,l=e.length;h<l;h++)for(var s=
e[h],R=0,n=s.tbsCertList.revokedCertificates.length;R<n;R++)if(0===P(s.tbsCertList.revokedCertificates[R].userCertificate,g)){e=!0;break a}e=!1}e&&(a=!1)}else a=!1}return d}function Y(a,b){var f=a.getCertificate(b);return f?V(f,a.getAllCertificates(),a.getAllCRLs()):[]}function q(){for(var a={},b=0,f=arguments.length;b<f;b++){var c=arguments[b];if("object"===typeof c)for(var d in c)a[d]=c[d]}return a}function L(a){a=r(a,"Certificate");a=a.tbsCertificate.subjectPublicKeyInfo;var b="rsaEncryption"===
a.algorithm.id?["verify"]:["verify","deriveKey","deriveBits"];return k().importKey("spki",a.buffer,a.algorithm,!0,b)}function M(a,b,f,c){return L(a).then(function(a){return k().verify(b,a,f,c)})}function D(a,b,f){var c,d,e,g;return(new p.Promise(u)).then(function(){var d=a.keyStore.getKey(b);if(!d)throw Error("Private key not found");if(d.encryptionAlgorithm){if(!f)throw Error("Password required to decrypt key");e=d.encryptionAlgorithm.derivation;g=d.encryptionAlgorithm.encryption;c=d.encryptedData;
return k().importKey("raw",v.Chars.decode(f,"utf8"),e,!1,["deriveKey"])}c=d instanceof ArrayBuffer?d:m("PrivateKeyInfo").encode(d)}).then(function(a){return e&&k().deriveKey(e,a,g,!0,["decrypt"])}).then(function(a){return g?k().decrypt(g,a,c):c}).then(function(b){try{d=m("PrivateKeyInfo").decode(b)}catch(e){d=b}if(d.privateKeyAlgorithm){var c="rsaEncryption"===d.privateKeyAlgorithm.id?["sign"]:["sign","deriveKey","deriveBits"];return k().importKey("pkcs8",b,d.privateKeyAlgorithm,!0,c)}c=["encrypt",
"decrypt","wrapKey","unwrapKey"];return k().importKey("raw",b,a.provider.encryption,!0,c)})}function I(a,b,f,c){var d,e,g,h,l=b.type;return(new p.Promise(u)).then(function(){return"secret"===l?k().exportKey("raw",b):k().exportKey("pkcs8",b)}).then(function(b){d=b;if(c)return g=q(a.provider.pbes.derivation,{salt:C(32),iterations:1}),h=q(a.provider.pbes.encryption),h.iv||(h.iv=C(8)),k().importKey("raw",v.Chars.decode(c,"utf8"),g,!1,["deriveKey"]);e="secret"===l?d:m("PrivateKeyInfo").decode(d)}).then(function(a){return g&&
k().deriveKey(g,a,h,!0,["encrypt"])}).then(function(a){return h&&k().encrypt(h,a,d)}).then(function(b){h&&(e={encryptionAlgorithm:q(a.provider.pbes,{derivation:g,encryption:h}),encryptedData:b});f&&a.keyStore.setKey(f,e);return e})}function W(){this.entries={}}function X(a,b,f){this.provider=(t||(t=p.gostObject)).providers[a];this.format=(b||"DER").toUpperCase();this.keyStore=f||new W}var p=this;W.prototype={aliases:function(){var a=[],b;for(b in this.entries)a.push(b);return a},containsAlias:function(a){return a in
this.entries},deleteEntry:function(a){delete this.entires[a]},getCertificate:function(a){if(a=this.entries[a])return a.cert},getCRL:function(a){if(a=this.entries[a])return a.crl},getRequest:function(a){if(a=this.entries[a])return a.request},getKey:function(a){if(a=this.entries[a])return a.key},setCertificate:function(a,b){(this.entries[a]||(this.entries[a]={})).cert=r(b,"Certificate")},setCRL:function(a,b){(this.entries[a]||(this.entries[a]={})).crl=r(b,"CertificateList")},setRequest:function(a,b){(this.entries[a]||
(this.entries[a]={})).request=r(b,"CertificationRequest")},setKey:function(a,b){try{b=r(b,"PrivateKeyInfo")}catch(f){try{b=r(b,"EncryptedPrivateKeyInfo")}catch(c){b=A(b)}}(this.entries[a]||(this.entries[a]={})).key=b},getAllCertificates:function(){var a=[],b;for(b in this.entries){var f=this.entries[b];f.cert&&a.push(f.cert)}return a},getAllCRLs:function(){var a=[],b;for(b in this.entries){var f=this.entries[b];f.crl&&a.push(f.crl)}return a}};X.prototype={importKeyStore:function(a,b){var f=this,c=
f.keyStore,d,e,g,h,l;return(new p.Promise(u)).then(function(){a=r(a,"PFX");h=a.authSafe;if(b&&!a.macData)throw Error("Password based MAC must present");if("signedData"!==h.contentType&&"data"!==h.contentType)throw Error("Unsupported format");if(b)return d=q(f.provider.pbmac.derivation,{salt:a.macData.macSalt,iterations:a.macData.iterations}),e=q(f.provider.pbmac.hmac),k().importKey("raw",v.Chars.decode(b,"utf8"),d,!1,["deriveKey"])}).then(function(a){return d&&k().deriveKey(d,a,e,!0,["verify"])}).then(function(b){g=
b;return e&&k().verify(e,g,a.macData.mac.digest,h.buffer)}).then(function(a){if(!a)throw Error("MAC not verified");return"signedData"===h.contentType?f.verifyData(h):h}).then(function(a){h=a;if("data"!==h.contentType)throw Error("Unsupported format");l=m("AuthenticatedSafe").decode(h.content);return Promise.all(l.map(function(a){if("encryptedData"===a.contentType)return f.decryptData(a,b);if("data"===a.contentType)return a;throw Error("Format not supported");}))}).then(function(b){l=b;var d=function(a){a.forEach(function(a){var b=
a.bagAttributes&&a.bagAttributes.friendlyName||(v||(v=p.gostCoding)).PEM.encode(C(12));switch(a.bagId){case "keyBag":case "pkcs8ShroudedKeyBag":c.setKey(b,a.bagValue);break;case "certBag":"x509Certificate"===a.bagValue.certId&&c.setCertificate(b,a.bagValue.certValue);break;case "crlBag":"x509CRL"===a.bagValue.crlId&&c.setCRL(b,a.bagValue.crlValue);break;case "safeContentsBag":d(a.bagValue)}})};l.forEach(function(a){d(m("SafeContents").decode(a.content))});return a})},exportKeyStore:function(a,b){var f=
this,c=f.keyStore,d,e,g,h,l;return(new p.Promise(u)).then(function(){for(var e=c.aliases(),l=[],n=0,J=e.length;n<J;n++){var B=e[n],p=c.getKey(B),y;p&&(p.privateKeyAlgorithm?y={bagId:"keyBag",bagValue:r(p,"PrivateKeyInfo")}:p.encryptionAlgorithm&&(y={bagId:"pkcs8ShroudedKeyBag",bagValue:p}),y.bagAttributes={localKeyId:n.toString(16),friendlyName:B},l.push(y));(p=c.getCertificate(B))&&l.push({bagId:"certBag",bagValue:{certId:"x509Certificate",certValue:p},bagAttributes:{friendlyName:B}});(p=c.getCRL(B))&&
l.push({bagId:"crlBag",bagValue:{crlId:"x509CRL",crlValue:p},bagAttributes:{friendlyName:B}})}d=m("SafeContents").encode(l);b=(b||"mac").toLowerCase();if(a)return g=q(f.provider.pbmac.derivation,{salt:C(32),iterations:1}),h=q(f.provider.pbmac.hmac),k().importKey("raw",v.Chars.decode(a,"utf8"),g,!1,["deriveKey"]);if("encrypt"===b)throw Error("Password required for MAC calculation");}).then(function(a){return g&&k().deriveKey(g,a,h,!0,["sign"])}).then(function(e){l=e;return"encrypt"===b?f.encryptData(d,
"pbes",a):{contentType:"data",content:d}}).then(function(a){a=r(a,"ContentInfo");e={contentType:"data",content:m("AuthenticatedSafe").encode([a])};e.buffer=m("ContentInfo").encode(e);return h&&k().sign(h,l,e.buffer)}).then(function(a){var b={version:3,authSafe:e};a&&(b.macData={mac:{digestAlgorithm:h.hash,digest:a},macSalt:g.salt,iterations:g.iterations});return m("PFX").encode(b,f.format)})},exportKey:function(a,b,f){var c=this;return(new p.Promise(u)).then(function(){return D(c,a,f)}).then(function(a){b=
(b||"p8").toLowerCase();switch(b){case "p8":return I(c,a);case "p8e":if(!f)throw Error("Password required for export to encrypted format");return I(c,a,void 0,f);case "p12":throw Error("Not yet implemented");}}).then(function(a){switch(b){case "p8":return m("PrivateKeyInfo").encode(a,c.format);case "p8e":return m("EncryptedPrivateKeyInfo").encode(a,c.format)}})},importKey:function(a,b,f){var c=this;return(new p.Promise(u)).then(function(){try{a=r(a,"PrivateKeyInfo")}catch(d){try{a=r(a,"EncryptedPrivateKeyInfo")}catch(e){a=
A(a)}}c.keyStore.setKey(b,a);if(!a.encryptionAlgorithm&&f)return D(c,b)}).then(function(d){return d?I(c,d,b,f):a})},createCertificate:function(a,b,f){var c=this,d={},e={},g,h;return(new p.Promise(u)).then(function(){a=a||{};d.version=2;e.signatureAlgorithm=d.signature=a.signature||c.provider.signature;if(!d.signature)throw Error("Signature Algorithm not defined");var b=c.provider.generation;if(!b)throw Error("Key Algorithm not defined");return k().generateKey(b,!0,["sign","verify"])}).then(function(a){g=
a.publicKey;h=a.privateKey;return k().exportKey("spki",g)}).then(function(a){d.subjectPublicKeyInfo=m("SubjectPublicKeyInfo").decode(a);return k().digest(c.provider.digest,a)}).then(function(b){b=(new Uint8Array(new Uint8Array(b,0,20))).buffer;d.subject=a.subject||a.issure;d.issuer=d.subject;if(!d.subject)throw Error("Subject or issuer not defined");d.serialNumber=a.serialNumber||1;var c={};a.validity&&a.validity.notBefore?c.notBefore=a.validity.notBefore:(c.notBefore=new Date,c.notBefore.setHours(0,
0,0,0));a.validity&&a.validity.notAfter?c.notAfter=a.validity.notAfter:(c.notAfter=new Date(c.notBefore),c.notAfter.setFullYear(c.notAfter.getFullYear()+25));d.validity=c;c=a.extensions||{};c.keyUsage=c.keyUsage||"digitalSignature nonRepudiation keyEncipherment dataEncipherment keyAgreement keyCertSign cRLSign".split(" ");c.basicConstraints=c.basicConstraints||{cA:!0};c.extKeyUsage=c.extKeyUsage||"serverAuth clientAuth codeSigning emailProtection ipsecEndSystem ipsecTunnel ipsecUser timeStamping OCSPSigning".split(" ");
c.subjectKeyIdentifier=b;c.authorityKeyIdentifier={keyIdentifier:b,authorityCertIssuer:[{directoryName:d.issuer}],authorityCertSerialNumber:d.serialNumber};d.extensions=c;d.buffer=m("TBSCertificate").encode(d);return k().sign(e.signatureAlgorithm,h,d.buffer)}).then(function(a){e.tbsCertificate=d;e.signatureValue=a;e.buffer=m("Certificate").encode(e);return I(c,h,b,f)}).then(function(){c.keyStore.setCertificate(b,e);return m("Certificate").encode(e,c.format)})},issueCertificate:function(a,b,f,c){var d=
this,e=d.keyStore,g={},h={},l,s;return(new p.Promise(u)).then(function(){s=e.getRequest(b);l=s.requestInfo;g.version=2;g.signature=s.signatureAlgorithm;g.subjectPublicKeyInfo=l.subjectPublicKeyInfo;return k().importKey("spki",l.subjectPublicKeyInfo.buffer,l.subjectPublicKeyInfo.algorithm,!0,["verify"])}).then(function(a){return k().verify(s.signatureAlgorithm,a,s.signatureValue,l.buffer)}).then(function(a){if(!a)throw Error("Request signature is not valid");return k().digest(d.provider.digest,g.subjectPublicKeyInfo.buffer)}).then(function(b){b=
(new Uint8Array(new Uint8Array(b,0,20))).buffer;g.subject=l.subject;if(!g.subject)throw Error("Subject not defined");var n=e.getCertificate(f);if(!n)throw Error("Authority certificate not found");var s=n.tbsCertificate.extensions&&n.tbsCertificate.extensions.keyUsage;if(s&&0>s.indexOf("keyCertSign"))throw Error("Issuer key can't be used for sign certificate");var k;a.validity&&a.validity.notBefore?k=a.validity.notBefore:(k=new Date,k.setHours(0,0,0,0));var m=n.tbsCertificate.validity;if(!m||m.notBefore.getTime()>
k.getTime())throw Error("Issuer certificate is not released");if(!m||m.notAfter.getTime()<k.getTime())throw Error("Issuer certificate expired");g.issuer=n.tbsCertificate.issuer;var s=n.tbsCertificate.serialNumber,p=(n.tbsCertificate.extensions||{}).subjectKeyIdentifier,q=(n.tbsCertificate.extensions||{}).basicConstraints,q=(q=q&&q.pathLenConstraint)?q+1:0,v=n.tbsCertificate.issuer;h.signatureAlgorithm=n.tbsCertificate.signature;if(a.serialNumber)g.serialNumber=a.serialNumber;else{for(var n=G(e,{issuer:g.issuer}),
w=1,N=0,u=n.length;N<u;N++)if(0<=P(n[N].tbsCertificate.serialNumber,w)){for(var w=n[N].tbsCertificate.serialNumber,w=O(w),r="",E=1,t=w.length-1;0<=t;--t){var H=w.charCodeAt(t);1===E&&(102===H?H=48:(E=0,57===H?H=97:H++));r=String.fromCharCode(H)+r}1===E&&(r="1"+r);w="0x"+r}g.serialNumber=w}n={};n.notBefore=k;n.notAfter=a.validity&&a.validity.notAfter?a.validity.notAfter:m.notAfter;g.validity=n;k=a.extensions||{};m=l.attributes&&(l.attributes.extensionRequest||l.attributes.msCertExtensions)||{};k.keyUsage=
k.keyUsage||m.keyUsage||["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement"];k.basicConstraints=k.basicConstraints||m.basicConstraints||{cA:0<=k.keyUsage.indexOf("keyCertSign"),pathLenConstraint:q};k.extKeyUsage=k.extKeyUsage||m.extKeyUsage||["clientAuth","emailProtection"];k.subjectKeyIdentifier=b;k.authorityKeyIdentifier={keyIdentifier:p,authorityCertIssuer:[{directoryName:v}],authorityCertSerialNumber:s};g.extensions=k;return D(d,f,c)}).then(function(a){g.buffer=
m("TBSCertificate").encode(g);return k().sign(h.signatureAlgorithm,a,g.buffer)}).then(function(a){h.tbsCertificate=g;h.signatureValue=a;h.buffer=m("Certificate").encode(h);return e.setCertificate(b,h)}).then(function(){return m("Certificate").encode(h,d.format)})},exportCertificate:function(a,b){var f=this;return(new p.Promise(u)).then(function(){var c=f.keyStore.getCertificate(a);if(!c)throw Error("Certificate not found");switch((b||"x509").toLowerCase()){case "p7c":return m("ContentInfo").encode({contentType:"signedData",
content:{version:1,digestAlgorithms:[],encapContentInfo:{eContentType:"data"},certificates:[c],signerInfos:[]}},f.format);case "p12":return m("PFX").encode({version:3,authSafe:{contentType:"data",content:m("SafeContents").encode([{bagId:"certBag",crltValue:{certId:"x509Certificate",certValue:c},bagAttributes:"string"===typeof a?{friendlyName:a}:void 0}])}},f.format);default:return m("Certificate").encode(c,f.format)}})},importCertificate:function(a,b){var f=this.keyStore,c;return(new p.Promise(u)).then(function(){try{a=
r(a,"ContentInfo")}catch(b){a=r(a,"Certificate")}if(a.contentType&&("signedData"===a.contentType&&(a=a.content.certificates[0]),!a))throw Error("Invalid format");c=a.tbsCertificate;if(!c)throw Error("Invalid format");var e;if(z(a.tbsCertificate.subject,a.tbsCertificate.issuer))e=a;else if(f){e={subject:a.tbsCertificate.issuer};if(a.tbsCertificate.extensions&&a.tbsCertificate.extensions.authorityKeyIdentifier){var g=a.tbsCertificate.extensions.authorityKeyIdentifier;e.subjectKeyIdentifier=g.keyIdentifier;
g.authorityCertIssuer&&g.authorityCertIssuer[0].directoryName&&(e.issuer=g.authorityCertIssuer[0].directoryName);g.authorityCertSerialNumber&&(e.serialNumber=(v||(v=p.gostCoding)).Int16.encode(g.authorityCertSerialNumber))}if((e=G(f,e))&&0<e.length)e=e[0];else throw Error("Issuer for certificate not found in store");}return M(e,a.signatureAlgorithm,a.signatureValue,c.buffer)}).then(function(d){if(!d)throw Error("Certificate has invalid signature");b&&f.setCertificate(b,a);return a})},validateCertificate:function(a,
b){var f=this.keyStore,c=[];return(new p.Promise(u)).then(function(){var d=a;d instanceof Array||(d=[a]);d=d.map(function(a){return r(a,"Certificate")});b=b||new Date;c=V(d[0],d.concat(f.getAllCertificates()),f.getAllCRLs(),b);for(var e=!1,d=c.length-1;0<=d;--d)if(0<G(f,{issuer:c[d].tbsCertificate.issuer,serialNumber:c[d].tbsCertificate.serialNumber}).length){e=!0;break}if(!e)throw Error("There are not trusted certificates in validation path");for(var e=[],d=0,g=c.length;d<g;d++){var h=c[d],l=d+1;
l===g&&z(h.tbsCertificate.issuer,h.tbsCertificate.subject)&&(l=d);l<g&&e.push(M(c[l],h.signatureAlgorithm,h.signatureValue,h.tbsCertificate.buffer))}return Promise.all(e)}).then(function(a){for(var b=0,f=a.length;b<f;b++)if(!0!==a[b])throw Error("Certificate in path has invalid signature");return c})},createRequest:function(a,b,f){var c=this,d={},e={},g,h;return(new p.Promise(u)).then(function(){a=a||{};d.signatureAlgorithm=a.signatureAlgorithm||c.provider.signature;var b=c.provider.generation;if(!d.signatureAlgorithm)throw Error("Signature Algorithm not defined");
if(!b)throw Error("Key Algorithm not defined");return k().generateKey(b,!0,["sign","verify"])}).then(function(a){g=a.publicKey;h=a.privateKey;return k().exportKey("spki",g)}).then(function(b){e.subjectPublicKeyInfo=m("SubjectPublicKeyInfo").decode(b);e.subject=a.subject;if(!e.subject)throw Error("Subject not defined");e.version=0;b=a.extensions||{};b.keyUsage=b.keyUsage||["digitalSignature","nonRepudiation","dataEncipherment","keyAgreement"];b.extKeyUsage=["clientAuth","emailProtection"];e.attributes=
{extensionRequest:b};e.buffer=m("CertificationRequestInfo").encode(e);return k().sign(d.signatureAlgorithm,h,e.buffer)}).then(function(a){d.requestInfo=e;d.signatureValue=a;d.buffer=m("CertificationRequest").encode(d);return I(c,h,b,f)}).then(function(){c.keyStore.setRequest(b,d);return m("CertificationRequest").encode(d,c.format)})},exportRequest:function(a){var b=this,f;return(new p.Promise(u)).then(function(){f=b.keyStore.getRequest(a);if(!f)throw Error("Certification request not found");return m("CertificationRequest").encode(f,
b.format)})},importRequest:function(a,b){var f=this,c;return(new p.Promise(u)).then(function(){a=r(a,"CertificationRequest");c=a.requestInfo;var b=c.subjectPublicKeyInfo;return k().importKey("spki",b.buffer,b.algorithm,!0,["verify"])}).then(function(b){return k().verify(a.signatureAlgorithm,b,a.signatureValue,c.buffer)}).then(function(c){if(!c)throw Error("Request signature is not valid");b&&f.keyStore.setRequest(b,a);return a})},updateCRL:function(a,b,f){var c=this,d=c.keyStore,e={};return(new p.Promise(u)).then(function(){a=
a||{};var g=d.getCertificate(b);if(!g)throw Error("Issuer certificate not found");if(0>((g.tbsCertificate.extensions||{}).keyUsage||[]).indexOf("cRLSign"))throw Error("Issuer has not rights for CRL sign");var h=g.tbsCertificate.extensions&&g.tbsCertificate.extensions.keyUsage;if(h&&0>h.indexOf("cRLSign"))throw Error("Issuer key can't be used for sign CRL");if(a.issuer&&z(a.issuer,g.tbsCertificate.issue))throw Error("CRL prototype and authority certificate have different issuers");(h=d.getCRL(b))?
e=h.tbsCertList:(h=U(d.getAllCRLs,{issuer:g.tbsCertificate.issuer}))&&0<h.length?e=h[0].tbsCertList:(e.issuer=g.tbsCertificate.issuer,e.revokedCertificates=[]);e.version=1;e.signature=g.tbsCertificate.signature;a.thisUpdate?e.thisUpdate=a.thisUpdate:(e.thisUpdate=new Date,e.thisUpdate.setHours(0,0,0,0));a.nextUpdate?e.nextUpdate=a.nextUpdate:(e.nextUpdate=new Date(e.thisUpdate),e.nextUpdate.setFullYear(e.nextUpdate.getFullYear()+25));h=g.tbsCertificate.validity;if(!h||h.notBefore.getTime()>e.thisUpdate.getTime())throw Error("Issuer certificate is not released");
if(!h||h.notAfter.getTime()<e.thisUpdate.getTime())throw Error("Issuer certificate expired");h=e.revokedCertificates;if(a.revokedCertificates)for(var l=0,k=a.revokedCertificates.length;l<k;l++){var m=a.revokedCertificates[l],n={};if(!m.userCertificate)throw Error("Serail number of revoked certificate not found");n.userCertificate=m.userCertificate;m.revocationDate?n.revocationDate=m.revocationDate:(n.revocationDate=new Date,n.revocationDate.setHours(0,0,0,0));m=m.crlEntryExtensions||{};m.cRLReason=
m.cRLReason||"unspecified";n.crlEntryExtensions=m;h.push(n)}h=a.crlExtensions||{};h.authorityKeyIdentifier={keyIdentifier:(g.tbsCertificate.extensions||{}).subjectKeyIdentifier||"0",authorityCertIssuer:[{directoryName:g.tbsCertificate.issuer}],authorityCertSerialNumber:g.tbsCertificate.serialNumber};h.cRLNumber=h.cRLNumber||0;e.crlExtensions=h;return D(c,b,f)}).then(function(a){e.buffer=m("TBSCertList").encode(e);return k().sign(e.signature,a,e.buffer)}).then(function(a){a={tbsCertList:e,signatureAlgorithm:e.signature,
signatureValue:a};a.buffer=m("CertificateList").encode(a);d.setCRL(b,a);return m("CertificateList").encode(a,c.format)})},exportCRL:function(a,b){var f=this;return(new p.Promise(u)).then(function(){var c=[f.keyStore.getCRL(a)];if(!c)throw Error("CRL not found");switch((b||"x509").toLowerCase()){case "p7c":return m("ContentInfo").encode({contentType:"signedData",content:{version:4,digestAlgorithms:[],encapContentInfo:{eContentType:"data"},crls:[{crl:c}],signerInfos:[]}},f.format);case "p12":return m("PFX").encode({version:3,
authSafe:{contentType:"data",content:m("SafeContents").encode([{bagId:"crlBag",crltValue:{crlId:"x509CRL",crltValue:c},bagAttributes:"string"===typeof a?{friendlyName:a}:void 0}])}},f.format);default:return m("CertificateList").encode(c,f.format)}})},importCRL:function(a,b){var f=this.keyStore,c,d;return(new p.Promise(u)).then(function(){try{a=r(a,"ContentInfo")}catch(b){a=r(a,"CertificateList")}if(a.contentType&&("signedData"===a.contentType&&(a=a.content.crls[0]),!a))throw Error("Invalid format");
c=a.tbsCertList;if(!c)throw Error("Invalid format");var g=G(f,{issuer:c.issuer});if(g&&0<g.length)d=g[0];else throw Error("Issuer certificate not found");return M(d,a.signatureAlgorithm,a.signatureValue,c.buffer)}).then(function(c){if(!c)throw Error("Certification list has invalid signature");b&&f.setCRL(b,a);return a})},signData:function(a,b,f,c){var d=this,e=d.keyStore,g,h,l;b=b||[];b instanceof Array||(b=[b]);b=b.map(function(a){return(a||"").toLowerCase()});return(new p.Promise(u)).then(function(){try{a=
r(a,"ContentInfo")}catch(c){a={contentType:"data",content:A(a)}}var m=e.getCertificate(f);if(!m)throw Error("Signer certificate not found");h={version:1,digestAlgorithm:d.provider.digest,sid:{issuerAndSerialNumber:{issuer:m.tbsCertificate.issuer,serialNumber:m.tbsCertificate.serialNumber}}};if("signedData"===a.contentType){g=a;l=a.encapContentInfo.eContent;g.signerInfos=(g.signerInfos||[]).push(h);var n;g.digestAlgorithms=g.digestAlgorithms||[];g.digestAlgorithms.forEach(function(a){a.id===g.digestAlgorithm.id&&
(n=!0)});n||g.digestAlgorithms.push(g.digestAlgorithm);0<=b.indexOf("detached")&&(a.encapContentInfo.eContent=void 0)}else l=a.content.buffer||a.content,g={version:1,digestAlgorithms:[h.digestAlgorithm],encapContentInfo:{eContentType:a.contentType,eContent:0<=b.indexOf("detached")?void 0:l},signerInfos:[h]};if(0<=b.indexOf("certpath")){g.certificates=g.certificates||[];var p=g.certificates.map(function(a){return a.certificate});Y(e,f).forEach(function(a){0===K(p,{issuer:a.tbsCertificate.issuer,serialNumber:a.tbsCertificate.serialNumber}).length&&
g.certificates.push({certificate:a})})}if(0<=b.indexOf("attrs"))return k().digest(h.digestAlgorithm,l)}).then(function(a){a&&(h.signedAttrs={contentType:g.encapContentInfo.eContentType,messageDigest:a,signingTime:new Date},l=h.signedAttrs.buffer=m("SignedAttributes").encode(h.signedAttrs));return D(d,f,c)}).then(function(a){h.signatureAlgorithm=d.provider.generation;var b=q(h.signatureAlgorithm,{hash:h.digestAlgorithm});return k().sign(b,a,l)}).then(function(a){h.signatureValue=a;return m("ContentInfo").encode({contentType:"signedData",
content:g},d.format)})},digestData:function(a){var b=this,f;return(new p.Promise(u)).then(function(){try{a=r(a,"ContentInfo")}catch(c){a={contentType:"data",content:A(a)}}var d=a.content.buffer||a.content;f={version:1,digestAlgorithm:b.provider.digest,encapContentInfo:{eContentType:a.contentType,eContent:d}};return k().digest(f.digestAlgorithm,d)}).then(function(a){f.digest=a;return m("ContentInfo").encode({contentType:"digestedData",content:f},b.format)})},encryptData:function(a,b,f,c,d){var e=this,
g=e.keyStore,h,l,s,r,n,J,B,t,y,z,x;return(new p.Promise(u)).then(function(){a=A(a);b=(b||"keyagree").toLowerCase();if("keyagree"!==b&&"keytrans"!==b&&"kek"!==b&&"pbkek"!==b&&"keyman"!==b&&"pbes"!==b)throw Error("Invalid envelop mode");switch(b){case "keyagree":case "keytrans":s=f instanceof Array?f:[f];s=s.map(function(a){return g.getCertificate(a)});break;case "kek":case "keyman":d=c;c=f;if(!c||"string"!==typeof c)throw Error("Alias of secret key must be specified as 4th parameter");s=[f];break;
case "pbkek":case "pbes":d=f;if(!d||"string"!==typeof d)throw Error("Password must be specified as 4th parameter");s=[f]}y=s.map(function(a,b){return C(8)});x="pbes"!==b&&"keyman"!==b;if("pbes"===b)return F.subtle.importKey("raw",v.Chars.decode(d,"utf8"),e.provider.derivation,!0,["deriveKey"])}).then(function(a){h=q(e.provider.encryption);switch(b){case "keyman":return D(e,c,d);case "pbes":return k().deriveKey(q(e.provider.derivation,{salt:y[0]}),a,h,!0,["encrypt"]);default:return k().generateKey(h,
!0,["encrypt"])}}).then(function(b){r=b;h.iv||(h.iv=C(8));return k().encrypt(h,r,a)}).then(function(a){n={contentType:"data",contentEncryptionAlgorithm:h,encryptedContent:a};switch(b){case "keyagree":case "keytrans":return Promise.all(s.map(function(a){return L(a)}));case "pbes":a=q(e.provider.pbes,{derivation:q(e.provider.derivation,{salt:y[0]}),encryption:h}),n.contentEncryptionAlgorithm=a}}).then(function(a){switch(b){case "keyagree":case "keytrans":B=a;case "kek":return c?D(e,c,d):k().generateKey(e.provider.generation,
!0,["deriveKey"]);case "pbkek":return F.subtle.importKey("raw",v.Chars.decode(d,"utf8"),e.provider.derivation,!0,["deriveKey"])}}).then(function(a){if(x){J=a.privateKey||a;var d=c&&g.getCertificate(c);switch(b){case "keyagree":return c?d.tbsCertificate.subjectPublicKeyInfo:k().exportKey("spki",a.publicKey);case "keytrans":return c?L(d):a.publicKey}d&&d.tbsCertificate&&d.tbsCertificate.extensions&&(z=d.tbsCertificate.extensions.subjectKeyIdentifier)}}).then(function(a){if(x)return t=a,l="keytrans"===
b&&e.provider.transwrapping||e.provider.wrapping,Promise.all(s.map(function(a,c){var d;switch(b){case "kek":return J;case "pbkek":d=q(e.provider.derivation,{salt:y[c]});break;default:d=q(e.provider.agreement,{"public":B[c],ukm:y[c]})}return k().deriveKey(d,J,l,!0,["wrapKey"])}))}).then(function(a){if(x)return Promise.all(s.map(function(b,c){return k().wrapKey("raw",r,a[c],q(l,{ukm:y[c]}))}))}).then(function(a){if(x){var d=s.map(function(d,f){var g=s[f].tbsCertificate,g=g?{issuerAndSerialNumber:{issuer:g.issuer,
serialNumber:g.serialNumber}}:void 0;switch(b){case "keyagree":var h=m("SubjectPublicKeyInfo").decode(t),k=q(h.algorithm,e.provider.agreement,{wrapping:q(l)});return{kari:{version:3,originator:{originatorKey:{algorithm:h.algorithm,publicKey:h.subjectPublicKey}},ukm:y[f],keyEncryptionAlgorithm:k,recipientEncryptedKeys:[{rid:g,encryptedKey:a[f]}]}};case "keytrans":return k=q(t.algorithm,{ukm:y[f],"public":t,wrapping:q(l)}),{ktri:{version:0,rid:g,keyEncryptionAlgorithm:k,encryptedKey:a[f]}};case "kek":return{kekri:{version:4,
kekid:{keyIdentifier:z||(v||(v=p.gostCoding)).BER.encode(c)},keyEncryptionAlgorithm:q(l,{ukm:y[f]}),encryptedKey:a[f]}};case "pbkek":return{pwri:{version:0,keyDerivationAlgorithm:q(e.provider.derivation,{salt:y[f]}),keyEncryptionAlgorithm:q(l,{ukm:y[f]}),encryptedKey:a[f]}}}}),d={version:b=3,recipientInfos:d,encryptedContentInfo:n};return m("ContentInfo").encode({contentType:"envelopedData",content:d},e.format)}return m("ContentInfo").encode({contentType:"encryptedData",content:{version:0,encryptedContentInfo:n}},
e.format)})},verifyData:function(a,b){var f=this,c=f.keyStore,d,e,g;return(new p.Promise(u)).then(function(){var h=r(a,"ContentInfo");if("signedData"!==h.contentType&&"digestedData"!==h.contentType)throw Error("Invalid signed or digested data format");d=h.content;b&&(b=A(b));e=(g=d.encapContentInfo)&&g.eContent&&g.eContent||b;if(d.signerInfos)return Promise.all(d.signerInfos.map(function(a){a=a.sid.issuerAndSerialNumber;a={issuer:a.issuer,serialNumber:a.serialNumber};var b=G(c,a);if(0<b.length)return b;
var e=(d.certificates||[]).map(function(a){return a.certificate}),b=K(e,a);if(0===b.length)throw Error("Certificate for verification not found");return f.validateCertificate(b.concat(e))}))}).then(function(a){if(d.signerInfos)return Promise.all(d.signerInfos.map(function(b,c){var d=e;if(b.signedAttrs){if(!b.signedAttrs.messageDigest)throw Error("Message digest must present in signed attributes");d=m("SignedAttributes").encode(b.signedAttrs)}if(!d)throw Error("Data for verification not found");var f=
q(b.signatureAlgorithm,{hash:b.digestAlgorithm});return M(a[c][0],f,b.signatureValue,d)}))}).then(function(a){if(d.signerInfos){for(var b=0,c=a.length;b<c;b++)if(!0!==a[b])throw Error("Signature not verified");return Promise.all(d.signerInfos.map(function(a){return a.signedAttrs&&e?k().digest(a.digestAlgorithm,e):!1}))}return k().digest(d.digestAlgorithm,e)}).then(function(a){if(d.signerInfos)d.signerInfos.forEach(function(b,c){if(b.signedAttrs&&e&&0!==Q(a[c],b.signedAttrs.messageDigest))throw Error("Data digest not verified");
});else if(0!==Q(a,d.digest))throw Error("Data digest not verified");return{contentType:g&&g.eContentType||"data",content:e}})},decryptData:function(a,b,f){var c=this,d=c.keyStore,e,g,h,l,s,t,n;return(new p.Promise(u)).then(function(){var h=r(a,"ContentInfo");if("envelopedData"!==h.contentType&&"encryptedData"!==h.contentType)throw Error("Invalid enveloped or encrypted data format");e=h.content;var k=function(a){a:{for(var d=c.keyStore,e=d.aliases(),f=0,g=e.length;f<g;f++){var h=e[f];if(T(d.getCertificate(h),
a)){a=h;break a}}a=void 0}if(b&&b===a)return!0;a&&m.push(a)};n=e.encryptedContentInfo.contentEncryptionAlgorithm;if("envelopedData"===h.contentType){for(var h=e.recipientInfos,m=[],t=0,u=h.length;t<u;t++){var x=h[t];if(x.ktri){g="keytrans";var w=x.ktri.rid;if(w&&w.issuerAndSerialNumber&&k({issuer:w.issuerAndSerialNumber.issuer,serialNumber:w.issuerAndSerialNumber.serialNumber})||w.subjectKeyIdentifier&&k({subjectKeyIdentifier:w.subjectKeyIdentifier}))l=x.ktri}else if(x.kari){g="keyagree";for(var z=
x.kari.recipientEncryptedKeys,A=0,C=z.length;A<C;A++)if((w=z[t].rid)&&w.issuerAndSerialNumber&&k({issuer:w.issuerAndSerialNumber.issuer,serialNumber:w.issuerAndSerialNumber.serialNumber})||w.subjectKeyIdentifier&&k({subjectKeyIdentifier:w.subjectKeyIdentifier})){l={originator:x.kari.originator,keyEncryptionAlgorithm:x.kari.keyEncryptionAlgorithm,ukm:x.kari.ukm,encryptedKey:z[t].encryptedKey};break}}else if(x.kekri){g="kek";w=x.kekri.kekid.keyIdentifier;try{var E=(v||(v=p.gostCoding)).BER.decode(w);
E instanceof String&&d.containsAlias(E)&&(b===E.toString()?l=x.kekri:m.push(E))}catch(G){k({subjectKeyIdentifier:w})&&(l=x.kekri)}}else if(x.pwri){g="pbkek";f=b;if(!f||"string"!==typeof f)throw Error("Password required");l=x.pwri}if(l)break}if(!l){if(0<m.length)throw Error("Recipient key required ["+m.join(",")+"]");throw Error("No recipient found in store");}}else if("PBES2"===n.id||"id-sc-pbeWithGost3411AndGost28147"===n.id||"id-sc-pbeWithGost3411AndGost28147CFB"===n.id){if(g="pbes",f=b,!f||"string"!==
typeof f)throw Error("Password required");}else if(g="keyman",!b)throw Error("Secret key alias required");switch(g){case "keytrans":case "keyagree":case "kek":case "keyman":return D(c,b,f);case "pbkek":s=q(c.provider.derivation,{salt:l.keyDerivationAlgorithm.salt,iterations:l.keyDerivationAlgorithm.iterations,hmac:l.keyDerivationAlgorithm.hmac});break;case "pbes":k=n,s=q(c.provider.derivation,{salt:k.derivation.salt,iterations:k.derivation.iterations,hmac:k.derivation.hmac}),n=k.encryption}return F.subtle.importKey("raw",
v.Chars.decode(f,"utf8"),s,!0,["deriveKey"])}).then(function(a){h=a;switch(g){case "keyagree":a=l.originator;if(a.originatorKey){var b=m("SubjectPublicKeyInfo").encode({algorithm:a.originatorKey.algorithm,subjectPublicKey:a.originatorKey.publicKey});return k().importKey("spki",b,a.originatorKey.algorithm,!0,["verify","deriveKey"])}if((a=G(d,a.issuerAndSerialNumber?{issuer:a.issuerAndSerialNumber.issuer,serialNumber:a.issuerAndSerialNumber.serialNumber}:{subjectKeyIdentifier:a.subjectKeyIdentifier}))&&
0<a.length)return L(a[0]);throw Error("Originator certificate not found in key stores");}}).then(function(a){switch(g){case "keytrans":s=q(c.provider.agreement,{ukm:l.keyEncryptionAlgorithm.ukm,"public":l.keyEncryptionAlgorithm["public"],sBox:l.keyEncryptionAlgorithm.sBox});t=q(c.provider.transwrapping||c.provider.wrapping,l.keyEncryptionAlgorithm.wrapping,{ukm:l.keyEncryptionAlgorithm.ukm});break;case "keyagree":s=q(l.keyEncryptionAlgorithm,{ukm:l.ukm,"public":a});t=q(l.keyEncryptionAlgorithm.wrapping||
c.provider.wrapping,{ukm:l.ukm});break;case "kek":return t=q(l.keyEncryptionAlgorithm),h;case "keyman":return h;case "pbkek":t=q(l.keyEncryptionAlgorithm);break;case "pbes":t=n}return k().deriveKey(s,h,t,!0,["unwrapKey","decrypt"])}).then(function(a){switch(g){case "pbes":case "keyman":return a;default:return k().unwrapKey("raw",l.encryptedKey,a,t,n,!0,["decrypt"])}}).then(function(a){return k().decrypt(n,a,e.encryptedContentInfo.encryptedContent)}).then(function(a){return{contentType:e.encryptedContentInfo.contentType,
content:a}})},extractData:function(a,b,f){var c=this;return(new p.Promise(u)).then(function(){var d=r(a,"ContentInfo");switch(d.contentType){case "data":return d.content;case "signedData":case "digestedData":return c.verifyData(a);case "encryptedData":case "envelopedData":return c.decryptData(a,b,f);default:throw Error("Data format not supported");}}).then(function(a){var e=a?a.contentType:!1;return"signedData"===e||"digestedData"===e||"encryptedData"===e||"envelopedData"===e?c.extractData(a.content,
b,f):a})}};return X});
