/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(s,t){"function"===typeof define&&define.amd?define(["gostObject","gostCoding","gostSyntax","gostCrypto"],t):"object"===typeof exports?module.exports=t(require("gostObject"),require("gostCoding"),require("gostSyntax"),require("gostCrypto")):s.GostPKIX=t(s.gostObject,s.gostCoding,s.gostSyntax,s.gostCrypto)})(this,function(s,t,Q,E){function n(a){return(Q||(Q=m.gostSyntax))[a]}function l(){return(E||(E=m.gostCrypto)).subtle}function w(a){try{a()}catch(b){}}function u(a,b){return"string"===typeof a||
a instanceof String||a instanceof ArrayBuffer?n(b).decode(a):a}function G(a){if("string"===typeof a||a instanceof String)a=(t||(t=m.gostCoding)).PEM.decode(a);if(!(a instanceof ArrayBuffer))throw Error("Type of data must be FormatedData");return a}function C(a){a=new Uint8Array(a);(E||(E=m.gostCrypto)).getRandomValues(a);return a.buffer}function A(a,b){for(var f in a)if("buffer"!==f&&("undefined"===typeof b[f]||a[f]!==b[f]))return!1;for(f in b)if("buffer"!==f&&("undefined"===typeof a[f]||a[f]!==b[f]))return!1;
return!0}function N(a){var b=typeof a;if("undefined"===b||""===a)return"0";a="number"===b||a instanceof Number?a.toString(16):a.replace("0x","");return a.toLowerCase()}function O(a,b){a=N(a);b=N(b);var f=Math.max(a.length,b.length),c=a;a=(Array(f+1).join("0")+c).slice(-f);c=b;b=(Array(f+1).join("0")+c).slice(-f);return a>b?1:a<b?-1:0}function R(a,b){var f=new Uint8Array(a),c=new Uint8Array(b);if(f.length>c.length)return 1;if(f.length<c.length)return-1;for(var e=0,d=f.length;e<d;e++){if(f[e]>c[e])return 1;
if(f[e]<c[e])return-1}return 0}function S(a,b){return a&&b&&(!b.issuer||A(a.tbsCertificate.issuer,b.issuer))&&(!b.serialNumber||0===O(a.tbsCertificate.serialNumber,b.serialNumber))&&(!b.subjectKeyIdentifier||0===R(a.tbsCertificate.extensions.subjectKeyIdentifier,b.subjectKeyIdentifier))&&(!b.subject||A(a.tbsCertificate.subject,b.subject))&&(!b.date||a.tbsCertificate.validity.notBefore.getTime()<b.date.getTime()&&a.tbsCertificate.validity.notAfter.getTime()>b.date.getTime())}function K(a,b){for(var f=
[],c=0,e=a.length;c<e;c++)S(a[c],b)&&f.push(a[c]);return f}function B(a,b){return K(a.getAllCertificates(),b)}function T(a,b){for(var f=[],c=0,e=a.length;c<e;c++){var d=a[c],g=b;g.issuer&&!A(d.tbsCertList.issuer,g.issuer)||g.date&&!(d.tbsCertList.thisUpdate.getTime()<g.date.getTime())||f.push(a[c])}return f}function U(a,b,f,c){for(var e=[];a;){e.push(a);var d={subject:a.tbsCertificate.issuer,date:c};if(a.tbsCertificate.extensions&&a.tbsCertificate.extensions.authorityKeyIdentifier){var g=a.tbsCertificate.extensions.authorityKeyIdentifier;
d.subjectKeyIdentifier=g.keyIdentifier;g.authorityCertIssuer[0].directoryName&&(d.issuer=g.authorityCertIssuer[0].directoryName);d.serialNumber=(t||(t=m.gostCoding)).Int16.encode(g.authorityCertSerialNumber)}if(A(a.tbsCertificate.subject,a.tbsCertificate.issuer))a=!1;else if((a=K(b,d))&&0<a.length){a=a[0];if(d=f)a:{for(var g=a,d=f,d=T(d,{issuer:g.tbsCertificate.issuer,date:void 0}),g=g.tbsCertificate.serialNumber,h=0,k=d.length;h<k;h++)for(var r=d[h],P=0,p=r.tbsCertList.revokedCertificates.length;P<
p;P++)if(0===O(r.tbsCertList.revokedCertificates[P].userCertificate,g)){d=!0;break a}d=!1}d&&(a=!1)}else a=!1}return e}function X(a,b){var f=a.getCertificate(b);return f?U(f,a.getAllCertificates(),a.getAllCRLs()):[]}function q(){for(var a={},b=0,f=arguments.length;b<f;b++){var c=arguments[b];if("object"===typeof c)for(var e in c)a[e]=c[e]}return a}function L(a){a=u(a,"Certificate");a=a.tbsCertificate.subjectPublicKeyInfo;var b="rsaEncryption"===a.algorithm.id?["verify"]:["verify","deriveKey","deriveBits"];
return l().importKey("spki",a.buffer,a.algorithm,!0,b)}function M(a,b,f,c){return L(a).then(function(a){return l().verify(b,a,f,c)})}function D(a,b,f){var c,e,d,g;return(new m.Promise(w)).then(function(){var e=a.keyStore.getKey(b);if(!e)throw Error("Private key not found");if(e.encryptionAlgorithm){if(!f)throw Error("Password required to decrypt key");d=e.encryptionAlgorithm.derivation;g=e.encryptionAlgorithm.encryption;c=e.encryptedData;return l().importKey("raw",t.Chars.decode(f,"utf8"),d,!1,["deriveKey"])}c=
e instanceof ArrayBuffer?e:n("PrivateKeyInfo").encode(e)}).then(function(a){return d&&l().deriveKey(d,a,g,!0,["decrypt"])}).then(function(a){a&&console.log(t.Hex.encode(a.buffer));return g?l().decrypt(g,a,c):c}).then(function(b){try{e=n("PrivateKeyInfo").decode(b)}catch(d){e=b}if(e.privateKeyAlgorithm){var c="rsaEncryption"===e.privateKeyAlgorithm.id?["sign"]:["sign","deriveKey","deriveBits"];return l().importKey("pkcs8",b,e.privateKeyAlgorithm,!0,c)}c=["encrypt","decrypt","wrapKey","unwrapKey"];
return l().importKey("raw",b,a.provider.encryption,!0,c)})}function I(a,b,f,c){var e,d,g,h,k=b.type;return(new m.Promise(w)).then(function(){return"secret"===k?l().exportKey("raw",b):l().exportKey("pkcs8",b)}).then(function(b){e=b;if(c)return g=q(a.provider.pbes.derivation,{salt:C(32),iterations:1}),h=q(a.provider.pbes.encryption),h.iv||(h.iv=C(8)),l().importKey("raw",t.Chars.decode(c,"utf8"),g,!1,["deriveKey"]);d="secret"===k?e:n("PrivateKeyInfo").decode(e)}).then(function(a){return g&&l().deriveKey(g,
a,h,!0,["encrypt"])}).then(function(a){a&&console.log(t.Hex.encode(a.buffer));return h&&l().encrypt(h,a,e)}).then(function(b){h&&(d={encryptionAlgorithm:q(a.provider.pbes,{derivation:g,encryption:h}),encryptedData:b});f&&a.keyStore.setKey(f,d);return d})}function V(){this.entries={}}function W(a,b,f){this.provider=(s||(s=m.gostObject)).providers[a];this.format=(b||"DER").toUpperCase();this.keyStore=f||new V}var m=this;V.prototype={aliases:function(){var a=[],b;for(b in this.entries)a.push(b);return a},
containsAlias:function(a){return a in this.entries},deleteEntry:function(a){delete this.entires[a]},getCertificate:function(a){if(a=this.entries[a])return a.cert},getCRL:function(a){if(a=this.entries[a])return a.crl},getRequest:function(a){if(a=this.entries[a])return a.request},getKey:function(a){if(a=this.entries[a])return a.key},setCertificate:function(a,b){(this.entries[a]||(this.entries[a]={})).cert=u(b,"Certificate")},setCRL:function(a,b){(this.entries[a]||(this.entries[a]={})).crl=u(b,"CertificateList")},
setRequest:function(a,b){(this.entries[a]||(this.entries[a]={})).request=u(b,"CertificationRequest")},setKey:function(a,b){try{b=u(b,"PrivateKeyInfo")}catch(f){try{b=u(b,"EncryptedPrivateKeyInfo")}catch(c){b=G(b)}}(this.entries[a]||(this.entries[a]={})).key=b},getAllCertificates:function(){var a=[],b;for(b in this.entries){var f=this.entries[b];f.cert&&a.push(f.cert)}return a},getAllCRLs:function(){var a=[],b;for(b in this.entries){var f=this.entries[b];f.crl&&a.push(f.crl)}return a}};W.prototype=
{importKeyStore:function(a,b){var f=this,c=f.keyStore,e,d,g,h,k;return(new m.Promise(w)).then(function(){a=u(a,"PFX");h=a.authSafe;if(b&&!a.macData)throw Error("Password based MAC must present");if("signedData"!==h.contentType&&"data"!==h.contentType)throw Error("Unsupported format");if(b)return e=q(f.provider.pbmac.derivation,{salt:a.macData.macSalt,iterations:a.macData.iterations}),d=q(f.provider.pbmac.hmac),l().importKey("raw",t.Chars.decode(b,"utf8"),e,!1,["deriveKey"])}).then(function(a){return e&&
l().deriveKey(e,a,d,!0,["verify"])}).then(function(b){g=b;return d&&l().verify(d,g,a.macData.mac.digest,h.buffer)}).then(function(a){if(!a)throw Error("MAC not verified");return"signedData"===h.contentType?f.verifyData(h):h}).then(function(a){h=a;if("data"!==h.contentType)throw Error("Unsupported format");k=n("AuthenticatedSafe").decode(h.content);return Promise.all(k.map(function(a){if("encryptedData"===a.contentType)return f.decryptData(a,b);if("data"===a.contentType)return a;throw Error("Format not supported");
}))}).then(function(b){k=b;var e=function(a){a.forEach(function(a){var b=a.bagAttributes&&a.bagAttributes.friendlyName||(t||(t=m.gostCoding)).PEM.encode(C(12));switch(a.bagId){case "keyBag":case "pkcs8ShroudedKeyBag":c.setKey(b,a.bagValue);break;case "certBag":"x509Certificate"===a.bagValue.certId&&c.setCertificate(b,a.bagValue.certValue);break;case "crlBag":"x509CRL"===a.bagValue.crlId&&c.setCRL(b,a.bagValue.crlValue);break;case "safeContentsBag":e(a.bagValue)}})};k.forEach(function(a){e(n("SafeContents").decode(a.content))});
return a})},exportKeyStore:function(a,b){var f=this,c=f.keyStore,e,d,g,h,k;return(new m.Promise(w)).then(function(){for(var d=c.aliases(),k=[],p=0,J=d.length;p<J;p++){var v=d[p],m=c.getKey(v),z;m&&(m.privateKeyAlgorithm?z={bagId:"keyBag",bagValue:u(m,"PrivateKeyInfo")}:m.encryptionAlgorithm&&(z={bagId:"pkcs8ShroudedKeyBag",bagValue:m}),z.bagAttributes={localKeyId:p.toString(16),friendlyName:v},k.push(z));(m=c.getCertificate(v))&&k.push({bagId:"certBag",bagValue:{certId:"x509Certificate",certValue:m},
bagAttributes:{friendlyName:v}});(m=c.getCRL(v))&&k.push({bagId:"crlBag",bagValue:{crlId:"x509CRL",crlValue:m},bagAttributes:{friendlyName:v}})}e=n("SafeContents").encode(k);b=(b||"mac").toLowerCase();if(a)return g=q(f.provider.pbmac.derivation,{salt:C(32),iterations:1}),h=q(f.provider.pbmac.hmac),l().importKey("raw",t.Chars.decode(a,"utf8"),g,!1,["deriveKey"]);if("encrypt"===b)throw Error("Password required for MAC calculation");}).then(function(a){return g&&l().deriveKey(g,a,h,!0,["sign"])}).then(function(d){k=
d;return"encrypt"===b?f.encryptData(e,"pbes",a):{contentType:"data",content:e}}).then(function(a){a=u(a,"ContentInfo");d={contentType:"data",content:n("AuthenticatedSafe").encode([a])};d.buffer=n("ContentInfo").encode(d);return h&&l().sign(h,k,d.buffer)}).then(function(a){var b={version:3,authSafe:d};a&&(b.macData={mac:{digestAlgorithm:h.hash,digest:a},macSalt:g.salt,iterations:g.iterations});return n("PFX").encode(b,f.format)})},exportKey:function(a,b,f){var c=this;return(new m.Promise(w)).then(function(){return D(c,
a,f)}).then(function(a){b=(b||"p8").toLowerCase();switch(b){case "p8":return I(c,a);case "p8e":if(!f)throw Error("Password required for export to encrypted format");return I(c,a,void 0,f);case "p12":throw Error("Not yet implemented");}}).then(function(a){switch(b){case "p8":return n("PrivateKeyInfo").encode(a,c.format);case "p8e":return n("EncryptedPrivateKeyInfo").encode(a,c.format)}})},importKey:function(a,b,f){var c=this;return(new m.Promise(w)).then(function(){try{a=u(a,"PrivateKeyInfo")}catch(e){try{a=
u(a,"EncryptedPrivateKeyInfo")}catch(d){a=G(a)}}c.keyStore.setKey(b,a);if(!a.encryptionAlgorithm&&f)return D(c,b)}).then(function(e){return e?I(c,e,b,f):a})},createCertificate:function(a,b,f){var c=this,e={},d={},g,h;return(new m.Promise(w)).then(function(){a=a||{};e.version=2;d.signatureAlgorithm=e.signature=a.signature||c.provider.signature;if(!e.signature)throw Error("Signature Algorithm not defined");var b=c.provider.generation;if(!b)throw Error("Key Algorithm not defined");return l().generateKey(b,
!0,["sign","verify"])}).then(function(a){g=a.publicKey;h=a.privateKey;return l().exportKey("spki",g)}).then(function(a){e.subjectPublicKeyInfo=n("SubjectPublicKeyInfo").decode(a);return l().digest(c.provider.digest,a)}).then(function(b){b=(new Uint8Array(new Uint8Array(b,0,20))).buffer;e.subject=a.subject||a.issure;e.issuer=e.subject;if(!e.subject)throw Error("Subject or issuer not defined");e.serialNumber=a.serialNumber||1;var c={};a.validity&&a.validity.notBefore?c.notBefore=a.validity.notBefore:
(c.notBefore=new Date,c.notBefore.setHours(0,0,0,0));a.validity&&a.validity.notAfter?c.notAfter=a.validity.notAfter:(c.notAfter=new Date(c.notBefore),c.notAfter.setFullYear(c.notAfter.getFullYear()+25));e.validity=c;c=a.extensions||{};c.keyUsage=c.keyUsage||"digitalSignature nonRepudiation keyEncipherment dataEncipherment keyAgreement keyCertSign cRLSign".split(" ");c.basicConstraints=c.basicConstraints||{cA:!0};c.extKeyUsage=c.extKeyUsage||"serverAuth clientAuth codeSigning emailProtection ipsecEndSystem ipsecTunnel ipsecUser timeStamping OCSPSigning".split(" ");
c.subjectKeyIdentifier=b;c.authorityKeyIdentifier={keyIdentifier:b,authorityCertIssuer:[{directoryName:e.issuer}],authorityCertSerialNumber:e.serialNumber};e.extensions=c;e.buffer=n("TBSCertificate").encode(e);return l().sign(d.signatureAlgorithm,h,e.buffer)}).then(function(a){d.tbsCertificate=e;d.signatureValue=a;d.buffer=n("Certificate").encode(d);return I(c,h,b,f)}).then(function(){c.keyStore.setCertificate(b,d);return n("Certificate").encode(d,c.format)})},issueCertificate:function(a,b,f,c){var e=
this,d=e.keyStore,g={},h={},k,r;return(new m.Promise(w)).then(function(){r=d.getRequest(b);k=r.requestInfo;g.version=2;g.signature=r.signatureAlgorithm;g.subjectPublicKeyInfo=k.subjectPublicKeyInfo;return l().importKey("spki",k.subjectPublicKeyInfo.buffer,k.subjectPublicKeyInfo.algorithm,!0,["verify"])}).then(function(a){return l().verify(r.signatureAlgorithm,a,r.signatureValue,k.buffer)}).then(function(a){if(!a)throw Error("Request signature is not valid");return l().digest(e.provider.digest,g.subjectPublicKeyInfo.buffer)}).then(function(b){b=
(new Uint8Array(new Uint8Array(b,0,20))).buffer;g.subject=k.subject;if(!g.subject)throw Error("Subject not defined");var p=d.getCertificate(f);if(!p)throw Error("Authority certificate not found");var r=p.tbsCertificate.extensions&&p.tbsCertificate.extensions.keyUsage;if(r&&0>r.indexOf("keyCertSign"))throw Error("Issuer key can't be used for sign certificate");var v;a.validity&&a.validity.notBefore?v=a.validity.notBefore:(v=new Date,v.setHours(0,0,0,0));var l=p.tbsCertificate.validity;if(!l||l.notBefore.getTime()>
v.getTime())throw Error("Issuer certificate is not released");if(!l||l.notAfter.getTime()<v.getTime())throw Error("Issuer certificate expired");g.issuer=p.tbsCertificate.issuer;var r=p.tbsCertificate.serialNumber,n=(p.tbsCertificate.extensions||{}).subjectKeyIdentifier,m=(p.tbsCertificate.extensions||{}).basicConstraints,m=(m=m&&m.pathLenConstraint)?m+1:0,q=p.tbsCertificate.issuer;h.signatureAlgorithm=p.tbsCertificate.signature;if(a.serialNumber)g.serialNumber=a.serialNumber;else{for(var p=B(d,{issuer:g.issuer}),
x=1,t=0,w=p.length;t<w;t++)if(0<=O(p[t].tbsCertificate.serialNumber,x)){for(var x=p[t].tbsCertificate.serialNumber,x=N(x),F="",u=1,s=x.length-1;0<=s;--s){var H=x.charCodeAt(s);1===u&&(102===H?H=48:(u=0,57===H?H=97:H++));F=String.fromCharCode(H)+F}1===u&&(F="1"+F);x="0x"+F}g.serialNumber=x}p={};p.notBefore=v;p.notAfter=a.validity&&a.validity.notAfter?a.validity.notAfter:l.notAfter;g.validity=p;v=a.extensions||{};l=k.attributes&&(k.attributes.extensionRequest||k.attributes.msCertExtensions)||{};v.keyUsage=
v.keyUsage||l.keyUsage||["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement"];v.basicConstraints=v.basicConstraints||l.basicConstraints||{cA:0<=v.keyUsage.indexOf("keyCertSign"),pathLenConstraint:m};v.extKeyUsage=v.extKeyUsage||l.extKeyUsage||["clientAuth","emailProtection"];v.subjectKeyIdentifier=b;v.authorityKeyIdentifier={keyIdentifier:n,authorityCertIssuer:[{directoryName:q}],authorityCertSerialNumber:r};g.extensions=v;return D(e,f,c)}).then(function(a){g.buffer=
n("TBSCertificate").encode(g);return l().sign(h.signatureAlgorithm,a,g.buffer)}).then(function(a){h.tbsCertificate=g;h.signatureValue=a;h.buffer=n("Certificate").encode(h);return d.setCertificate(b,h)}).then(function(){return n("Certificate").encode(h,e.format)})},exportCertificate:function(a,b){var f=this;return(new m.Promise(w)).then(function(){var c=f.keyStore.getCertificate(a);if(!c)throw Error("Certificate not found");switch((b||"x509").toLowerCase()){case "p7c":return n("ContentInfo").encode({contentType:"signedData",
content:{version:1,digestAlgorithms:[],encapContentInfo:{eContentType:"data"},certificates:[c],signerInfos:[]}},f.format);case "p12":return n("PFX").encode({version:3,authSafe:{contentType:"data",content:n("SafeContents").encode([{bagId:"certBag",crltValue:{certId:"x509Certificate",certValue:c},bagAttributes:"string"===typeof a?{friendlyName:a}:void 0}])}},f.format);default:return n("Certificate").encode(c,f.format)}})},importCertificate:function(a,b){var f=this.keyStore,c;return(new m.Promise(w)).then(function(){try{a=
u(a,"ContentInfo")}catch(b){a=u(a,"Certificate")}if(a.contentType&&("signedData"===a.contentType&&(a=a.content.certificates[0]),!a))throw Error("Invalid format");c=a.tbsCertificate;if(!c)throw Error("Invalid format");var d;if(A(a.tbsCertificate.subject,a.tbsCertificate.issuer))d=a;else if(f){d={subject:a.tbsCertificate.issuer};if(a.tbsCertificate.extensions&&a.tbsCertificate.extensions.authorityKeyIdentifier){var g=a.tbsCertificate.extensions.authorityKeyIdentifier;d.subjectKeyIdentifier=g.keyIdentifier;
g.authorityCertIssuer[0].directoryName&&(d.issuer=g.authorityCertIssuer[0].directoryName);d.serialNumber=(t||(t=m.gostCoding)).Int16.encode(g.authorityCertSerialNumber)}if((d=B(f,d))&&0<d.length)d=d[0];else throw Error("Issuer for certificate not found in store");}return M(d,a.signatureAlgorithm,a.signatureValue,c.buffer)}).then(function(c){if(!c)throw Error("Certificate has invalid signature");b&&f.setCertificate(b,a);return a})},validateCertificate:function(a,b){var f=this.keyStore,c=[];return(new m.Promise(w)).then(function(){var e=
a;e instanceof Array||(e=[a]);e=e.map(function(a){return u(a,"Certificate")});b=b||new Date;c=U(e[0],e.concat(f.getAllCertificates()),f.getAllCRLs(),b);for(var d=!1,e=c.length-1;0<=e;--e)if(0<B(f,{issuer:c[e].tbsCertificate.issuer,serialNumber:c[e].tbsCertificate.serialNumber}).length){d=!0;break}if(!d)throw Error("There are not trusted certificates in validation path");for(var d=[],e=0,g=c.length;e<g;e++){var h=c[e],k=e+1;k===g&&A(h.tbsCertificate.issuer,h.tbsCertificate.subject)&&(k=e);k<g&&d.push(M(c[k],
h.signatureAlgorithm,h.signatureValue,h.tbsCertificate.buffer))}return Promise.all(d)}).then(function(a){for(var b=0,f=a.length;b<f;b++)if(!0!==a[b])throw Error("Certificate in path has invalid signature");return c})},createRequest:function(a,b,f){var c=this,e={},d={},g,h;return(new m.Promise(w)).then(function(){a=a||{};e.signatureAlgorithm=a.signatureAlgorithm||c.provider.signature;var b=c.provider.generation;if(!e.signatureAlgorithm)throw Error("Signature Algorithm not defined");if(!b)throw Error("Key Algorithm not defined");
return l().generateKey(b,!0,["sign","verify"])}).then(function(a){g=a.publicKey;h=a.privateKey;return l().exportKey("spki",g)}).then(function(b){d.subjectPublicKeyInfo=n("SubjectPublicKeyInfo").decode(b);d.subject=a.subject;if(!d.subject)throw Error("Subject not defined");d.version=0;b=a.extensions||{};b.keyUsage=b.keyUsage||["digitalSignature","nonRepudiation","dataEncipherment","keyAgreement"];b.extKeyUsage=["clientAuth","emailProtection"];d.attributes={extensionRequest:b};d.buffer=n("CertificationRequestInfo").encode(d);
return l().sign(e.signatureAlgorithm,h,d.buffer)}).then(function(a){e.requestInfo=d;e.signatureValue=a;e.buffer=n("CertificationRequest").encode(e);return I(c,h,b,f)}).then(function(){c.keyStore.setRequest(b,e);return n("CertificationRequest").encode(e,c.format)})},exportRequest:function(a){var b=this,f;return(new m.Promise(w)).then(function(){f=b.keyStore.getRequest(a);if(!f)throw Error("Certification request not found");return n("CertificationRequest").encode(f,b.format)})},importRequest:function(a,
b){var f=this,c;return(new m.Promise(w)).then(function(){a=u(a,"CertificationRequest");c=a.requestInfo;var b=c.subjectPublicKeyInfo;return l().importKey("spki",b.buffer,b.algorithm,!0,["verify"])}).then(function(b){return l().verify(a.signatureAlgorithm,b,a.signatureValue,c.buffer)}).then(function(c){if(!c)throw Error("Request signature is not valid");b&&f.keyStore.setRequest(b,a);return a})},updateCRL:function(a,b,f){var c=this,e=c.keyStore,d={};return(new m.Promise(w)).then(function(){a=a||{};var g=
e.getCertificate(b);if(!g)throw Error("Issuer certificate not found");if(0>((g.tbsCertificate.extensions||{}).keyUsage||[]).indexOf("cRLSign"))throw Error("Issuer has not rights for CRL sign");var h=g.tbsCertificate.extensions&&g.tbsCertificate.extensions.keyUsage;if(h&&0>h.indexOf("cRLSign"))throw Error("Issuer key can't be used for sign CRL");if(a.issuer&&A(a.issuer,g.tbsCertificate.issue))throw Error("CRL prototype and authority certificate have different issuers");(h=e.getCRL(b))?d=h.tbsCertList:
(h=T(e.getAllCRLs,{issuer:g.tbsCertificate.issuer}))&&0<h.length?d=h[0].tbsCertList:(d.issuer=g.tbsCertificate.issuer,d.revokedCertificates=[]);d.version=1;d.signature=g.tbsCertificate.signature;a.thisUpdate?d.thisUpdate=a.thisUpdate:(d.thisUpdate=new Date,d.thisUpdate.setHours(0,0,0,0));a.nextUpdate?d.nextUpdate=a.nextUpdate:(d.nextUpdate=new Date(d.thisUpdate),d.nextUpdate.setFullYear(d.nextUpdate.getFullYear()+25));h=g.tbsCertificate.validity;if(!h||h.notBefore.getTime()>d.thisUpdate.getTime())throw Error("Issuer certificate is not released");
if(!h||h.notAfter.getTime()<d.thisUpdate.getTime())throw Error("Issuer certificate expired");h=d.revokedCertificates;if(a.revokedCertificates)for(var k=0,l=a.revokedCertificates.length;k<l;k++){var m=a.revokedCertificates[k],p={};if(!m.userCertificate)throw Error("Serail number of revoked certificate not found");p.userCertificate=m.userCertificate;m.revocationDate?p.revocationDate=m.revocationDate:(p.revocationDate=new Date,p.revocationDate.setHours(0,0,0,0));m=m.crlEntryExtensions||{};m.cRLReason=
m.cRLReason||"unspecified";p.crlEntryExtensions=m;h.push(p)}h=a.crlExtensions||{};h.authorityKeyIdentifier={keyIdentifier:(g.tbsCertificate.extensions||{}).subjectKeyIdentifier||"0",authorityCertIssuer:[{directoryName:g.tbsCertificate.issuer}],authorityCertSerialNumber:g.tbsCertificate.serialNumber};h.cRLNumber=h.cRLNumber||0;d.crlExtensions=h;return D(c,b,f)}).then(function(a){d.buffer=n("TBSCertList").encode(d);return l().sign(d.signature,a,d.buffer)}).then(function(a){a={tbsCertList:d,signatureAlgorithm:d.signature,
signatureValue:a};a.buffer=n("CertificateList").encode(a);e.setCRL(b,a);return n("CertificateList").encode(a,c.format)})},exportCRL:function(a,b){var f=this;return(new m.Promise(w)).then(function(){var c=[f.keyStore.getCRL(a)];if(!c)throw Error("CRL not found");switch((b||"x509").toLowerCase()){case "p7c":return n("ContentInfo").encode({contentType:"signedData",content:{version:4,digestAlgorithms:[],encapContentInfo:{eContentType:"data"},crls:[{crl:c}],signerInfos:[]}},f.format);case "p12":return n("PFX").encode({version:3,
authSafe:{contentType:"data",content:n("SafeContents").encode([{bagId:"crlBag",crltValue:{crlId:"x509CRL",crltValue:c},bagAttributes:"string"===typeof a?{friendlyName:a}:void 0}])}},f.format);default:return n("CertificateList").encode(c,f.format)}})},importCRL:function(a,b){var f=this.keyStore,c,e;return(new m.Promise(w)).then(function(){try{a=u(a,"ContentInfo")}catch(b){a=u(a,"CertificateList")}if(a.contentType&&("signedData"===a.contentType&&(a=a.content.crls[0]),!a))throw Error("Invalid format");
c=a.tbsCertList;if(!c)throw Error("Invalid format");var g=B(f,{issuer:c.issuer});if(g&&0<g.length)e=g[0];else throw Error("Issuer certificate not found");return M(e,a.signatureAlgorithm,a.signatureValue,c.buffer)}).then(function(c){if(!c)throw Error("Certification list has invalid signature");b&&f.setCRL(b,a);return a})},signData:function(a,b,f,c){var e=this,d=e.keyStore,g,h,k;b=b||[];b instanceof Array||(b=[b]);b=b.map(function(a){return(a||"").toLowerCase()});return(new m.Promise(w)).then(function(){try{a=
u(a,"ContentInfo")}catch(c){a={contentType:"data",content:G(a)}}var m=d.getCertificate(f);if(!m)throw Error("Signer certificate not found");h={version:1,digestAlgorithm:e.provider.digest,sid:{issuerAndSerialNumber:{issuer:m.tbsCertificate.issuer,serialNumber:m.tbsCertificate.serialNumber}}};if("signedData"===a.contentType){g=a;k=a.encapContentInfo.eContent;g.signerInfos=(g.signerInfos||[]).push(h);var p;g.digestAlgorithms=g.digestAlgorithms||[];g.digestAlgorithms.forEach(function(a){a.id===g.digestAlgorithm.id&&
(p=!0)});p||g.digestAlgorithms.push(g.digestAlgorithm);0<=b.indexOf("detached")&&(a.encapContentInfo.eContent=void 0)}else k=a.content.buffer||a.content,g={version:1,digestAlgorithms:[h.digestAlgorithm],encapContentInfo:{eContentType:a.contentType,eContent:0<=b.indexOf("detached")?void 0:k},signerInfos:[h]};if(0<=b.indexOf("certpath")){g.certificates=g.certificates||[];var n=g.certificates.map(function(a){return a.certificate});X(d,f).forEach(function(a){0===K(n,{issuer:a.tbsCertificate.issuer,serialNumber:a.tbsCertificate.serialNumber}).length&&
g.certificates.push({certificate:a})})}if(0<=b.indexOf("attrs"))return l().digest(h.digestAlgorithm,k)}).then(function(a){a&&(h.signedAttrs={contentType:g.encapContentInfo.eContentType,messageDigest:a,signingTime:new Date},k=h.signedAttrs.buffer=n("SignedAttributes").encode(h.signedAttrs));return D(e,f,c)}).then(function(a){h.signatureAlgorithm=e.provider.generation;var b=q(h.signatureAlgorithm,{hash:h.digestAlgorithm});return l().sign(b,a,k)}).then(function(a){h.signatureValue=a;return n("ContentInfo").encode({contentType:"signedData",
content:g},e.format)})},encryptData:function(a,b,f,c,e){var d=this,g=d.keyStore,h,k,r,u,p,J,v,s,z,A,y;return(new m.Promise(w)).then(function(){a=G(a);b=(b||"keyagree").toLowerCase();if("keyagree"!==b&&"keytrans"!==b&&"kek"!==b&&"pbkek"!==b&&"keyman"!==b&&"pbes"!==b)throw Error("Invalid envelop mode");switch(b){case "keyagree":case "keytrans":r=f instanceof Array?f:[f];r=r.map(function(a){return g.getCertificate(a)});break;case "kek":case "keyman":e=c;c=f;if(!c||"string"!==typeof c)throw Error("Alias of secret key must be specified as 4th parameter");
r=[f];break;case "pbkek":case "pbes":e=f;if(!e||"string"!==typeof e)throw Error("Password must be specified as 4th parameter");r=[f]}z=r.map(function(a,b){return C(8)});y="pbes"!==b&&"keyman"!==b;if("pbes"===b)return E.subtle.importKey("raw",t.Chars.decode(e,"utf8"),d.provider.derivation,!0,["deriveKey"])}).then(function(a){h=q(d.provider.encryption);switch(b){case "keyman":return D(d,c,e);case "pbes":return l().deriveKey(q(d.provider.derivation,{salt:z[0]}),a,h,!0,["encrypt"]);default:return l().generateKey(h,
!0,["encrypt"])}}).then(function(b){u=b;h.iv||(h.iv=C(8));return l().encrypt(h,u,a)}).then(function(a){p={contentType:"data",contentEncryptionAlgorithm:h,encryptedContent:a};switch(b){case "keyagree":case "keytrans":return Promise.all(r.map(function(a){return L(a)}));case "pbes":a=q(d.provider.pbes,{derivation:q(d.provider.derivation,{salt:z[0]}),encryption:h}),p.contentEncryptionAlgorithm=a}}).then(function(a){switch(b){case "keyagree":case "keytrans":v=a;case "kek":return c?D(d,c,e):l().generateKey(d.provider.generation,
!0,["deriveKey"]);case "pbkek":return E.subtle.importKey("raw",t.Chars.decode(e,"utf8"),d.provider.derivation,!0,["deriveKey"])}}).then(function(a){if(y){J=a.privateKey||a;var d=c&&g.getCertificate(c);switch(b){case "keyagree":return c?d.tbsCertificate.subjectPublicKeyInfo:l().exportKey("spki",a.publicKey);case "keytrans":return c?L(d):a.publicKey}d&&d.tbsCertificate&&d.tbsCertificate.extensions&&(A=d.tbsCertificate.extensions.subjectKeyIdentifier)}}).then(function(a){if(y)return s=a,k="keytrans"===
b&&d.provider.transwrapping||d.provider.wrapping,Promise.all(r.map(function(a,c){var e;switch(b){case "kek":return J;case "pbkek":e=q(d.provider.derivation,{salt:z[c]});break;default:e=q(d.provider.agreement,{"public":v[c],ukm:z[c]})}return l().deriveKey(e,J,k,!0,["wrapKey"])}))}).then(function(a){if(y)return Promise.all(r.map(function(b,c){return l().wrapKey("raw",u,a[c],q(k,{ukm:z[c]}))}))}).then(function(a){if(y){var e=r.map(function(e,f){var g=r[f].tbsCertificate,g=g?{issuerAndSerialNumber:{issuer:g.issuer,
serialNumber:g.serialNumber}}:void 0;switch(b){case "keyagree":var h=n("SubjectPublicKeyInfo").decode(s),l=q(h.algorithm,d.provider.agreement,{wrapping:q(k)});return{kari:{version:3,originator:{originatorKey:{algorithm:h.algorithm,publicKey:h.subjectPublicKey}},ukm:z[f],keyEncryptionAlgorithm:l,recipientEncryptedKeys:[{rid:g,encryptedKey:a[f]}]}};case "keytrans":return l=q(s.algorithm,{ukm:z[f],"public":s,wrapping:q(k)}),{ktri:{version:0,rid:g,keyEncryptionAlgorithm:l,encryptedKey:a[f]}};case "kek":return{kekri:{version:4,
kekid:{keyIdentifier:A||(t||(t=m.gostCoding)).BER.encode(c)},keyEncryptionAlgorithm:q(k,{ukm:z[f]}),encryptedKey:a[f]}};case "pbkek":return{pwri:{version:0,keyDerivationAlgorithm:q(d.provider.derivation,{salt:z[f]}),keyEncryptionAlgorithm:q(k,{ukm:z[f]}),encryptedKey:a[f]}}}}),e={version:b=3,recipientInfos:e,encryptedContentInfo:p};return n("ContentInfo").encode({contentType:"envelopedData",content:e},d.format)}return n("ContentInfo").encode({contentType:"encryptedData",content:{version:0,encryptedContentInfo:p}},
d.format)})},verifyData:function(a,b){var f=this,c=f.keyStore,e,d,g;return(new m.Promise(w)).then(function(){var h=u(a,"ContentInfo");if("signedData"!==h.contentType)throw Error("Invalid signed data format");e=h.content;b&&(b=G(b));d=(g=e.encapContentInfo)&&g.eContent&&g.eContent||b;return Promise.all(e.signerInfos.map(function(a){a=a.sid.issuerAndSerialNumber;a={issuer:a.issuer,serialNumber:a.serialNumber};var b=B(c,a);if(0<b.length)return b;var d=(e.certificates||[]).map(function(a){return a.certificate}),
b=K(d,a);if(0===b.length)throw Error("Certificate for verification not found");return f.validateCertificate(b.concat(d))}))}).then(function(a){return Promise.all(e.signerInfos.map(function(b,c){var e=d;if(b.signedAttrs){if(!b.signedAttrs.messageDigest)throw Error("Message digest must present in signed attributes");e=n("SignedAttributes").encode(b.signedAttrs)}if(!e)throw Error("Data for verification not found");var f=q(b.signatureAlgorithm,{hash:b.digestAlgorithm});return M(a[c][0],f,b.signatureValue,
e)}))}).then(function(a){for(var b=0,c=a.length;b<c;b++)if(!0!==a[b])throw Error("Signature not verified");return Promise.all(e.signerInfos.map(function(a){return a.signedAttrs&&d?l().digest(a.digestAlgorithm,d):!1}))}).then(function(a){e.signerInfos.forEach(function(b,c){if(b.signedAttrs&&d&&0!==R(a[c],b.signedAttrs.messageDigest))throw Error("Data digest not verified");});return{contentType:g&&g.eContentType||"data",content:d}})},decryptData:function(a,b,f){var c=this,e=c.keyStore,d,g,h,k,r,s,p;
return(new m.Promise(w)).then(function(){var h=u(a,"ContentInfo");if("envelopedData"!==h.contentType&&"encryptedData"!==h.contentType)throw Error("Invalid enveloped or encrypted data format");d=h.content;var l=function(a){a:{for(var d=c.keyStore,e=d.aliases(),f=0,g=e.length;f<g;f++){var h=e[f];if(S(d.getCertificate(h),a)){a=h;break a}}a=void 0}if(b&&b===a)return!0;a&&n.push(a)};p=d.encryptedContentInfo.contentEncryptionAlgorithm;if("envelopedData"===h.contentType){for(var h=d.recipientInfos,n=[],
s=0,w=h.length;s<w;s++){var y=h[s];if(y.ktri){g="keytrans";var x=y.ktri.rid;if(x&&x.issuerAndSerialNumber&&l({issuer:x.issuerAndSerialNumber.issuer,serialNumber:x.issuerAndSerialNumber.serialNumber})||x.subjectKeyIdentifier&&l({subjectKeyIdentifier:x.subjectKeyIdentifier}))k=y.ktri}else if(y.kari){g="keyagree";for(var A=y.kari.recipientEncryptedKeys,C=0,F=A.length;C<F;C++)if((x=A[s].rid)&&x.issuerAndSerialNumber&&l({issuer:x.issuerAndSerialNumber.issuer,serialNumber:x.issuerAndSerialNumber.serialNumber})||
x.subjectKeyIdentifier&&l({subjectKeyIdentifier:x.subjectKeyIdentifier})){k={originator:y.kari.originator,keyEncryptionAlgorithm:y.kari.keyEncryptionAlgorithm,ukm:y.kari.ukm,encryptedKey:A[s].encryptedKey};break}}else if(y.kekri){g="kek";x=y.kekri.kekid.keyIdentifier;try{var B=(t||(t=m.gostCoding)).BER.decode(x);B instanceof String&&e.containsAlias(B)&&(b===B.toString()?k=y.kekri:n.push(B))}catch(G){l({subjectKeyIdentifier:x})&&(k=y.kekri)}}else if(y.pwri){g="pbkek";f=b;if(!f||"string"!==typeof f)throw Error("Password required");
k=y.pwri}if(k)break}if(!k){if(0<n.length)throw Error("Recipient key required ["+n.join(",")+"]");throw Error("No recipient found in store");}}else if("PBES2"===p.id||"id-sc-pbeWithGost3411AndGost28147"===p.id||"id-sc-pbeWithGost3411AndGost28147CFB"===p.id){if(g="pbes",f=b,!f||"string"!==typeof f)throw Error("Password required");}else if(g="keyman",!b)throw Error("Secret key alias required");switch(g){case "keytrans":case "keyagree":case "kek":case "keyman":return D(c,b,f);case "pbkek":r=q(c.provider.derivation,
{salt:k.keyDerivationAlgorithm.salt,iterations:k.keyDerivationAlgorithm.iterations,hmac:k.keyDerivationAlgorithm.hmac});break;case "pbes":l=p,r=q(c.provider.derivation,{salt:l.derivation.salt,iterations:l.derivation.iterations,hmac:l.derivation.hmac}),p=l.encryption}return E.subtle.importKey("raw",t.Chars.decode(f,"utf8"),r,!0,["deriveKey"])}).then(function(a){h=a;switch(g){case "keyagree":a=k.originator;if(a.originatorKey){var b=n("SubjectPublicKeyInfo").encode({algorithm:a.originatorKey.algorithm,
subjectPublicKey:a.originatorKey.publicKey});return l().importKey("spki",b,a.originatorKey.algorithm,!0,["verify","deriveKey"])}if((a=B(e,a.issuerAndSerialNumber?{issuer:a.issuerAndSerialNumber.issuer,serialNumber:a.issuerAndSerialNumber.serialNumber}:{subjectKeyIdentifier:a.subjectKeyIdentifier}))&&0<a.length)return L(a[0]);throw Error("Originator certificate not found in key stores");}}).then(function(a){switch(g){case "keytrans":r=q(c.provider.agreement,{ukm:k.keyEncryptionAlgorithm.ukm,public:k.keyEncryptionAlgorithm.public,
sBox:k.keyEncryptionAlgorithm.sBox});s=q(c.provider.transwrapping||c.provider.wrapping,k.keyEncryptionAlgorithm.wrapping,{ukm:k.keyEncryptionAlgorithm.ukm});break;case "keyagree":r=q(k.keyEncryptionAlgorithm,{ukm:k.ukm,public:a});s=q(k.keyEncryptionAlgorithm.wrapping||c.provider.wrapping,{ukm:k.ukm});break;case "kek":return s=q(k.keyEncryptionAlgorithm),h;case "keyman":return h;case "pbkek":s=q(k.keyEncryptionAlgorithm);break;case "pbes":s=p}return l().deriveKey(r,h,s,!0,["unwrapKey","decrypt"])}).then(function(a){switch(g){case "pbes":case "keyman":return a;
default:return l().unwrapKey("raw",k.encryptedKey,a,s,p,!0,["decrypt"])}}).then(function(a){return l().decrypt(p,a,d.encryptedContentInfo.encryptedContent)}).then(function(a){return{contentType:d.encryptedContentInfo.contentType,content:a}})},extractData:function(a,b,f){var c=this;return(new m.Promise(w)).then(function(){var e=u(a,"ContentInfo");switch(e.contentType){case "data":return e.content;case "signedData":return c.verifyData(a);case "encryptedData":case "envelopedData":return c.decryptData(a,
b,f);default:throw Error("Data format not supported");}})}};return W});
