/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(p,z){"function"===typeof define&&define.amd?define(["gostObject","gostCoding","gostSyntax","gostCrypto"],z):"object"===typeof exports?module.exports=z(require("gostObject"),require("gostCoding"),require("gostSyntax"),require("gostCrypto")):p.GostPKIX=z(p.gostObject,p.gostCoding,p.gostSyntax,p.gostCrypto)})(this,function(p,z,V,G){function L(){return(z||(z=r.gostCoding)).PEM}function H(){return(z||(z=r.gostCoding)).Chars}function l(a){return(V||(V=r.gostSyntax))[a]}function m(){return(G||
(G=r.gostCrypto)).subtle}function u(a){try{a()}catch(b){}}function v(a,b){return"string"===typeof a||a instanceof String||a instanceof ArrayBuffer?l(b).decode(a):a}function E(a){if("string"===typeof a||a instanceof String)a=L().decode(a);if(!(a instanceof ArrayBuffer))throw Error("Type of data must be FormatedData");return a}function C(a){a=new Uint8Array(a);(G||(G=r.gostCrypto)).getRandomValues(a);return a.buffer}function M(a){return a?a.replace(/[\u0000-\u0004]/g,""):a}function w(a,b){for(var e in a)if("buffer"!==
e&&("undefined"===typeof b[e]||M(a[e])!==M(b[e])))return!1;for(e in b)if("buffer"!==e&&("undefined"===typeof a[e]||M(a[e])!==M(b[e])))return!1;return!0}function W(a){return"number"===typeof a||a instanceof Number?a:(z||(z=r.gostCoding)).Int16.encode(a)}function Q(a){var b=typeof a;if("undefined"===b||""===a)return"0";a="number"===b||a instanceof Number?a.toString(16):a.replace("0x","");return a.toLowerCase()}function R(a,b){a=Q(a);b=Q(b);var e=Math.max(a.length,b.length),c=a;a=(Array(e+1).join("0")+
c).slice(-e);c=b;b=(Array(e+1).join("0")+c).slice(-e);return a>b?1:a<b?-1:0}function S(a,b){var e=new Uint8Array(a),c=new Uint8Array(b);if(e.length>c.length)return 1;if(e.length<c.length)return-1;for(var d=0,f=e.length;d<f;d++){if(e[d]>c[d])return 1;if(e[d]<c[d])return-1}return 0}function X(a,b){return a&&b&&(!b.issuer||w(a.tbsCertificate.issuer,b.issuer))&&(!b.serialNumber||0===R(a.tbsCertificate.serialNumber,b.serialNumber))&&(!b.subjectKeyIdentifier||0===S(a.tbsCertificate.extensions.subjectKeyIdentifier,
b.subjectKeyIdentifier))&&(!b.subject||w(a.tbsCertificate.subject,b.subject))&&(!b.date||a.tbsCertificate.validity.notBefore.getTime()<b.date.getTime()&&a.tbsCertificate.validity.notAfter.getTime()>b.date.getTime())}function N(a,b){for(var e=[],c=0,d=a.length;c<d;c++)X(a[c],b)&&e.push(a[c]);return e}function I(a,b){return N(a.getAllCertificates(),b)}function Y(a,b){for(var e=[],c=0,d=a.length;c<d;c++){var f=a[c],g=b;g.issuer&&!w(f.tbsCertList.issuer,g.issuer)||g.date&&!(f.tbsCertList.thisUpdate.getTime()<
g.date.getTime())||e.push(a[c])}return e}function Z(a,b,e,c){for(var d=[];a;){d.push(a);var f={subject:a.tbsCertificate.issuer,date:c};if(a.tbsCertificate.extensions&&a.tbsCertificate.extensions.authorityKeyIdentifier){var g=a.tbsCertificate.extensions.authorityKeyIdentifier;f.subjectKeyIdentifier=g.keyIdentifier;g.authorityCertIssuer&&g.authorityCertIssuer[0].directoryName&&(f.issuer=g.authorityCertIssuer[0].directoryName);g.authorityCertSerialNumber&&(f.serialNumber=W(g.authorityCertSerialNumber))}if(w(a.tbsCertificate.subject,
a.tbsCertificate.issuer))a=!1;else if((a=N(b,f))&&0<a.length){a=a[0];if(f=e)a:{for(var g=a,f=e,f=Y(f,{issuer:g.tbsCertificate.issuer,date:void 0}),g=g.tbsCertificate.serialNumber,h=0,k=f.length;h<k;h++)for(var s=f[h],x=0,q=s.tbsCertList.revokedCertificates.length;x<q;x++)if(0===R(s.tbsCertList.revokedCertificates[x].userCertificate,g)){f=!0;break a}f=!1}f&&(a=!1)}else a=!1}return d}function ba(a,b){var e=a.getCertificate(b);return e?Z(e,a.getAllCertificates(),a.getAllCRLs()):[]}function n(){for(var a=
{},b=0,e=arguments.length;b<e;b++){var c=arguments[b];if("object"===typeof c)for(var d in c)a[d]=c[d]}return a}function O(a){a=v(a,"Certificate");a=a.tbsCertificate.subjectPublicKeyInfo;var b="rsaEncryption"===a.algorithm.id?["verify"]:["verify","deriveKey","deriveBits"];return m().importKey("spki",a.buffer,a.algorithm,!0,b)}function P(a,b,e,c){return O(a).then(function(a){return m().verify(b,a,e,c)})}function F(a,b,e){var c,d,f,g;return(new r.Promise(u)).then(function(){var d=a.keyStore.getKey(b);
if(!d)throw Error("Private key not found");if(d.encryptionAlgorithm){c=d.encryptedData;g=d.encryptionAlgorithm;if("PBES2"===g.id||"id-sc-pbeWithGost3411AndGost28147"===g.id||"id-sc-pbeWithGost3411AndGost28147CFB"===g.id){if(!e||!("string"===typeof e||e instanceof String))throw Error("Password required to decrypt key");f=g.derivation;g=g.encryption;return m().importKey("raw",H().decode(e,"utf8"),f,!1,["deriveKey"])}if(!e||"secret"!==e.type)throw Error("Secret key required to decrypt key");}else c=
d instanceof ArrayBuffer?d:l("PrivateKeyInfo").encode(d)}).then(function(a){return f?m().deriveKey(f,a,g,!0,["decrypt"]):e}).then(function(a){return g?m().decrypt(g,a,c):c}).then(function(b){try{d=l("PrivateKeyInfo").decode(b)}catch(e){d=b}if(d.privateKeyAlgorithm){var c="rsaEncryption"===d.privateKeyAlgorithm.id?["sign"]:["sign","deriveKey","deriveBits"];return m().importKey("pkcs8",b,d.privateKeyAlgorithm,!0,c)}c=["encrypt","decrypt","wrapKey","unwrapKey"];return m().importKey("raw",b,a.provider.encryption,
!0,c)})}function K(a,b,e,c){var d,f,g,h,k=b.type;return(new r.Promise(u)).then(function(){return"secret"===k?m().exportKey("raw",b):m().exportKey("pkcs8",b)}).then(function(b){d=b;if(c){if("string"===typeof c||c instanceof String)return g=n(a.provider.pbes.derivation,{salt:C(32),iterations:1}),h=n(a.provider.pbes.encryption),h.iv||(h.iv=C(8)),m().importKey("raw",H().decode(c,"utf8"),g,!1,["deriveKey"]);if("secret"===c.type)h=n(a.provider.encryption),h.iv||(h.iv=C(8));else throw Error("Password must be string or secret key type");
}else f="secret"===k?d:l("PrivateKeyInfo").decode(d)}).then(function(a){return g?m().deriveKey(g,a,h,!0,["encrypt"]):c}).then(function(a){return h&&m().encrypt(h,a,d)}).then(function(b){h&&(f=g?{encryptionAlgorithm:n(a.provider.pbes,{derivation:g,encryption:h}),encryptedData:b}:{encryptionAlgorithm:h,encryptedData:b});e&&a.keyStore.setKey(e,f);return f})}function J(a){a=v(a,"Certificate");a=a.tbsCertificate.subjectPublicKeyInfo.algorithm.id;var b=(p||(p=r.gostObject)).providers,e;for(e in b){var c=
b[e];if(c.generation.id===a)return c}}function T(a){this.entries={};if(a){var b=JSON.parse(a.getItem("gostCrypto.keyStore")||"{}"),e;for(e in b){var c=this.entries[e]={},d=b[e];d.crl&&(c.crl=l("CertificateList").decode(d.crl));d.request&&(c.request=l("CertificationRequest").decode(d.request));d.cert&&(c.cert=l("Certificate").decode(d.cert));if(d.key)try{c.key=l("PrivateKeyInfo").decode(d.key)}catch(f){try{c.key=l("EncryptedPrivateKeyInfo").decode(d.key)}catch(g){c.key=L().decode(d.key,"KEY")}}}this.save=
function(){var b={},d;for(d in this.entries){var e=b[d]={},c=this.entries[d];c.crl&&(e.crl=l("CertificateList").encode(c.crl,"PEM"));c.request&&(e.request=l("CertificationRequest").encode(c.request,"PEM"));c.cert&&(e.cert=l("Certificate").encode(c.cert,"PEM"));if(c.key)try{e.key=l("PrivateKeyInfo").encode(c.key,"PEM")}catch(f){try{e.key=l("EncryptedPrivateKeyInfo").encode(c.key,"PEM")}catch(g){e.key=L().encode(c.key,"KEY")}}}a.setItem("gostCrypto.keyStore",JSON.stringify(b))}}}function $(a,b,e){this.provider=
(p||(p=r.gostObject)).providers[a];this.format=(b||"DER").toUpperCase();this.keyStore=e?e.getItem&&e.setItem?new T(e):e:new T}var r=this;T.prototype={aliases:function(){var a=[],b;for(b in this.entries)a.push(b);return a},containsAlias:function(a){return a in this.entries},deleteEntry:function(a){delete this.entries[a];this.save&&this.save()},getCertificate:function(a){if(a=this.entries[a])return a.cert},getCRL:function(a){if(a=this.entries[a])return a.crl},getRequest:function(a){if(a=this.entries[a])return a.request},
getKey:function(a){if(a=this.entries[a])return a.key},setCertificate:function(a,b){(this.entries[a]||(this.entries[a]={})).cert=v(b,"Certificate");this.save&&this.save()},setCRL:function(a,b){(this.entries[a]||(this.entries[a]={})).crl=v(b,"CertificateList");this.save&&this.save()},setRequest:function(a,b){(this.entries[a]||(this.entries[a]={})).request=v(b,"CertificationRequest");this.save&&this.save()},setKey:function(a,b){try{b=v(b,"PrivateKeyInfo")}catch(e){try{b=v(b,"EncryptedPrivateKeyInfo")}catch(c){b=
E(b)}}(this.entries[a]||(this.entries[a]={})).key=b;this.save&&this.save()},getAllCertificates:function(){var a=[],b;for(b in this.entries){var e=this.entries[b];e.cert&&a.push(e.cert)}return a},getAllCRLs:function(){var a=[],b;for(b in this.entries){var e=this.entries[b];e.crl&&a.push(e.crl)}return a}};$.prototype={importKeyStore:function(a,b){var e=this,c=e.keyStore,d,f,g,h,k;return(new r.Promise(u)).then(function(){a=v(a,"PFX");h=a.authSafe;if(b&&!a.macData)throw Error("Password based MAC must present");
if("signedData"!==h.contentType&&"data"!==h.contentType)throw Error("Unsupported format");if(b)return d=n(e.provider.pbmac.derivation,{salt:a.macData.macSalt,iterations:a.macData.iterations}),f=n(e.provider.pbmac.hmac),m().importKey("raw",H().decode(b,"utf8"),d,!1,["deriveKey"])}).then(function(a){return d&&m().deriveKey(d,a,f,!0,["verify"])}).then(function(b){g=b;return f&&m().verify(f,g,a.macData.mac.digest,h.buffer)}).then(function(a){if(!a)throw Error("MAC not verified");return"signedData"===
h.contentType?e.verifyData(h):h}).then(function(a){h=a;if("data"!==h.contentType)throw Error("Unsupported format");k=l("AuthenticatedSafe").decode(h.content);return Promise.all(k.map(function(a){if("encryptedData"===a.contentType)return e.decryptData(a,b);if("data"===a.contentType)return a;throw Error("Format not supported");}))}).then(function(b){k=b;var d=function(a){a.forEach(function(a){var b=a.bagAttributes&&a.bagAttributes.friendlyName||L().encode(C(12));switch(a.bagId){case "keyBag":case "pkcs8ShroudedKeyBag":c.setKey(b,
a.bagValue);break;case "certBag":"x509Certificate"===a.bagValue.certId&&c.setCertificate(b,a.bagValue.certValue);break;case "crlBag":"x509CRL"===a.bagValue.crlId&&c.setCRL(b,a.bagValue.crlValue);break;case "safeContentsBag":d(a.bagValue)}})};k.forEach(function(a){d(l("SafeContents").decode(a.content))});return a})},exportKeyStore:function(a,b){var e=this,c=e.keyStore,d,f,g,h,k;return(new r.Promise(u)).then(function(){for(var f=c.aliases(),k=[],q=0,ca=f.length;q<ca;q++){var B=f[q],A=c.getKey(B),r;
A&&(A.privateKeyAlgorithm?r={bagId:"keyBag",bagValue:v(A,"PrivateKeyInfo")}:A.encryptionAlgorithm&&(r={bagId:"pkcs8ShroudedKeyBag",bagValue:A}),r.bagAttributes={localKeyId:q.toString(16),friendlyName:B},k.push(r));(A=c.getCertificate(B))&&k.push({bagId:"certBag",bagValue:{certId:"x509Certificate",certValue:A},bagAttributes:{friendlyName:B}});(A=c.getCRL(B))&&k.push({bagId:"crlBag",bagValue:{crlId:"x509CRL",crlValue:A},bagAttributes:{friendlyName:B}})}d=l("SafeContents").encode(k);b=(b||"mac").toLowerCase();
if(a)return g=n(e.provider.pbmac.derivation,{salt:C(32),iterations:1}),h=n(e.provider.pbmac.hmac),m().importKey("raw",H().decode(a,"utf8"),g,!1,["deriveKey"]);if("encrypt"===b)throw Error("Password required for MAC calculation");}).then(function(a){return g&&m().deriveKey(g,a,h,!0,["sign"])}).then(function(c){k=c;return"encrypt"===b?e.encryptData(d,"pbes",a):{contentType:"data",content:d}}).then(function(a){a=v(a,"ContentInfo");f={contentType:"data",content:l("AuthenticatedSafe").encode([a])};f.buffer=
l("ContentInfo").encode(f);return h&&m().sign(h,k,f.buffer)}).then(function(a){var b={version:3,authSafe:f};a&&(b.macData={mac:{digestAlgorithm:h.hash,digest:a},macSalt:g.salt,iterations:g.iterations});return l("PFX").encode(b,e.format)})},exportKey:function(a,b,e){var c=this;return(new r.Promise(u)).then(function(){return F(c,a,e)}).then(function(a){b=(b||"p8").toLowerCase();switch(b){case "p8":return K(c,a);case "p8e":if(!e)throw Error("Password required for export to encrypted format");return K(c,
a,void 0,e);case "p12":throw Error("Not yet implemented");}}).then(function(a){switch(b){case "p8":return l("PrivateKeyInfo").encode(a,c.format);case "p8e":return l("EncryptedPrivateKeyInfo").encode(a,c.format)}})},importKey:function(a,b,e){var c=this;return(new r.Promise(u)).then(function(){try{a=v(a,"PrivateKeyInfo")}catch(d){try{a=v(a,"EncryptedPrivateKeyInfo")}catch(f){a=E(a)}}c.keyStore.setKey(b,a);if(!a.encryptionAlgorithm&&e)return F(c,b)}).then(function(d){return d?K(c,d,b,e):a})},createCertificate:function(a,
b,e){var c=this,d={},f={},g,h;return(new r.Promise(u)).then(function(){a=a||{};d.version=2;f.signatureAlgorithm=d.signature=a.signature||c.provider.signature;if(!d.signature)throw Error("Signature Algorithm not defined");var b=c.provider.generation;if(!b)throw Error("Key Algorithm not defined");return m().generateKey(b,!0,["sign","verify"])}).then(function(a){g=a.publicKey;h=a.privateKey;return m().exportKey("spki",g)}).then(function(a){d.subjectPublicKeyInfo=l("SubjectPublicKeyInfo").decode(a);return m().digest(c.provider.digest,
a)}).then(function(b){b=(new Uint8Array(new Uint8Array(b,0,20))).buffer;d.subject=a.subject||a.issure;d.issuer=d.subject;if(!d.subject)throw Error("Subject or issuer not defined");d.serialNumber=a.serialNumber||1;var c={};a.validity&&a.validity.notBefore?c.notBefore=a.validity.notBefore:(c.notBefore=new Date,c.notBefore.setHours(0,0,0,0));a.validity&&a.validity.notAfter?c.notAfter=a.validity.notAfter:(c.notAfter=new Date(c.notBefore),c.notAfter.setFullYear(c.notAfter.getFullYear()+25));d.validity=
c;c=a.extensions||{};c.keyUsage=c.keyUsage||"digitalSignature nonRepudiation keyEncipherment dataEncipherment keyAgreement keyCertSign cRLSign".split(" ");c.basicConstraints=c.basicConstraints||{cA:!0};c.extKeyUsage=c.extKeyUsage||"serverAuth clientAuth codeSigning emailProtection ipsecEndSystem ipsecTunnel ipsecUser timeStamping OCSPSigning".split(" ");c.subjectKeyIdentifier=b;c.authorityKeyIdentifier={keyIdentifier:b,authorityCertIssuer:[{directoryName:d.issuer}],authorityCertSerialNumber:d.serialNumber};
d.extensions=c;d.buffer=l("TBSCertificate").encode(d);return m().sign(f.signatureAlgorithm,h,d.buffer)}).then(function(a){f.tbsCertificate=d;f.signatureValue=a;f.buffer=l("Certificate").encode(f);return K(c,h,b,e)}).then(function(){c.keyStore.setCertificate(b,f);return l("Certificate").encode(f,c.format)})},issueCertificate:function(a,b,e,c){var d=this,f=d.keyStore,g,h={},k={},s,x,q;return(new r.Promise(u)).then(function(){x=f.getRequest(b);s=x.requestInfo;h.version=2;h.subjectPublicKeyInfo=s.subjectPublicKeyInfo;
return m().importKey("spki",s.subjectPublicKeyInfo.buffer,s.subjectPublicKeyInfo.algorithm,!0,["verify"])}).then(function(a){return m().verify(x.signatureAlgorithm,a,x.signatureValue,s.buffer)}).then(function(b){if(!b)throw Error("Request signature is not valid");q=f.getCertificate(e);if(!q)throw Error("Authority certificate not found");g=J(q)||d.provider;k.signatureAlgorithm=h.signature=a.signature||g.signature;if(!h.signature)throw Error("Signature Algorithm not defined");return m().digest(g.digest,
h.subjectPublicKeyInfo.buffer)}).then(function(b){b=(new Uint8Array(new Uint8Array(b,0,20))).buffer;h.subject=s.subject;if(!h.subject)throw Error("Subject not defined");var k=q.tbsCertificate.extensions&&q.tbsCertificate.extensions.keyUsage;if(k&&0>k.indexOf("keyCertSign"))throw Error("Issuer key can't be used for sign certificate");var g;a.validity&&a.validity.notBefore?g=a.validity.notBefore:(g=new Date,g.setHours(0,0,0,0));var l=q.tbsCertificate.validity;if(!l||l.notBefore.getTime()>g.getTime())throw Error("Issuer certificate is not released");
if(!l||l.notAfter.getTime()<g.getTime())throw Error("Issuer certificate expired");h.issuer=q.tbsCertificate.issuer;var k=q.tbsCertificate.serialNumber,m=(q.tbsCertificate.extensions||{}).subjectKeyIdentifier,x=(q.tbsCertificate.extensions||{}).basicConstraints,x=(x=x&&x.pathLenConstraint)?x+1:0,r=q.tbsCertificate.issuer;if(a.serialNumber)h.serialNumber=a.serialNumber;else{for(var y=I(f,{issuer:h.issuer}),n=1,u=0,v=y.length;u<v;u++)if(0<=R(y[u].tbsCertificate.serialNumber,n)){for(var n=y[u].tbsCertificate.serialNumber,
n=Q(n),D="",z=1,U=n.length-1;0<=U;--U){var p=n.charCodeAt(U);1===z&&(102===p?p=48:(z=0,57===p?p=97:p++));D=String.fromCharCode(p)+D}1===z&&(D="1"+D);n="0x"+D}h.serialNumber=n}y={};y.notBefore=g;y.notAfter=a.validity&&a.validity.notAfter?a.validity.notAfter:l.notAfter;h.validity=y;g=a.extensions||{};l=s.attributes&&(s.attributes.extensionRequest||s.attributes.msCertExtensions)||{};g.keyUsage=g.keyUsage||l.keyUsage||["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement"];
g.basicConstraints=g.basicConstraints||l.basicConstraints||{cA:0<=g.keyUsage.indexOf("keyCertSign"),pathLenConstraint:x};g.extKeyUsage=g.extKeyUsage||l.extKeyUsage||["clientAuth","emailProtection"];g.subjectKeyIdentifier=b;g.authorityKeyIdentifier={keyIdentifier:m,authorityCertIssuer:[{directoryName:r}],authorityCertSerialNumber:k};h.extensions=g;return F(d,e,c)}).then(function(a){h.buffer=l("TBSCertificate").encode(h);return m().sign(k.signatureAlgorithm,a,h.buffer)}).then(function(a){k.tbsCertificate=
h;k.signatureValue=a;k.buffer=l("Certificate").encode(k);return f.setCertificate(b,k)}).then(function(){return l("Certificate").encode(k,d.format)})},exportCertificate:function(a,b){var e=this;return(new r.Promise(u)).then(function(){var c=e.keyStore.getCertificate(a);if(!c)throw Error("Certificate not found");switch((b||"x509").toLowerCase()){case "p7c":return l("ContentInfo").encode({contentType:"signedData",content:{version:1,digestAlgorithms:[],encapContentInfo:{eContentType:"data"},certificates:[c],
signerInfos:[]}},e.format);case "p12":return l("PFX").encode({version:3,authSafe:{contentType:"data",content:l("SafeContents").encode([{bagId:"certBag",crltValue:{certId:"x509Certificate",certValue:c},bagAttributes:"string"===typeof a?{friendlyName:a}:void 0}])}},e.format);default:return l("Certificate").encode(c,e.format)}})},importCertificate:function(a,b){var e=this.keyStore,c;return(new r.Promise(u)).then(function(){try{a=v(a,"ContentInfo")}catch(b){a=v(a,"Certificate")}if(a.contentType&&("signedData"===
a.contentType&&(a=a.content.certificates[0]),!a))throw Error("Invalid format");c=a.tbsCertificate;if(!c)throw Error("Invalid format");var f;if(w(a.tbsCertificate.subject,a.tbsCertificate.issuer))f=a;else if(e){f={subject:a.tbsCertificate.issuer};if(a.tbsCertificate.extensions&&a.tbsCertificate.extensions.authorityKeyIdentifier){var g=a.tbsCertificate.extensions.authorityKeyIdentifier;f.subjectKeyIdentifier=g.keyIdentifier;g.authorityCertIssuer&&g.authorityCertIssuer[0].directoryName&&(f.issuer=g.authorityCertIssuer[0].directoryName);
g.authorityCertSerialNumber&&(f.serialNumber=W(g.authorityCertSerialNumber))}if((f=I(e,f))&&0<f.length)f=f[0];else throw Error("Issuer for certificate not found in store");}return P(f,a.signatureAlgorithm,a.signatureValue,c.buffer)}).then(function(c){if(!c)throw Error("Certificate has invalid signature");b&&e.setCertificate(b,a);return a})},validateCertificate:function(a,b){var e=this.keyStore,c=[];return(new r.Promise(u)).then(function(){var d=a;d instanceof Array||(d=[a]);d=d.map(function(a){return v(a,
"Certificate")});b=b||new Date;c=Z(d[0],d.concat(e.getAllCertificates()),e.getAllCRLs(),b);for(var f=!1,d=c.length-1;0<=d;--d)if(0<I(e,{issuer:c[d].tbsCertificate.issuer,serialNumber:c[d].tbsCertificate.serialNumber}).length){f=!0;break}if(!f)throw Error("There are not trusted certificates in validation path");for(var f=[],d=0,g=c.length;d<g;d++){var h=c[d],k=d+1;k===g&&w(h.tbsCertificate.issuer,h.tbsCertificate.subject)&&(k=d);k<g&&f.push(P(c[k],h.signatureAlgorithm,h.signatureValue,h.tbsCertificate.buffer))}return Promise.all(f)}).then(function(a){for(var b=
0,e=a.length;b<e;b++)if(!0!==a[b])throw Error("Certificate in path has invalid signature");return c})},createRequest:function(a,b,e){var c=this,d={},f={},g,h;return(new r.Promise(u)).then(function(){a=a||{};d.signatureAlgorithm=a.signatureAlgorithm||c.provider.signature;var b=c.provider.generation;if(!d.signatureAlgorithm)throw Error("Signature Algorithm not defined");if(!b)throw Error("Key Algorithm not defined");return m().generateKey(b,!0,["sign","verify"])}).then(function(a){g=a.publicKey;h=a.privateKey;
return m().exportKey("spki",g)}).then(function(b){f.subjectPublicKeyInfo=l("SubjectPublicKeyInfo").decode(b);f.subject=a.subject;if(!f.subject)throw Error("Subject not defined");f.version=0;b=a.extensions||{};b.keyUsage=b.keyUsage||["digitalSignature","nonRepudiation","dataEncipherment","keyAgreement"];b.extKeyUsage=["clientAuth","emailProtection"];f.attributes={extensionRequest:b};f.buffer=l("CertificationRequestInfo").encode(f);return m().sign(d.signatureAlgorithm,h,f.buffer)}).then(function(a){d.requestInfo=
f;d.signatureValue=a;d.buffer=l("CertificationRequest").encode(d);return K(c,h,b,e)}).then(function(){c.keyStore.setRequest(b,d);return l("CertificationRequest").encode(d,c.format)})},exportRequest:function(a){var b=this,e;return(new r.Promise(u)).then(function(){e=b.keyStore.getRequest(a);if(!e)throw Error("Certification request not found");return l("CertificationRequest").encode(e,b.format)})},importRequest:function(a,b){var e=this,c;return(new r.Promise(u)).then(function(){a=v(a,"CertificationRequest");
c=a.requestInfo;var b=c.subjectPublicKeyInfo;return m().importKey("spki",b.buffer,b.algorithm,!0,["verify"])}).then(function(b){return m().verify(a.signatureAlgorithm,b,a.signatureValue,c.buffer)}).then(function(c){if(!c)throw Error("Request signature is not valid");b&&e.keyStore.setRequest(b,a);return a})},updateCRL:function(a,b,e){var c=this,d=c.keyStore,f={},g;return(new r.Promise(u)).then(function(){a=a||{};var h=d.getCertificate(b);if(!h)throw Error("Issuer certificate not found");g=J(h)||c.provider;
if(0>((h.tbsCertificate.extensions||{}).keyUsage||[]).indexOf("cRLSign"))throw Error("Issuer has not rights for CRL sign");var k=h.tbsCertificate.extensions&&h.tbsCertificate.extensions.keyUsage;if(k&&0>k.indexOf("cRLSign"))throw Error("Issuer key can't be used for sign CRL");if(a.issuer&&w(a.issuer,h.tbsCertificate.issue))throw Error("CRL prototype and authority certificate have different issuers");(k=d.getCRL(b))?f=k.tbsCertList:(k=Y(d.getAllCRLs,{issuer:h.tbsCertificate.issuer}))&&0<k.length?f=
k[0].tbsCertList:(f.issuer=h.tbsCertificate.issuer,f.revokedCertificates=[]);f.version=1;f.signature=a.signature||g.signature;a.thisUpdate?f.thisUpdate=a.thisUpdate:(f.thisUpdate=new Date,f.thisUpdate.setHours(0,0,0,0));a.nextUpdate?f.nextUpdate=a.nextUpdate:(f.nextUpdate=new Date(f.thisUpdate),f.nextUpdate.setFullYear(f.nextUpdate.getFullYear()+25));k=h.tbsCertificate.validity;if(!k||k.notBefore.getTime()>f.thisUpdate.getTime())throw Error("Issuer certificate is not released");if(!k||k.notAfter.getTime()<
f.thisUpdate.getTime())throw Error("Issuer certificate expired");k=f.revokedCertificates;if(a.revokedCertificates)for(var l=0,m=a.revokedCertificates.length;l<m;l++){var q=a.revokedCertificates[l],n={};if(!q.userCertificate)throw Error("Serail number of revoked certificate not found");n.userCertificate=q.userCertificate;q.revocationDate?n.revocationDate=q.revocationDate:(n.revocationDate=new Date,n.revocationDate.setHours(0,0,0,0));q=q.crlEntryExtensions||{};q.cRLReason=q.cRLReason||"unspecified";
n.crlEntryExtensions=q;k.push(n)}k=a.crlExtensions||{};k.authorityKeyIdentifier={keyIdentifier:(h.tbsCertificate.extensions||{}).subjectKeyIdentifier||"0",authorityCertIssuer:[{directoryName:h.tbsCertificate.issuer}],authorityCertSerialNumber:h.tbsCertificate.serialNumber};k.cRLNumber=k.cRLNumber||0;f.crlExtensions=k;return F(c,b,e)}).then(function(a){f.buffer=l("TBSCertList").encode(f);return m().sign(f.signature,a,f.buffer)}).then(function(a){a={tbsCertList:f,signatureAlgorithm:f.signature,signatureValue:a};
a.buffer=l("CertificateList").encode(a);d.setCRL(b,a);return l("CertificateList").encode(a,c.format)})},exportCRL:function(a,b){var e=this;return(new r.Promise(u)).then(function(){var c=[e.keyStore.getCRL(a)];if(!c)throw Error("CRL not found");switch((b||"x509").toLowerCase()){case "p7c":return l("ContentInfo").encode({contentType:"signedData",content:{version:4,digestAlgorithms:[],encapContentInfo:{eContentType:"data"},crls:[{crl:c}],signerInfos:[]}},e.format);case "p12":return l("PFX").encode({version:3,
authSafe:{contentType:"data",content:l("SafeContents").encode([{bagId:"crlBag",crltValue:{crlId:"x509CRL",crltValue:c},bagAttributes:"string"===typeof a?{friendlyName:a}:void 0}])}},e.format);default:return l("CertificateList").encode(c,e.format)}})},importCRL:function(a,b){var e=this.keyStore,c,d;return(new r.Promise(u)).then(function(){try{a=v(a,"ContentInfo")}catch(b){a=v(a,"CertificateList")}if(a.contentType&&("signedData"===a.contentType&&(a=a.content.crls[0]),!a))throw Error("Invalid format");
c=a.tbsCertList;if(!c)throw Error("Invalid format");var g=I(e,{issuer:c.issuer});if(g&&0<g.length)d=g[0];else throw Error("Issuer certificate not found");return P(d,a.signatureAlgorithm,a.signatureValue,c.buffer)}).then(function(c){if(!c)throw Error("Certification list has invalid signature");b&&e.setCRL(b,a);return a})},signData:function(a,b,e,c){var d=this,f=d.keyStore,g,h,k,s;b=b||[];b instanceof Array||(b=[b]);b=b.map(function(a){return(a||"").toLowerCase()});return(new r.Promise(u)).then(function(){try{a=
v(a,"ContentInfo")}catch(c){a={contentType:"data",content:E(a)}}var l=f.getCertificate(e);if(!l)throw Error("Signer certificate not found");s=J(l)||d.provider;h={version:1,digestAlgorithm:s.digest,sid:{issuerAndSerialNumber:{issuer:l.tbsCertificate.issuer,serialNumber:l.tbsCertificate.serialNumber}}};if("signedData"===a.contentType){g=a;k=a.encapContentInfo.eContent;g.signerInfos=(g.signerInfos||[]).push(h);var n;g.digestAlgorithms=g.digestAlgorithms||[];g.digestAlgorithms.forEach(function(a){a.id===
g.digestAlgorithm.id&&(n=!0)});n||g.digestAlgorithms.push(g.digestAlgorithm);0<=b.indexOf("detached")&&(a.encapContentInfo.eContent=void 0)}else k=a.content.buffer||a.content,g={version:1,digestAlgorithms:[h.digestAlgorithm],encapContentInfo:{eContentType:a.contentType,eContent:0<=b.indexOf("detached")?void 0:k},signerInfos:[h]};if(0<=b.indexOf("certpath")){g.certificates=g.certificates||[];var B=g.certificates.map(function(a){return a.certificate});ba(f,e).forEach(function(a){0===N(B,{issuer:a.tbsCertificate.issuer,
serialNumber:a.tbsCertificate.serialNumber}).length&&g.certificates.push({certificate:a})})}if(0<=b.indexOf("attrs"))return m().digest(h.digestAlgorithm,k)}).then(function(a){a&&(h.signedAttrs={contentType:g.encapContentInfo.eContentType,messageDigest:a,signingTime:new Date},k=h.signedAttrs.buffer=l("SignedAttributes").encode(h.signedAttrs));return F(d,e,c)}).then(function(a){h.signatureAlgorithm=s.generation;var b=n(h.signatureAlgorithm,{hash:h.digestAlgorithm});return m().sign(b,a,k)}).then(function(a){h.signatureValue=
a;return l("ContentInfo").encode({contentType:"signedData",content:g},d.format)})},digestData:function(a){var b=this,e;return(new r.Promise(u)).then(function(){try{a=v(a,"ContentInfo")}catch(c){a={contentType:"data",content:E(a)}}var d=a.content.buffer||a.content;e={version:1,digestAlgorithm:b.provider.digest,encapContentInfo:{eContentType:a.contentType,eContent:d}};return m().digest(e.digestAlgorithm,d)}).then(function(a){e.digest=a;return l("ContentInfo").encode({contentType:"digestedData",content:e},
b.format)})},encryptData:function(a,b,e,c,d){var f=this,g=f.keyStore,h,k,s,x,q,v,B,A,p,aa,w,t;return(new r.Promise(u)).then(function(){a=E(a);b=(b||"keyagree").toLowerCase();if("keyagree"!==b&&"keytrans"!==b&&"kek"!==b&&"pbkek"!==b&&"keyman"!==b&&"pbes"!==b)throw Error("Invalid envelop mode");switch(b){case "keyagree":case "keytrans":s=e instanceof Array?e:[e];s=s.map(function(a){return g.getCertificate(a)});t=s.map(function(a){return J(a)||f.provider});break;case "kek":case "keyman":d=c;c=e;if(!c||
"string"!==typeof c)throw Error("Alias of secret key must be specified as 4th parameter");s=[e];t=[f.provider];break;case "pbkek":case "pbes":d=e;if(!d||"string"!==typeof d)throw Error("Password must be specified as 4th parameter");s=[e];t=[f.provider]}p=s.map(function(a,b){return C(8)});w="pbes"!==b&&"keyman"!==b;if("pbes"===b)return G.subtle.importKey("raw",H().decode(d,"utf8"),t[0].derivation,!0,["deriveKey"])}).then(function(a){h=n(t[0].encryption);switch(b){case "keyman":return F(f,c,d);case "pbes":return m().deriveKey(n(t[0].derivation,
{salt:p[0]}),a,h,!0,["encrypt"]);default:return m().generateKey(h,!0,["encrypt"])}}).then(function(b){x=b;h.iv||(h.iv=C(8));return m().encrypt(h,x,a)}).then(function(a){q={contentType:"data",contentEncryptionAlgorithm:h,encryptedContent:a};switch(b){case "keyagree":case "keytrans":return Promise.all(s.map(function(a){return O(a)}));case "pbes":a=n(t[0].pbes,{derivation:n(t[0].derivation,{salt:p[0]}),encryption:h}),q.contentEncryptionAlgorithm=a}}).then(function(a){switch(b){case "keyagree":case "keytrans":B=
a;case "kek":return c?F(f,c,d):m().generateKey(t[0].generation,!0,["deriveKey"]);case "pbkek":return G.subtle.importKey("raw",H().decode(d,"utf8"),t[0].derivation,!0,["deriveKey"])}}).then(function(a){if(w){v=a.privateKey||a;var d=c&&g.getCertificate(c);switch(b){case "keyagree":return c?d.tbsCertificate.subjectPublicKeyInfo:m().exportKey("spki",a.publicKey);case "keytrans":return c?O(d):a.publicKey}d&&d.tbsCertificate&&d.tbsCertificate.extensions&&(aa=d.tbsCertificate.extensions.subjectKeyIdentifier)}}).then(function(a){if(w)return A=
a,k="keytrans"===b&&t[0].transwrapping||t[0].wrapping,Promise.all(s.map(function(a,c){var d;switch(b){case "kek":return v;case "pbkek":d=n(t[c].derivation,{salt:p[c]});break;default:d=n(t[c].agreement,{"public":B[c],ukm:p[c]})}return m().deriveKey(d,v,k,!0,["wrapKey"])}))}).then(function(a){if(w)return Promise.all(s.map(function(b,c){return m().wrapKey("raw",x,a[c],n(k,{ukm:p[c]}))}))}).then(function(a){if(w){var d=s.map(function(d,e){var f=s[e].tbsCertificate,f=f?{issuerAndSerialNumber:{issuer:f.issuer,
serialNumber:f.serialNumber}}:void 0;switch(b){case "keyagree":var g=l("SubjectPublicKeyInfo").decode(A),h=n(g.algorithm,t[e].agreement,{wrapping:n(k)});return{kari:{version:3,originator:{originatorKey:{algorithm:g.algorithm,publicKey:g.subjectPublicKey}},ukm:p[e],keyEncryptionAlgorithm:h,recipientEncryptedKeys:[{rid:f,encryptedKey:a[e]}]}};case "keytrans":return h=n(A.algorithm,{ukm:p[e],"public":A,wrapping:n(k)}),{ktri:{version:0,rid:f,keyEncryptionAlgorithm:h,encryptedKey:a[e]}};case "kek":return{kekri:{version:4,
kekid:{keyIdentifier:aa||(z||(z=r.gostCoding)).BER.encode(c)},keyEncryptionAlgorithm:n(k,{ukm:p[e]}),encryptedKey:a[e]}};case "pbkek":return{pwri:{version:0,keyDerivationAlgorithm:n(t[e].derivation,{salt:p[e]}),keyEncryptionAlgorithm:n(k,{ukm:p[e]}),encryptedKey:a[e]}}}}),d={version:b=3,recipientInfos:d,encryptedContentInfo:q};return l("ContentInfo").encode({contentType:"envelopedData",content:d},f.format)}return l("ContentInfo").encode({contentType:"encryptedData",content:{version:0,encryptedContentInfo:q}},
f.format)})},verifyData:function(a,b){var e=this,c=e.keyStore,d,f,g;return(new r.Promise(u)).then(function(){var h=v(a,"ContentInfo");if("signedData"!==h.contentType&&"digestedData"!==h.contentType)throw Error("Invalid signed or digested data format");d=h.content;b&&(b=E(b));f=(g=d.encapContentInfo)&&g.eContent&&g.eContent||b;if(d.signerInfos)return Promise.all(d.signerInfos.map(function(a){a=a.sid.issuerAndSerialNumber;a={issuer:a.issuer,serialNumber:a.serialNumber};var b=I(c,a);if(0<b.length)return b;
var f=(d.certificates||[]).map(function(a){return a.certificate}),b=N(f,a);if(0===b.length)throw Error("Certificate for verification not found");return e.validateCertificate(b.concat(f))}))}).then(function(a){if(d.signerInfos)return Promise.all(d.signerInfos.map(function(b,c){var d=f;if(b.signedAttrs){if(!b.signedAttrs.messageDigest)throw Error("Message digest must present in signed attributes");d=l("SignedAttributes").encode(b.signedAttrs)}if(!d)throw Error("Data for verification not found");var e=
n(b.signatureAlgorithm,{hash:b.digestAlgorithm});return P(a[c][0],e,b.signatureValue,d)}))}).then(function(a){if(d.signerInfos){for(var b=0,c=a.length;b<c;b++)if(!0!==a[b])throw Error("Signature not verified");return Promise.all(d.signerInfos.map(function(a){return a.signedAttrs&&f?m().digest(a.digestAlgorithm,f):!1}))}return m().digest(d.digestAlgorithm,f)}).then(function(a){if(d.signerInfos)d.signerInfos.forEach(function(b,c){if(b.signedAttrs&&f&&0!==S(a[c],b.signedAttrs.messageDigest))throw Error("Data digest not verified");
});else if(0!==S(a,d.digest))throw Error("Data digest not verified");return{contentType:g&&g.eContentType||"data",content:f}})},decryptData:function(a,b,e){var c=this,d=c.keyStore,f,g,h,k,s,p,q,w;return(new r.Promise(u)).then(function(){var h=v(a,"ContentInfo");if("envelopedData"!==h.contentType&&"encryptedData"!==h.contentType)throw Error("Invalid enveloped or encrypted data format");f=h.content;var l=function(a){a:{for(var e=c.keyStore,f=e.aliases(),g=0,h=f.length;g<h;g++){var k=f[g];if(X(e.getCertificate(k),
a)){a=k;break a}}a=void 0}if(a){!b&&d.getKey(a)&&(b=a);if(b===a)return!0;m.push(a)}};q=f.encryptedContentInfo.contentEncryptionAlgorithm;w=c.provider;if("envelopedData"===h.contentType){for(var h=f.recipientInfos,m=[],p=0,u=h.length;p<u;p++){var t=h[p];if(t.ktri){g="keytrans";var y=t.ktri.rid;if(y&&y.issuerAndSerialNumber&&l({issuer:y.issuerAndSerialNumber.issuer,serialNumber:y.issuerAndSerialNumber.serialNumber})||y.subjectKeyIdentifier&&l({subjectKeyIdentifier:y.subjectKeyIdentifier}))k=t.ktri;
w=J(d.getCertificate(b))||c.provider}else if(t.kari){g="keyagree";for(var x=t.kari.recipientEncryptedKeys,C=0,E=x.length;C<E;C++)if((y=x[p].rid)&&y.issuerAndSerialNumber&&l({issuer:y.issuerAndSerialNumber.issuer,serialNumber:y.issuerAndSerialNumber.serialNumber})||y.subjectKeyIdentifier&&l({subjectKeyIdentifier:y.subjectKeyIdentifier})){k={originator:t.kari.originator,keyEncryptionAlgorithm:t.kari.keyEncryptionAlgorithm,ukm:t.kari.ukm,encryptedKey:x[p].encryptedKey};w=J(d.getCertificate(b))||c.provider;
break}}else if(t.kekri){g="kek";y=t.kekri.kekid.keyIdentifier;try{var D=(z||(z=r.gostCoding)).BER.decode(y);D instanceof String&&d.containsAlias(D)&&(b===D.toString()?k=t.kekri:m.push(D))}catch(I){l({subjectKeyIdentifier:y})&&(k=t.kekri)}}else if(t.pwri){g="pbkek";e=b;if(!e||"string"!==typeof e)throw Error("Password required");k=t.pwri}if(k)break}if(!k){if(0<m.length)throw Error("Recipient key required ["+m.join(",")+"]");throw Error("No recipient found in store");}}else if("PBES2"===q.id||"id-sc-pbeWithGost3411AndGost28147"===
q.id||"id-sc-pbeWithGost3411AndGost28147CFB"===q.id){if(g="pbes",e=b,!e||"string"!==typeof e)throw Error("Password required");}else if(g="keyman",!b)throw Error("Secret key alias required");switch(g){case "keytrans":case "keyagree":case "kek":case "keyman":return F(c,b,e);case "pbkek":s=n(w.derivation,{salt:k.keyDerivationAlgorithm.salt,iterations:k.keyDerivationAlgorithm.iterations,hmac:k.keyDerivationAlgorithm.hmac});break;case "pbes":l=q,s=n(w.derivation,{salt:l.derivation.salt,iterations:l.derivation.iterations,
hmac:l.derivation.hmac}),q=l.encryption}return G.subtle.importKey("raw",H().decode(e,"utf8"),s,!0,["deriveKey"])}).then(function(a){h=a;switch(g){case "keyagree":a=k.originator;if(a.originatorKey){var b=l("SubjectPublicKeyInfo").encode({algorithm:a.originatorKey.algorithm,subjectPublicKey:a.originatorKey.publicKey});return m().importKey("spki",b,a.originatorKey.algorithm,!0,["verify","deriveKey"])}if((a=I(d,a.issuerAndSerialNumber?{issuer:a.issuerAndSerialNumber.issuer,serialNumber:a.issuerAndSerialNumber.serialNumber}:
{subjectKeyIdentifier:a.subjectKeyIdentifier}))&&0<a.length)return O(a[0]);throw Error("Originator certificate not found in key stores");}}).then(function(a){switch(g){case "keytrans":s=n(w.agreement,{ukm:k.keyEncryptionAlgorithm.ukm,"public":k.keyEncryptionAlgorithm["public"],sBox:k.keyEncryptionAlgorithm.sBox});p=n(w.transwrapping||w.wrapping,k.keyEncryptionAlgorithm.wrapping,{ukm:k.keyEncryptionAlgorithm.ukm});break;case "keyagree":s=n(k.keyEncryptionAlgorithm,{ukm:k.ukm,"public":a});p=n(k.keyEncryptionAlgorithm.wrapping||
w.wrapping,{ukm:k.ukm});break;case "kek":return p=n(k.keyEncryptionAlgorithm),h;case "keyman":return h;case "pbkek":p=n(k.keyEncryptionAlgorithm);break;case "pbes":p=q}return m().deriveKey(s,h,p,!0,["unwrapKey","decrypt"])}).then(function(a){switch(g){case "pbes":case "keyman":return a;default:return m().unwrapKey("raw",k.encryptedKey,a,p,q,!0,["decrypt"])}}).then(function(a){return m().decrypt(q,a,f.encryptedContentInfo.encryptedContent)}).then(function(a){return{contentType:f.encryptedContentInfo.contentType,
content:a}})},extractData:function(a,b,e){var c=this;return(new r.Promise(u)).then(function(){var d=v(a,"ContentInfo");switch(d.contentType){case "data":return d.content;case "signedData":case "digestedData":return c.verifyData(a);case "encryptedData":case "envelopedData":return c.decryptData(a,b,e);default:throw Error("Data format not supported");}}).then(function(a){var f=a?a.contentType:!1;return"signedData"===f||"digestedData"===f||"encryptedData"===f||"envelopedData"===f?c.extractData(a.content,
b,e):a})}};return $});
