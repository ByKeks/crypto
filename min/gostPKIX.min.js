/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(s,w){"function"===typeof define&&define.amd?define(["gostObject","gostCoding","gostSyntax","gostCrypto"],w):"object"===typeof exports?module.exports=w(require("gostObject"),require("gostCoding"),require("gostSyntax"),require("gostCrypto")):s.GostPKIX=w(s.gostObject,s.gostCoding,s.gostSyntax,s.gostCrypto)})(this,function(s,w,V,E){function L(){return(w||(w=p.gostCoding)).PEM}function k(a){return(V||(V=p.gostSyntax))[a]}function m(){return(E||(E=p.gostCrypto)).subtle}function t(a){try{a()}catch(b){}}
function u(a,b){return"string"===typeof a||a instanceof String||a instanceof ArrayBuffer?k(b).decode(a):a}function A(a){if("string"===typeof a||a instanceof String)a=L().decode(a);if(!(a instanceof ArrayBuffer))throw Error("Type of data must be FormatedData");return a}function B(a){a=new Uint8Array(a);(E||(E=p.gostCrypto)).getRandomValues(a);return a.buffer}function M(a){return a?a.replace(/[\u0000-\u0004]/g,""):a}function z(a,b){for(var c in a)if("buffer"!==c&&("undefined"===typeof b[c]||M(a[c])!==
M(b[c])))return!1;for(c in b)if("buffer"!==c&&("undefined"===typeof a[c]||M(a[c])!==M(b[c])))return!1;return!0}function W(a){return"number"===typeof a||a instanceof Number?a:(w||(w=p.gostCoding)).Int16.encode(a)}function R(a){var b=typeof a;if("undefined"===b||""===a)return"0";a="number"===b||a instanceof Number?a.toString(16):a.replace("0x","");return a.toLowerCase()}function S(a,b){a=R(a);b=R(b);var c=Math.max(a.length,b.length),f=a;a=(Array(c+1).join("0")+f).slice(-c);f=b;b=(Array(c+1).join("0")+
f).slice(-c);return a>b?1:a<b?-1:0}function T(a,b){var c=new Uint8Array(a),f=new Uint8Array(b);if(c.length>f.length)return 1;if(c.length<f.length)return-1;for(var d=0,e=c.length;d<e;d++){if(c[d]>f[d])return 1;if(c[d]<f[d])return-1}return 0}function X(a,b){return a&&b&&(!b.issuer||z(a.tbsCertificate.issuer,b.issuer))&&(!b.serialNumber||0===S(a.tbsCertificate.serialNumber,b.serialNumber))&&(!b.subjectKeyIdentifier||0===T(a.tbsCertificate.extensions.subjectKeyIdentifier,b.subjectKeyIdentifier))&&(!b.subject||
z(a.tbsCertificate.subject,b.subject))&&(!b.date||a.tbsCertificate.validity.notBefore.getTime()<b.date.getTime()&&a.tbsCertificate.validity.notAfter.getTime()>b.date.getTime())}function N(a,b){for(var c=[],f=0,d=a.length;f<d;f++)X(a[f],b)&&c.push(a[f]);return c}function F(a,b){return N(a.getAllCertificates(),b)}function Y(a,b){for(var c=[],f=0,d=a.length;f<d;f++){var e=a[f],g=b;g.issuer&&!z(e.tbsCertList.issuer,g.issuer)||g.date&&!(e.tbsCertList.thisUpdate.getTime()<g.date.getTime())||c.push(a[f])}return c}
function Z(a,b,c,f){for(var d=[];a;){d.push(a);var e={subject:a.tbsCertificate.issuer,date:f};if(a.tbsCertificate.extensions&&a.tbsCertificate.extensions.authorityKeyIdentifier){var g=a.tbsCertificate.extensions.authorityKeyIdentifier;e.subjectKeyIdentifier=g.keyIdentifier;g.authorityCertIssuer&&g.authorityCertIssuer[0].directoryName&&(e.issuer=g.authorityCertIssuer[0].directoryName);g.authorityCertSerialNumber&&(e.serialNumber=W(g.authorityCertSerialNumber))}if(z(a.tbsCertificate.subject,a.tbsCertificate.issuer))a=
!1;else if((a=N(b,e))&&0<a.length){a=a[0];if(e=c)a:{for(var g=a,e=c,e=Y(e,{issuer:g.tbsCertificate.issuer,date:void 0}),g=g.tbsCertificate.serialNumber,h=0,l=e.length;h<l;h++)for(var n=e[h],C=0,q=n.tbsCertList.revokedCertificates.length;C<q;C++)if(0===S(n.tbsCertList.revokedCertificates[C].userCertificate,g)){e=!0;break a}e=!1}e&&(a=!1)}else a=!1}return d}function aa(a,b){var c=a.getCertificate(b);return c?Z(c,a.getAllCertificates(),a.getAllCRLs()):[]}function r(){for(var a={},b=0,c=arguments.length;b<
c;b++){var f=arguments[b];if("object"===typeof f)for(var d in f)a[d]=f[d]}return a}function O(a){a=u(a,"Certificate");a=a.tbsCertificate.subjectPublicKeyInfo;var b="rsaEncryption"===a.algorithm.id?["verify"]:["verify","deriveKey","deriveBits"];return m().importKey("spki",a.buffer,a.algorithm,!0,b)}function P(a,b,c,f){return O(a).then(function(a){return m().verify(b,a,c,f)})}function D(a,b,c){var f,d,e,g;return(new p.Promise(t)).then(function(){var d=a.keyStore.getKey(b);if(!d)throw Error("Private key not found");
if(d.encryptionAlgorithm){f=d.encryptedData;if("PBES2"===d.encryptionAlgorithm.id){if(!c||!("string"===typeof c||c instanceof String))throw Error("Password required to decrypt key");e=d.encryptionAlgorithm.derivation;g=d.encryptionAlgorithm.encryption;return m().importKey("raw",w.Chars.decode(c,"utf8"),e,!1,["deriveKey"])}if(!c||"secret"!==c.type)throw Error("Secret key required to decrypt key");g=d.encryptionAlgorithm}else f=d instanceof ArrayBuffer?d:k("PrivateKeyInfo").encode(d)}).then(function(a){return e?
m().deriveKey(e,a,g,!0,["decrypt"]):c}).then(function(a){return g?m().decrypt(g,a,f):f}).then(function(b){try{d=k("PrivateKeyInfo").decode(b)}catch(e){d=b}if(d.privateKeyAlgorithm){var c="rsaEncryption"===d.privateKeyAlgorithm.id?["sign"]:["sign","deriveKey","deriveBits"];return m().importKey("pkcs8",b,d.privateKeyAlgorithm,!0,c)}c=["encrypt","decrypt","wrapKey","unwrapKey"];return m().importKey("raw",b,a.provider.encryption,!0,c)})}function I(a,b,c,f){var d,e,g,h,l=b.type;return(new p.Promise(t)).then(function(){return"secret"===
l?m().exportKey("raw",b):m().exportKey("pkcs8",b)}).then(function(b){d=b;if(f){if("string"===typeof f||f instanceof String)return g=r(a.provider.pbes.derivation,{salt:B(32),iterations:1}),h=r(a.provider.pbes.encryption),h.iv||(h.iv=B(8)),m().importKey("raw",w.Chars.decode(f,"utf8"),g,!1,["deriveKey"]);if("secret"===f.type)h=r(a.provider.encryption),h.iv||(h.iv=B(8));else throw Error("Password must be string or secret key type");}else e="secret"===l?d:k("PrivateKeyInfo").decode(d)}).then(function(a){return g?
m().deriveKey(g,a,h,!0,["encrypt"]):f}).then(function(a){return h&&m().encrypt(h,a,d)}).then(function(b){h&&(e=g?{encryptionAlgorithm:r(a.provider.pbes,{derivation:g,encryption:h}),encryptedData:b}:{encryptionAlgorithm:h,encryptedData:b});c&&a.keyStore.setKey(c,e);return e})}function U(a){this.entries={};if(a){var b=JSON.parse(a.getItem("gostCrypto.keyStore")||"{}"),c;for(c in b){var f=this.entries[c]={},d=b[c];d.crl&&(f.crl=k("CertificateList").decode(d.crl));d.request&&(f.request=k("CertificationRequest").decode(d.request));
d.cert&&(f.cert=k("Certificate").decode(d.cert));if(d.key)try{f.key=k("PrivateKeyInfo").decode(d.key)}catch(e){try{f.key=k("EncryptedPrivateKeyInfo").decode(d.key)}catch(g){f.key=L().decode(d.key,"KEY")}}}this.save=function(){var b={},d;for(d in this.entries){var e=b[d]={},c=this.entries[d];c.crl&&(e.crl=k("CertificateList").encode(c.crl,"PEM"));c.request&&(e.request=k("CertificationRequest").encode(c.request,"PEM"));c.cert&&(e.cert=k("Certificate").encode(c.cert,"PEM"));if(c.key)try{e.key=k("PrivateKeyInfo").encode(c.key,
"PEM")}catch(f){try{e.key=k("EncryptedPrivateKeyInfo").encode(c.key,"PEM")}catch(g){e.key=L().encode(c.key,"KEY")}}}a.setItem("gostCrypto.keyStore",JSON.stringify(b))}}}function $(a,b,c){this.provider=(s||(s=p.gostObject)).providers[a];this.format=(b||"DER").toUpperCase();this.keyStore=c?c.getItem&&c.setItem?new U(c):c:new U}var p=this;U.prototype={aliases:function(){var a=[],b;for(b in this.entries)a.push(b);return a},containsAlias:function(a){return a in this.entries},deleteEntry:function(a){delete this.entries[a];
this.save&&this.save()},getCertificate:function(a){if(a=this.entries[a])return a.cert},getCRL:function(a){if(a=this.entries[a])return a.crl},getRequest:function(a){if(a=this.entries[a])return a.request},getKey:function(a){if(a=this.entries[a])return a.key},setCertificate:function(a,b){(this.entries[a]||(this.entries[a]={})).cert=u(b,"Certificate");this.save&&this.save()},setCRL:function(a,b){(this.entries[a]||(this.entries[a]={})).crl=u(b,"CertificateList");this.save&&this.save()},setRequest:function(a,
b){(this.entries[a]||(this.entries[a]={})).request=u(b,"CertificationRequest");this.save&&this.save()},setKey:function(a,b){try{b=u(b,"PrivateKeyInfo")}catch(c){try{b=u(b,"EncryptedPrivateKeyInfo")}catch(f){b=A(b)}}(this.entries[a]||(this.entries[a]={})).key=b;this.save&&this.save()},getAllCertificates:function(){var a=[],b;for(b in this.entries){var c=this.entries[b];c.cert&&a.push(c.cert)}return a},getAllCRLs:function(){var a=[],b;for(b in this.entries){var c=this.entries[b];c.crl&&a.push(c.crl)}return a}};
$.prototype={importKeyStore:function(a,b){var c=this,f=c.keyStore,d,e,g,h,l;return(new p.Promise(t)).then(function(){a=u(a,"PFX");h=a.authSafe;if(b&&!a.macData)throw Error("Password based MAC must present");if("signedData"!==h.contentType&&"data"!==h.contentType)throw Error("Unsupported format");if(b)return d=r(c.provider.pbmac.derivation,{salt:a.macData.macSalt,iterations:a.macData.iterations}),e=r(c.provider.pbmac.hmac),m().importKey("raw",w.Chars.decode(b,"utf8"),d,!1,["deriveKey"])}).then(function(a){return d&&
m().deriveKey(d,a,e,!0,["verify"])}).then(function(b){g=b;return e&&m().verify(e,g,a.macData.mac.digest,h.buffer)}).then(function(a){if(!a)throw Error("MAC not verified");return"signedData"===h.contentType?c.verifyData(h):h}).then(function(a){h=a;if("data"!==h.contentType)throw Error("Unsupported format");l=k("AuthenticatedSafe").decode(h.content);return Promise.all(l.map(function(a){if("encryptedData"===a.contentType)return c.decryptData(a,b);if("data"===a.contentType)return a;throw Error("Format not supported");
}))}).then(function(b){l=b;var d=function(a){a.forEach(function(a){var b=a.bagAttributes&&a.bagAttributes.friendlyName||L().encode(B(12));switch(a.bagId){case "keyBag":case "pkcs8ShroudedKeyBag":f.setKey(b,a.bagValue);break;case "certBag":"x509Certificate"===a.bagValue.certId&&f.setCertificate(b,a.bagValue.certValue);break;case "crlBag":"x509CRL"===a.bagValue.crlId&&f.setCRL(b,a.bagValue.crlValue);break;case "safeContentsBag":d(a.bagValue)}})};l.forEach(function(a){d(k("SafeContents").decode(a.content))});
return a})},exportKeyStore:function(a,b){var c=this,f=c.keyStore,d,e,g,h,l;return(new p.Promise(t)).then(function(){for(var e=f.aliases(),l=[],q=0,J=e.length;q<J;q++){var G=e[q],p=f.getKey(G),y;p&&(p.privateKeyAlgorithm?y={bagId:"keyBag",bagValue:u(p,"PrivateKeyInfo")}:p.encryptionAlgorithm&&(y={bagId:"pkcs8ShroudedKeyBag",bagValue:p}),y.bagAttributes={localKeyId:q.toString(16),friendlyName:G},l.push(y));(p=f.getCertificate(G))&&l.push({bagId:"certBag",bagValue:{certId:"x509Certificate",certValue:p},
bagAttributes:{friendlyName:G}});(p=f.getCRL(G))&&l.push({bagId:"crlBag",bagValue:{crlId:"x509CRL",crlValue:p},bagAttributes:{friendlyName:G}})}d=k("SafeContents").encode(l);b=(b||"mac").toLowerCase();if(a)return g=r(c.provider.pbmac.derivation,{salt:B(32),iterations:1}),h=r(c.provider.pbmac.hmac),m().importKey("raw",w.Chars.decode(a,"utf8"),g,!1,["deriveKey"]);if("encrypt"===b)throw Error("Password required for MAC calculation");}).then(function(a){return g&&m().deriveKey(g,a,h,!0,["sign"])}).then(function(e){l=
e;return"encrypt"===b?c.encryptData(d,"pbes",a):{contentType:"data",content:d}}).then(function(a){a=u(a,"ContentInfo");e={contentType:"data",content:k("AuthenticatedSafe").encode([a])};e.buffer=k("ContentInfo").encode(e);return h&&m().sign(h,l,e.buffer)}).then(function(a){var b={version:3,authSafe:e};a&&(b.macData={mac:{digestAlgorithm:h.hash,digest:a},macSalt:g.salt,iterations:g.iterations});return k("PFX").encode(b,c.format)})},exportKey:function(a,b,c){var f=this;return(new p.Promise(t)).then(function(){return D(f,
a,c)}).then(function(a){b=(b||"p8").toLowerCase();switch(b){case "p8":return I(f,a);case "p8e":if(!c)throw Error("Password required for export to encrypted format");return I(f,a,void 0,c);case "p12":throw Error("Not yet implemented");}}).then(function(a){switch(b){case "p8":return k("PrivateKeyInfo").encode(a,f.format);case "p8e":return k("EncryptedPrivateKeyInfo").encode(a,f.format)}})},importKey:function(a,b,c){var f=this;return(new p.Promise(t)).then(function(){try{a=u(a,"PrivateKeyInfo")}catch(d){try{a=
u(a,"EncryptedPrivateKeyInfo")}catch(e){a=A(a)}}f.keyStore.setKey(b,a);if(!a.encryptionAlgorithm&&c)return D(f,b)}).then(function(d){return d?I(f,d,b,c):a})},createCertificate:function(a,b,c){var f=this,d={},e={},g,h;return(new p.Promise(t)).then(function(){a=a||{};d.version=2;e.signatureAlgorithm=d.signature=a.signature||f.provider.signature;if(!d.signature)throw Error("Signature Algorithm not defined");var b=f.provider.generation;if(!b)throw Error("Key Algorithm not defined");return m().generateKey(b,
!0,["sign","verify"])}).then(function(a){g=a.publicKey;h=a.privateKey;return m().exportKey("spki",g)}).then(function(a){d.subjectPublicKeyInfo=k("SubjectPublicKeyInfo").decode(a);return m().digest(f.provider.digest,a)}).then(function(b){b=(new Uint8Array(new Uint8Array(b,0,20))).buffer;d.subject=a.subject||a.issure;d.issuer=d.subject;if(!d.subject)throw Error("Subject or issuer not defined");d.serialNumber=a.serialNumber||1;var c={};a.validity&&a.validity.notBefore?c.notBefore=a.validity.notBefore:
(c.notBefore=new Date,c.notBefore.setHours(0,0,0,0));a.validity&&a.validity.notAfter?c.notAfter=a.validity.notAfter:(c.notAfter=new Date(c.notBefore),c.notAfter.setFullYear(c.notAfter.getFullYear()+25));d.validity=c;c=a.extensions||{};c.keyUsage=c.keyUsage||"digitalSignature nonRepudiation keyEncipherment dataEncipherment keyAgreement keyCertSign cRLSign".split(" ");c.basicConstraints=c.basicConstraints||{cA:!0};c.extKeyUsage=c.extKeyUsage||"serverAuth clientAuth codeSigning emailProtection ipsecEndSystem ipsecTunnel ipsecUser timeStamping OCSPSigning".split(" ");
c.subjectKeyIdentifier=b;c.authorityKeyIdentifier={keyIdentifier:b,authorityCertIssuer:[{directoryName:d.issuer}],authorityCertSerialNumber:d.serialNumber};d.extensions=c;d.buffer=k("TBSCertificate").encode(d);return m().sign(e.signatureAlgorithm,h,d.buffer)}).then(function(a){e.tbsCertificate=d;e.signatureValue=a;e.buffer=k("Certificate").encode(e);return I(f,h,b,c)}).then(function(){f.keyStore.setCertificate(b,e);return k("Certificate").encode(e,f.format)})},issueCertificate:function(a,b,c,f){var d=
this,e=d.keyStore,g={},h={},l,n;return(new p.Promise(t)).then(function(){n=e.getRequest(b);l=n.requestInfo;g.version=2;g.signature=n.signatureAlgorithm;g.subjectPublicKeyInfo=l.subjectPublicKeyInfo;return m().importKey("spki",l.subjectPublicKeyInfo.buffer,l.subjectPublicKeyInfo.algorithm,!0,["verify"])}).then(function(a){return m().verify(n.signatureAlgorithm,a,n.signatureValue,l.buffer)}).then(function(a){if(!a)throw Error("Request signature is not valid");return m().digest(d.provider.digest,g.subjectPublicKeyInfo.buffer)}).then(function(b){b=
(new Uint8Array(new Uint8Array(b,0,20))).buffer;g.subject=l.subject;if(!g.subject)throw Error("Subject not defined");var q=e.getCertificate(c);if(!q)throw Error("Authority certificate not found");var k=q.tbsCertificate.extensions&&q.tbsCertificate.extensions.keyUsage;if(k&&0>k.indexOf("keyCertSign"))throw Error("Issuer key can't be used for sign certificate");var n;a.validity&&a.validity.notBefore?n=a.validity.notBefore:(n=new Date,n.setHours(0,0,0,0));var m=q.tbsCertificate.validity;if(!m||m.notBefore.getTime()>
n.getTime())throw Error("Issuer certificate is not released");if(!m||m.notAfter.getTime()<n.getTime())throw Error("Issuer certificate expired");g.issuer=q.tbsCertificate.issuer;var k=q.tbsCertificate.serialNumber,p=(q.tbsCertificate.extensions||{}).subjectKeyIdentifier,r=(q.tbsCertificate.extensions||{}).basicConstraints,r=(r=r&&r.pathLenConstraint)?r+1:0,t=q.tbsCertificate.issuer;h.signatureAlgorithm=q.tbsCertificate.signature;if(a.serialNumber)g.serialNumber=a.serialNumber;else{for(var q=F(e,{issuer:g.issuer}),
v=1,Q=0,u=q.length;Q<u;Q++)if(0<=S(q[Q].tbsCertificate.serialNumber,v)){for(var v=q[Q].tbsCertificate.serialNumber,v=R(v),K="",w=1,s=v.length-1;0<=s;--s){var H=v.charCodeAt(s);1===w&&(102===H?H=48:(w=0,57===H?H=97:H++));K=String.fromCharCode(H)+K}1===w&&(K="1"+K);v="0x"+K}g.serialNumber=v}q={};q.notBefore=n;q.notAfter=a.validity&&a.validity.notAfter?a.validity.notAfter:m.notAfter;g.validity=q;n=a.extensions||{};m=l.attributes&&(l.attributes.extensionRequest||l.attributes.msCertExtensions)||{};n.keyUsage=
n.keyUsage||m.keyUsage||["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement"];n.basicConstraints=n.basicConstraints||m.basicConstraints||{cA:0<=n.keyUsage.indexOf("keyCertSign"),pathLenConstraint:r};n.extKeyUsage=n.extKeyUsage||m.extKeyUsage||["clientAuth","emailProtection"];n.subjectKeyIdentifier=b;n.authorityKeyIdentifier={keyIdentifier:p,authorityCertIssuer:[{directoryName:t}],authorityCertSerialNumber:k};g.extensions=n;return D(d,c,f)}).then(function(a){g.buffer=
k("TBSCertificate").encode(g);return m().sign(h.signatureAlgorithm,a,g.buffer)}).then(function(a){h.tbsCertificate=g;h.signatureValue=a;h.buffer=k("Certificate").encode(h);return e.setCertificate(b,h)}).then(function(){return k("Certificate").encode(h,d.format)})},exportCertificate:function(a,b){var c=this;return(new p.Promise(t)).then(function(){var f=c.keyStore.getCertificate(a);if(!f)throw Error("Certificate not found");switch((b||"x509").toLowerCase()){case "p7c":return k("ContentInfo").encode({contentType:"signedData",
content:{version:1,digestAlgorithms:[],encapContentInfo:{eContentType:"data"},certificates:[f],signerInfos:[]}},c.format);case "p12":return k("PFX").encode({version:3,authSafe:{contentType:"data",content:k("SafeContents").encode([{bagId:"certBag",crltValue:{certId:"x509Certificate",certValue:f},bagAttributes:"string"===typeof a?{friendlyName:a}:void 0}])}},c.format);default:return k("Certificate").encode(f,c.format)}})},importCertificate:function(a,b){var c=this.keyStore,f;return(new p.Promise(t)).then(function(){try{a=
u(a,"ContentInfo")}catch(b){a=u(a,"Certificate")}if(a.contentType&&("signedData"===a.contentType&&(a=a.content.certificates[0]),!a))throw Error("Invalid format");f=a.tbsCertificate;if(!f)throw Error("Invalid format");var e;if(z(a.tbsCertificate.subject,a.tbsCertificate.issuer))e=a;else if(c){e={subject:a.tbsCertificate.issuer};if(a.tbsCertificate.extensions&&a.tbsCertificate.extensions.authorityKeyIdentifier){var g=a.tbsCertificate.extensions.authorityKeyIdentifier;e.subjectKeyIdentifier=g.keyIdentifier;
g.authorityCertIssuer&&g.authorityCertIssuer[0].directoryName&&(e.issuer=g.authorityCertIssuer[0].directoryName);g.authorityCertSerialNumber&&(e.serialNumber=W(g.authorityCertSerialNumber))}if((e=F(c,e))&&0<e.length)e=e[0];else throw Error("Issuer for certificate not found in store");}return P(e,a.signatureAlgorithm,a.signatureValue,f.buffer)}).then(function(d){if(!d)throw Error("Certificate has invalid signature");b&&c.setCertificate(b,a);return a})},validateCertificate:function(a,b){var c=this.keyStore,
f=[];return(new p.Promise(t)).then(function(){var d=a;d instanceof Array||(d=[a]);d=d.map(function(a){return u(a,"Certificate")});b=b||new Date;f=Z(d[0],d.concat(c.getAllCertificates()),c.getAllCRLs(),b);for(var e=!1,d=f.length-1;0<=d;--d)if(0<F(c,{issuer:f[d].tbsCertificate.issuer,serialNumber:f[d].tbsCertificate.serialNumber}).length){e=!0;break}if(!e)throw Error("There are not trusted certificates in validation path");for(var e=[],d=0,g=f.length;d<g;d++){var h=f[d],l=d+1;l===g&&z(h.tbsCertificate.issuer,
h.tbsCertificate.subject)&&(l=d);l<g&&e.push(P(f[l],h.signatureAlgorithm,h.signatureValue,h.tbsCertificate.buffer))}return Promise.all(e)}).then(function(a){for(var b=0,c=a.length;b<c;b++)if(!0!==a[b])throw Error("Certificate in path has invalid signature");return f})},createRequest:function(a,b,c){var f=this,d={},e={},g,h;return(new p.Promise(t)).then(function(){a=a||{};d.signatureAlgorithm=a.signatureAlgorithm||f.provider.signature;var b=f.provider.generation;if(!d.signatureAlgorithm)throw Error("Signature Algorithm not defined");
if(!b)throw Error("Key Algorithm not defined");return m().generateKey(b,!0,["sign","verify"])}).then(function(a){g=a.publicKey;h=a.privateKey;return m().exportKey("spki",g)}).then(function(b){e.subjectPublicKeyInfo=k("SubjectPublicKeyInfo").decode(b);e.subject=a.subject;if(!e.subject)throw Error("Subject not defined");e.version=0;b=a.extensions||{};b.keyUsage=b.keyUsage||["digitalSignature","nonRepudiation","dataEncipherment","keyAgreement"];b.extKeyUsage=["clientAuth","emailProtection"];e.attributes=
{extensionRequest:b};e.buffer=k("CertificationRequestInfo").encode(e);return m().sign(d.signatureAlgorithm,h,e.buffer)}).then(function(a){d.requestInfo=e;d.signatureValue=a;d.buffer=k("CertificationRequest").encode(d);return I(f,h,b,c)}).then(function(){f.keyStore.setRequest(b,d);return k("CertificationRequest").encode(d,f.format)})},exportRequest:function(a){var b=this,c;return(new p.Promise(t)).then(function(){c=b.keyStore.getRequest(a);if(!c)throw Error("Certification request not found");return k("CertificationRequest").encode(c,
b.format)})},importRequest:function(a,b){var c=this,f;return(new p.Promise(t)).then(function(){a=u(a,"CertificationRequest");f=a.requestInfo;var b=f.subjectPublicKeyInfo;return m().importKey("spki",b.buffer,b.algorithm,!0,["verify"])}).then(function(b){return m().verify(a.signatureAlgorithm,b,a.signatureValue,f.buffer)}).then(function(d){if(!d)throw Error("Request signature is not valid");b&&c.keyStore.setRequest(b,a);return a})},updateCRL:function(a,b,c){var f=this,d=f.keyStore,e={};return(new p.Promise(t)).then(function(){a=
a||{};var g=d.getCertificate(b);if(!g)throw Error("Issuer certificate not found");if(0>((g.tbsCertificate.extensions||{}).keyUsage||[]).indexOf("cRLSign"))throw Error("Issuer has not rights for CRL sign");var h=g.tbsCertificate.extensions&&g.tbsCertificate.extensions.keyUsage;if(h&&0>h.indexOf("cRLSign"))throw Error("Issuer key can't be used for sign CRL");if(a.issuer&&z(a.issuer,g.tbsCertificate.issue))throw Error("CRL prototype and authority certificate have different issuers");(h=d.getCRL(b))?
e=h.tbsCertList:(h=Y(d.getAllCRLs,{issuer:g.tbsCertificate.issuer}))&&0<h.length?e=h[0].tbsCertList:(e.issuer=g.tbsCertificate.issuer,e.revokedCertificates=[]);e.version=1;e.signature=g.tbsCertificate.signature;a.thisUpdate?e.thisUpdate=a.thisUpdate:(e.thisUpdate=new Date,e.thisUpdate.setHours(0,0,0,0));a.nextUpdate?e.nextUpdate=a.nextUpdate:(e.nextUpdate=new Date(e.thisUpdate),e.nextUpdate.setFullYear(e.nextUpdate.getFullYear()+25));h=g.tbsCertificate.validity;if(!h||h.notBefore.getTime()>e.thisUpdate.getTime())throw Error("Issuer certificate is not released");
if(!h||h.notAfter.getTime()<e.thisUpdate.getTime())throw Error("Issuer certificate expired");h=e.revokedCertificates;if(a.revokedCertificates)for(var l=0,n=a.revokedCertificates.length;l<n;l++){var k=a.revokedCertificates[l],m={};if(!k.userCertificate)throw Error("Serail number of revoked certificate not found");m.userCertificate=k.userCertificate;k.revocationDate?m.revocationDate=k.revocationDate:(m.revocationDate=new Date,m.revocationDate.setHours(0,0,0,0));k=k.crlEntryExtensions||{};k.cRLReason=
k.cRLReason||"unspecified";m.crlEntryExtensions=k;h.push(m)}h=a.crlExtensions||{};h.authorityKeyIdentifier={keyIdentifier:(g.tbsCertificate.extensions||{}).subjectKeyIdentifier||"0",authorityCertIssuer:[{directoryName:g.tbsCertificate.issuer}],authorityCertSerialNumber:g.tbsCertificate.serialNumber};h.cRLNumber=h.cRLNumber||0;e.crlExtensions=h;return D(f,b,c)}).then(function(a){e.buffer=k("TBSCertList").encode(e);return m().sign(e.signature,a,e.buffer)}).then(function(a){a={tbsCertList:e,signatureAlgorithm:e.signature,
signatureValue:a};a.buffer=k("CertificateList").encode(a);d.setCRL(b,a);return k("CertificateList").encode(a,f.format)})},exportCRL:function(a,b){var c=this;return(new p.Promise(t)).then(function(){var f=[c.keyStore.getCRL(a)];if(!f)throw Error("CRL not found");switch((b||"x509").toLowerCase()){case "p7c":return k("ContentInfo").encode({contentType:"signedData",content:{version:4,digestAlgorithms:[],encapContentInfo:{eContentType:"data"},crls:[{crl:f}],signerInfos:[]}},c.format);case "p12":return k("PFX").encode({version:3,
authSafe:{contentType:"data",content:k("SafeContents").encode([{bagId:"crlBag",crltValue:{crlId:"x509CRL",crltValue:f},bagAttributes:"string"===typeof a?{friendlyName:a}:void 0}])}},c.format);default:return k("CertificateList").encode(f,c.format)}})},importCRL:function(a,b){var c=this.keyStore,f,d;return(new p.Promise(t)).then(function(){try{a=u(a,"ContentInfo")}catch(b){a=u(a,"CertificateList")}if(a.contentType&&("signedData"===a.contentType&&(a=a.content.crls[0]),!a))throw Error("Invalid format");
f=a.tbsCertList;if(!f)throw Error("Invalid format");var g=F(c,{issuer:f.issuer});if(g&&0<g.length)d=g[0];else throw Error("Issuer certificate not found");return P(d,a.signatureAlgorithm,a.signatureValue,f.buffer)}).then(function(d){if(!d)throw Error("Certification list has invalid signature");b&&c.setCRL(b,a);return a})},signData:function(a,b,c,f){var d=this,e=d.keyStore,g,h,l;b=b||[];b instanceof Array||(b=[b]);b=b.map(function(a){return(a||"").toLowerCase()});return(new p.Promise(t)).then(function(){try{a=
u(a,"ContentInfo")}catch(f){a={contentType:"data",content:A(a)}}var k=e.getCertificate(c);if(!k)throw Error("Signer certificate not found");h={version:1,digestAlgorithm:d.provider.digest,sid:{issuerAndSerialNumber:{issuer:k.tbsCertificate.issuer,serialNumber:k.tbsCertificate.serialNumber}}};if("signedData"===a.contentType){g=a;l=a.encapContentInfo.eContent;g.signerInfos=(g.signerInfos||[]).push(h);var q;g.digestAlgorithms=g.digestAlgorithms||[];g.digestAlgorithms.forEach(function(a){a.id===g.digestAlgorithm.id&&
(q=!0)});q||g.digestAlgorithms.push(g.digestAlgorithm);0<=b.indexOf("detached")&&(a.encapContentInfo.eContent=void 0)}else l=a.content.buffer||a.content,g={version:1,digestAlgorithms:[h.digestAlgorithm],encapContentInfo:{eContentType:a.contentType,eContent:0<=b.indexOf("detached")?void 0:l},signerInfos:[h]};if(0<=b.indexOf("certpath")){g.certificates=g.certificates||[];var p=g.certificates.map(function(a){return a.certificate});aa(e,c).forEach(function(a){0===N(p,{issuer:a.tbsCertificate.issuer,serialNumber:a.tbsCertificate.serialNumber}).length&&
g.certificates.push({certificate:a})})}if(0<=b.indexOf("attrs"))return m().digest(h.digestAlgorithm,l)}).then(function(a){a&&(h.signedAttrs={contentType:g.encapContentInfo.eContentType,messageDigest:a,signingTime:new Date},l=h.signedAttrs.buffer=k("SignedAttributes").encode(h.signedAttrs));return D(d,c,f)}).then(function(a){h.signatureAlgorithm=d.provider.generation;var b=r(h.signatureAlgorithm,{hash:h.digestAlgorithm});return m().sign(b,a,l)}).then(function(a){h.signatureValue=a;return k("ContentInfo").encode({contentType:"signedData",
content:g},d.format)})},digestData:function(a){var b=this,c;return(new p.Promise(t)).then(function(){try{a=u(a,"ContentInfo")}catch(f){a={contentType:"data",content:A(a)}}var d=a.content.buffer||a.content;c={version:1,digestAlgorithm:b.provider.digest,encapContentInfo:{eContentType:a.contentType,eContent:d}};return m().digest(c.digestAlgorithm,d)}).then(function(a){c.digest=a;return k("ContentInfo").encode({contentType:"digestedData",content:c},b.format)})},encryptData:function(a,b,c,f,d){var e=this,
g=e.keyStore,h,l,n,C,q,J,u,s,y,z,x;return(new p.Promise(t)).then(function(){a=A(a);b=(b||"keyagree").toLowerCase();if("keyagree"!==b&&"keytrans"!==b&&"kek"!==b&&"pbkek"!==b&&"keyman"!==b&&"pbes"!==b)throw Error("Invalid envelop mode");switch(b){case "keyagree":case "keytrans":n=c instanceof Array?c:[c];n=n.map(function(a){return g.getCertificate(a)});break;case "kek":case "keyman":d=f;f=c;if(!f||"string"!==typeof f)throw Error("Alias of secret key must be specified as 4th parameter");n=[c];break;
case "pbkek":case "pbes":d=c;if(!d||"string"!==typeof d)throw Error("Password must be specified as 4th parameter");n=[c]}y=n.map(function(a,b){return B(8)});x="pbes"!==b&&"keyman"!==b;if("pbes"===b)return E.subtle.importKey("raw",w.Chars.decode(d,"utf8"),e.provider.derivation,!0,["deriveKey"])}).then(function(a){h=r(e.provider.encryption);switch(b){case "keyman":return D(e,f,d);case "pbes":return m().deriveKey(r(e.provider.derivation,{salt:y[0]}),a,h,!0,["encrypt"]);default:return m().generateKey(h,
!0,["encrypt"])}}).then(function(b){C=b;h.iv||(h.iv=B(8));return m().encrypt(h,C,a)}).then(function(a){q={contentType:"data",contentEncryptionAlgorithm:h,encryptedContent:a};switch(b){case "keyagree":case "keytrans":return Promise.all(n.map(function(a){return O(a)}));case "pbes":a=r(e.provider.pbes,{derivation:r(e.provider.derivation,{salt:y[0]}),encryption:h}),q.contentEncryptionAlgorithm=a}}).then(function(a){switch(b){case "keyagree":case "keytrans":u=a;case "kek":return f?D(e,f,d):m().generateKey(e.provider.generation,
!0,["deriveKey"]);case "pbkek":return E.subtle.importKey("raw",w.Chars.decode(d,"utf8"),e.provider.derivation,!0,["deriveKey"])}}).then(function(a){if(x){J=a.privateKey||a;var c=f&&g.getCertificate(f);switch(b){case "keyagree":return f?c.tbsCertificate.subjectPublicKeyInfo:m().exportKey("spki",a.publicKey);case "keytrans":return f?O(c):a.publicKey}c&&c.tbsCertificate&&c.tbsCertificate.extensions&&(z=c.tbsCertificate.extensions.subjectKeyIdentifier)}}).then(function(a){if(x)return s=a,l="keytrans"===
b&&e.provider.transwrapping||e.provider.wrapping,Promise.all(n.map(function(a,c){var d;switch(b){case "kek":return J;case "pbkek":d=r(e.provider.derivation,{salt:y[c]});break;default:d=r(e.provider.agreement,{"public":u[c],ukm:y[c]})}return m().deriveKey(d,J,l,!0,["wrapKey"])}))}).then(function(a){if(x)return Promise.all(n.map(function(b,c){return m().wrapKey("raw",C,a[c],r(l,{ukm:y[c]}))}))}).then(function(a){if(x){var c=n.map(function(c,d){var g=n[d].tbsCertificate,g=g?{issuerAndSerialNumber:{issuer:g.issuer,
serialNumber:g.serialNumber}}:void 0;switch(b){case "keyagree":var h=k("SubjectPublicKeyInfo").decode(s),m=r(h.algorithm,e.provider.agreement,{wrapping:r(l)});return{kari:{version:3,originator:{originatorKey:{algorithm:h.algorithm,publicKey:h.subjectPublicKey}},ukm:y[d],keyEncryptionAlgorithm:m,recipientEncryptedKeys:[{rid:g,encryptedKey:a[d]}]}};case "keytrans":return m=r(s.algorithm,{ukm:y[d],"public":s,wrapping:r(l)}),{ktri:{version:0,rid:g,keyEncryptionAlgorithm:m,encryptedKey:a[d]}};case "kek":return{kekri:{version:4,
kekid:{keyIdentifier:z||(w||(w=p.gostCoding)).BER.encode(f)},keyEncryptionAlgorithm:r(l,{ukm:y[d]}),encryptedKey:a[d]}};case "pbkek":return{pwri:{version:0,keyDerivationAlgorithm:r(e.provider.derivation,{salt:y[d]}),keyEncryptionAlgorithm:r(l,{ukm:y[d]}),encryptedKey:a[d]}}}}),c={version:b=3,recipientInfos:c,encryptedContentInfo:q};return k("ContentInfo").encode({contentType:"envelopedData",content:c},e.format)}return k("ContentInfo").encode({contentType:"encryptedData",content:{version:0,encryptedContentInfo:q}},
e.format)})},verifyData:function(a,b){var c=this,f=c.keyStore,d,e,g;return(new p.Promise(t)).then(function(){var h=u(a,"ContentInfo");if("signedData"!==h.contentType&&"digestedData"!==h.contentType)throw Error("Invalid signed or digested data format");d=h.content;b&&(b=A(b));e=(g=d.encapContentInfo)&&g.eContent&&g.eContent||b;if(d.signerInfos)return Promise.all(d.signerInfos.map(function(a){a=a.sid.issuerAndSerialNumber;a={issuer:a.issuer,serialNumber:a.serialNumber};var b=F(f,a);if(0<b.length)return b;
var e=(d.certificates||[]).map(function(a){return a.certificate}),b=N(e,a);if(0===b.length)throw Error("Certificate for verification not found");return c.validateCertificate(b.concat(e))}))}).then(function(a){if(d.signerInfos)return Promise.all(d.signerInfos.map(function(b,c){var d=e;if(b.signedAttrs){if(!b.signedAttrs.messageDigest)throw Error("Message digest must present in signed attributes");d=k("SignedAttributes").encode(b.signedAttrs)}if(!d)throw Error("Data for verification not found");var f=
r(b.signatureAlgorithm,{hash:b.digestAlgorithm});return P(a[c][0],f,b.signatureValue,d)}))}).then(function(a){if(d.signerInfos){for(var b=0,c=a.length;b<c;b++)if(!0!==a[b])throw Error("Signature not verified");return Promise.all(d.signerInfos.map(function(a){return a.signedAttrs&&e?m().digest(a.digestAlgorithm,e):!1}))}return m().digest(d.digestAlgorithm,e)}).then(function(a){if(d.signerInfos)d.signerInfos.forEach(function(b,c){if(b.signedAttrs&&e&&0!==T(a[c],b.signedAttrs.messageDigest))throw Error("Data digest not verified");
});else if(0!==T(a,d.digest))throw Error("Data digest not verified");return{contentType:g&&g.eContentType||"data",content:e}})},decryptData:function(a,b,c){var f=this,d=f.keyStore,e,g,h,l,n,s,q;return(new p.Promise(t)).then(function(){var h=u(a,"ContentInfo");if("envelopedData"!==h.contentType&&"encryptedData"!==h.contentType)throw Error("Invalid enveloped or encrypted data format");e=h.content;var k=function(a){a:{for(var c=f.keyStore,d=c.aliases(),e=0,g=d.length;e<g;e++){var h=d[e];if(X(c.getCertificate(h),
a)){a=h;break a}}a=void 0}if(b&&b===a)return!0;a&&m.push(a)};q=e.encryptedContentInfo.contentEncryptionAlgorithm;if("envelopedData"===h.contentType){for(var h=e.recipientInfos,m=[],s=0,t=h.length;s<t;s++){var x=h[s];if(x.ktri){g="keytrans";var v=x.ktri.rid;if(v&&v.issuerAndSerialNumber&&k({issuer:v.issuerAndSerialNumber.issuer,serialNumber:v.issuerAndSerialNumber.serialNumber})||v.subjectKeyIdentifier&&k({subjectKeyIdentifier:v.subjectKeyIdentifier}))l=x.ktri}else if(x.kari){g="keyagree";for(var z=
x.kari.recipientEncryptedKeys,B=0,C=z.length;B<C;B++)if((v=z[s].rid)&&v.issuerAndSerialNumber&&k({issuer:v.issuerAndSerialNumber.issuer,serialNumber:v.issuerAndSerialNumber.serialNumber})||v.subjectKeyIdentifier&&k({subjectKeyIdentifier:v.subjectKeyIdentifier})){l={originator:x.kari.originator,keyEncryptionAlgorithm:x.kari.keyEncryptionAlgorithm,ukm:x.kari.ukm,encryptedKey:z[s].encryptedKey};break}}else if(x.kekri){g="kek";v=x.kekri.kekid.keyIdentifier;try{var A=(w||(w=p.gostCoding)).BER.decode(v);
A instanceof String&&d.containsAlias(A)&&(b===A.toString()?l=x.kekri:m.push(A))}catch(F){k({subjectKeyIdentifier:v})&&(l=x.kekri)}}else if(x.pwri){g="pbkek";c=b;if(!c||"string"!==typeof c)throw Error("Password required");l=x.pwri}if(l)break}if(!l){if(0<m.length)throw Error("Recipient key required ["+m.join(",")+"]");throw Error("No recipient found in store");}}else if("PBES2"===q.id||"id-sc-pbeWithGost3411AndGost28147"===q.id||"id-sc-pbeWithGost3411AndGost28147CFB"===q.id){if(g="pbes",c=b,!c||"string"!==
typeof c)throw Error("Password required");}else if(g="keyman",!b)throw Error("Secret key alias required");switch(g){case "keytrans":case "keyagree":case "kek":case "keyman":return D(f,b,c);case "pbkek":n=r(f.provider.derivation,{salt:l.keyDerivationAlgorithm.salt,iterations:l.keyDerivationAlgorithm.iterations,hmac:l.keyDerivationAlgorithm.hmac});break;case "pbes":k=q,n=r(f.provider.derivation,{salt:k.derivation.salt,iterations:k.derivation.iterations,hmac:k.derivation.hmac}),q=k.encryption}return E.subtle.importKey("raw",
w.Chars.decode(c,"utf8"),n,!0,["deriveKey"])}).then(function(a){h=a;switch(g){case "keyagree":a=l.originator;if(a.originatorKey){var b=k("SubjectPublicKeyInfo").encode({algorithm:a.originatorKey.algorithm,subjectPublicKey:a.originatorKey.publicKey});return m().importKey("spki",b,a.originatorKey.algorithm,!0,["verify","deriveKey"])}if((a=F(d,a.issuerAndSerialNumber?{issuer:a.issuerAndSerialNumber.issuer,serialNumber:a.issuerAndSerialNumber.serialNumber}:{subjectKeyIdentifier:a.subjectKeyIdentifier}))&&
0<a.length)return O(a[0]);throw Error("Originator certificate not found in key stores");}}).then(function(a){switch(g){case "keytrans":n=r(f.provider.agreement,{ukm:l.keyEncryptionAlgorithm.ukm,"public":l.keyEncryptionAlgorithm["public"],sBox:l.keyEncryptionAlgorithm.sBox});s=r(f.provider.transwrapping||f.provider.wrapping,l.keyEncryptionAlgorithm.wrapping,{ukm:l.keyEncryptionAlgorithm.ukm});break;case "keyagree":n=r(l.keyEncryptionAlgorithm,{ukm:l.ukm,"public":a});s=r(l.keyEncryptionAlgorithm.wrapping||
f.provider.wrapping,{ukm:l.ukm});break;case "kek":return s=r(l.keyEncryptionAlgorithm),h;case "keyman":return h;case "pbkek":s=r(l.keyEncryptionAlgorithm);break;case "pbes":s=q}return m().deriveKey(n,h,s,!0,["unwrapKey","decrypt"])}).then(function(a){switch(g){case "pbes":case "keyman":return a;default:return m().unwrapKey("raw",l.encryptedKey,a,s,q,!0,["decrypt"])}}).then(function(a){return m().decrypt(q,a,e.encryptedContentInfo.encryptedContent)}).then(function(a){return{contentType:e.encryptedContentInfo.contentType,
content:a}})},extractData:function(a,b,c){var f=this;return(new p.Promise(t)).then(function(){var d=u(a,"ContentInfo");switch(d.contentType){case "data":return d.content;case "signedData":case "digestedData":return f.verifyData(a);case "encryptedData":case "envelopedData":return f.decryptData(a,b,c);default:throw Error("Data format not supported");}}).then(function(a){var e=a?a.contentType:!1;return"signedData"===e||"digestedData"===e||"encryptedData"===e||"envelopedData"===e?f.extractData(a.content,
b,c):a})}};return $});
