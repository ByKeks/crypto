/*
 2014, Rudolf Nickolaev. All rights reserved.
*/
(function(r,v){"function"===typeof define&&define.amd?define(["gostRandom"],v):"object"===typeof exports?module.exports=v(require("gostRandom")):("undefined"!==typeof importScripts&&(r.gostRandom||importScripts("gostRandom.js")),r.Gost28147=v(r.gostRandom))})(this,function(r){function v(a){return 2147483648<=a?a-4294967296:a}function K(a){return 0>a?a+4294967296:a}function B(a){r=r||w.gostRandom;!r&&I&&I.getRandomValues&&(r=I);if(r)r.getRandomValues(a);else throw new C("Random generator not found");
}function p(a){if(a instanceof ArrayBuffer)return a;if(a&&a.buffer&&a.buffer instanceof ArrayBuffer)return 0===a.byteOffset&&a.byteLength===a.buffer.byteLength?a.buffer:(new Uint8Array(new Uint8Array(a,a.byteOffset,a.byteLength))).buffer;throw new s("ArrayBuffer or ArrayBufferView required");}function x(a){return new Uint8Array(p(a))}function u(a){return new Int32Array(p(a))}function t(a,c,b){b=c[0]+b&4294967295;var d=a[0+(b>>0&15)]<<0,d=d|a[16+(b>>4&15)]<<4,d=d|a[32+(b>>8&15)]<<8,d=d|a[48+(b>>12&
15)]<<12,d=d|a[64+(b>>16&15)]<<16,d=d|a[80+(b>>20&15)]<<20,d=d|a[96+(b>>24&15)]<<24,d=d|a[112+(b>>28&15)]<<28;b=(d<<11|d>>>21)^c[1];c[1]=c[0];c[0]=b}function q(a,c,b,d){for(var e=0;8>e;e++)t(c,d,b[e]);if(a){for(e=0;8>e;e++)t(c,d,b[e]);for(e=0;8>e;e++)t(c,d,b[e])}else{for(e=7;0<=e;e--)t(c,d,b[e]);for(e=7;0<=e;e--)t(c,d,b[e])}for(e=7;0<=e;e--)t(c,d,b[e]);a=d[0];d[0]=d[1];d[1]=a}function D(a,c){for(var b=this.padding(c),d=b.byteLength/8,e=new Int32Array(p(a)),g=0;g<d;g++){var f=new Int32Array(b.buffer,
8*g,2);q(!0,this.sBox,e,f)}return b.buffer}function E(a,c){for(var b=this.padding(c),d=b.byteLength/8,e=new Int32Array(p(a)),g=0;g<d;g++){var f=new Int32Array(b.buffer,8*g,2);q(!1,this.sBox,e,f)}return b.buffer}function J(a,c,b){b=new Uint8Array(b||this.iv||y);c=this.padding(c);var d=Math.floor(this.shiftBits/8)||8,e=c.length,g=e%d,e=(e-g)/d;a=new Int32Array(u(a));for(var f=new Int32Array(b.buffer),l=0;l<e;l++){if(8===d){q(!0,this.sBox,a,f);var h=new Int32Array(c.buffer,l*d,2);h[0]^=f[0];h[1]^=f[1];
f[0]=h[0];f[1]=h[1]}else{h=new Uint8Array(b);q(!0,this.sBox,a,f);for(var m=0;m<d;m++)c[l*d+m]^=b[m];for(m=0;m<8-d;m++)b[m]=h[d+m];for(m=0;m<d;m++)b[8-d+m]=c[l*d+m]}this.keyMeshing&&this.keyMeshing(a,f,l)}if(0<g)for(q(!0,this.sBox,a,f),l=0;l<g;l++)c[e*d+l]^=b[l];return c.buffer}function Q(a,c,b){b=new Uint8Array(b||this.iv||y);c=this.padding(c);var d=new Int32Array(2),e=Math.floor(this.shiftBits/8)||8,g=c.length,f=g%e,g=(g-f)/e;a=new Int32Array(u(a));for(var l=new Int32Array(b.buffer),h=0;h<g;h++){if(8===
e){q(!0,this.sBox,a,l);var m=new Int32Array(c.buffer,h*e,2);d[0]=m[0];d[1]=m[1];m[0]^=l[0];m[1]^=l[1];l[0]=d[0];l[1]=d[1]}else{m=new Uint8Array(b);q(!0,this.sBox,a,l);for(var n=0;n<e;n++)m[n]=c[h*e+n],c[h*e+n]^=b[n];for(n=0;n<8-e;n++)b[n]=m[e+n];for(n=0;n<e;n++)b[8-e+n]=m[n]}this.keyMeshing&&this.keyMeshing(a,l,h)}if(0<f)for(q(!0,this.sBox,a,l),h=0;h<f;h++)c[g*e+h]^=b[h];return c.buffer}function L(a,c,b){b=new Uint8Array(b||this.iv||y);c=new this.padding(c);var d=new Int32Array(2),e=c.length,g=e%
8,e=(e-g)/8;a=new Int32Array(u(a));var f=new Int32Array(b.buffer);q(!0,this.sBox,a,f);for(var l=0;l<e;l++){var h=new Int32Array(c.buffer,8*l,2);f[0]=f[0]+16843009&4294967295;f[1]=v(K(f[1]+16843012&4294967295)%4294967295);d[0]=f[0];d[1]=f[1];q(!0,this.sBox,a,f);h[0]^=f[0];h[1]^=f[1];f[0]=d[0];f[1]=d[1];this.keyMeshing&&this.keyMeshing(a,f,l)}if(0<g)for(f[0]=f[0]+16843009&4294967295,f[1]=v(K(f[1]+16843012&4294967295)%4294967295),q(!0,this.sBox,a,f),l=0;l<g;l++)c[8*e+l]^=b[l];return c.buffer}function R(a,
c,b){b=new Uint8Array(b||this.iv||y);c=this.padding(c);a=new Int32Array(u(a));b=new Int32Array(b.buffer);for(var d=0,e=c.length/8;d<e;d++){var g=new Int32Array(c.buffer,8*d,2);b[0]^=g[0];b[1]^=g[1];q(!0,this.sBox,a,b);g[0]=b[0];g[1]=b[1];this.keyMeshing&&this.keyMeshing(a,b,d)}return c.buffer}function S(a,c,b){var d=new Uint8Array(b||this.iv||y);c=this.padding(c);b=new Int32Array(2);a=new Int32Array(u(a));for(var d=new Int32Array(d.buffer),e=0,g=c.length/8;e<g;e++){var f=new Int32Array(c.buffer,8*
e,2);b[0]=f[0];b[1]=f[1];q(!1,this.sBox,a,f);f[0]^=d[0];f[1]^=d[1];d[0]=b[0];d[1]=b[1];this.keyMeshing&&this.keyMeshing(a,d,e)}return c.buffer}function G(){var a=new Uint8Array(this.bitLength/8);B(a);return a.buffer}function z(a,c,b){b=new Uint8Array(b||this.iv||y);c=x(c);var d=c.length,e=d%8,d=(d-e)/8;a=new Int32Array(u(a));for(var g=new Int32Array(b.buffer),f=this.sBox,l=0;l<d;l++){var h=new Int32Array(c.buffer,8*l,2);g[0]^=h[0];g[1]^=h[1];for(h=0;8>h;h++)t(f,g,a[h]);for(h=0;8>h;h++)t(f,g,a[h]);
this.keyMeshing&&this.keyMeshing(a,g,h)}if(0<e){for(h=0;h<e;h++)b[h]^=c[8*d+h];for(h=0;8>h;h++)t(f,g,a[h]);for(h=0;8>h;h++)t(f,g,a[h])}c=Math.ceil(this.macLength/8)||4;e=new Uint8Array(c);e.set(new Uint8Array(b.buffer,4-c,c));return e.buffer}function A(a,c,b,d){a=new Uint8Array(z.call(this,a,b,d));c=new x(c);if(a.length!==c.length)return!1;b=0;for(d=a.length;b<d;b++)if(a[b]!==c[b])return!1;return!0}function T(a,c,b){b||(this.ukm?b=new Uint8Array(this.ukm):B(b=new Uint8Array(8)));var d=z.call(this,
a,c,b);a=D.call(this,a,c);c=new Uint8Array(44);c.set(new Uint8Array(b));c.set(new Uint8Array(a),8);c.set(new Uint8Array(d),40);return c.buffer}function U(a,c){var b=p(c);if(44!==b.byteLength)throw new s("Wrapping key size must be 44 bytes");var d=new Uint8Array(b,0,8),e=new Uint8Array(b,8,32),b=new Uint8Array(b,40,4),e=E.call(this,a,e);if(!A.call(this,a,b,e,d))throw new s("Error verify MAC of wrapping key");return e}function M(a,c){for(var b=u(a),d=[],e=0;8>e;e++){d[e]=[];for(var g=0;8>g;g++)d[e][g]=
c[e]>>>g&1}for(e=0;8>e;e++){for(var f=new Int32Array(2),g=0;8>g;g++)d[e][g]?f[0]=f[0]+b[g]&4294967295:f[1]=f[1]+b[g]&4294967295;g=new Uint8Array(f.buffer);b=J.call(this,b,b,g)}return b}function V(a,c,b){b||(this.ukm?b=new Uint8Array(this.ukm):B(b=new Uint8Array(8)));var d=M.call(this,a,b);a=z.call(this,a,c,b);c=D.call(this,d,c);d=new Uint8Array(44);d.set(new Uint8Array(b));d.set(new Uint8Array(c),8);d.set(new Uint8Array(a),40);return d.buffer}function W(a,c){var b=p(c);if(44!==b.byteLength)throw new s("Wrapping key size must be 44 bytes");
var d=new Uint8Array(b,0,8),e=new Uint8Array(b,8,32),b=new Uint8Array(b,40,4),g=M.call(this,a,d),e=E.call(this,g,e);if(!A.call(this,a,b,e,d))throw new s("Error verify MAC of wrapping key");return e}function N(a){var c=p(a);if(34!==(new Uint8Array(c,0,1))[0])throw new s("Invalid magic number");var b=(new Uint8Array(c,1,1))[0];a=new Uint8Array(c,2,4);for(var d=new Uint8Array(32),e=0;e<b;e++)for(var g=new Uint8Array(c,6+32*e,32),f=0;32>f;f++)d[f]^=g[f];c=new Uint8Array(32);b=A.call(this,d,a,c);if(!b)for(g=
"E-A E-B E-C E-D E-SC D-A D-SC D-TEST E-Z E-DEFAULT E-TEST".split(" "),e=0,f=g.length;e<f&&!(this.sBox=F[g[e]],b=A.call(this,d,a,c));e++);if(!b)throw new s("Invalid main key MAC");return d.buffer}function X(a,c){var b=p(a),d=p(c);32!==b.byteLength&&(b=N.call(this,b));var e=D.call(this,b,d),b=z.call(this,b,d),d=new Uint8Array(36);d.set(new Uint8Array(e),0);d.set(new Uint8Array(b),32);return d.buffer}function Y(a,c){var b=p(a),d=p(c);32!==b.byteLength&&(b=N.call(this,b));var e=new Uint8Array(d,0,32),
d=new Uint8Array(d,32,4),e=E.call(this,b,e);if(!A.call(this,b,d,e))throw new s("Invalid key MAC");return e}function Z(){var a=G.call(this),c=void 0,b=8,a=new Uint8Array(p(a));if(32!==a.byteLength)throw new s("Wrong cleartext size "+k.byteLength+" bytes");if(c)if(c=new Uint8Array(p(c)),0<c.byteLength&&0===c.byteLength%32)b=c.byteLength/32+1;else throw new s("Wrong rand size "+c.byteLength+" bytes");else B(c=new Uint8Array(32*(b-1)));var d=new Uint8Array(32*b+6),e=g.buffer,g=new Uint8Array(32),g=z.call(this,
a,g);d[0]=34;d[1]=b;d.set(g,2);d.set(c,38);for(c=1;c<b;c++)for(var g=new Uint8Array(e,6+32*c),f=0;32>f;f++)a[f]^=g[f];d.set(a,6);return d.buffer}function $(a,c,b){if(0===b%256){b=new Int32Array(E.call(this,a,aa));var d=new Int32Array(D.call(this,b,c));a.set(b);c.set(d)}}function O(a){var c=new Uint8Array(a.byteLength);c.set(x(a));return c}function ba(a){var c=a.byteLength,b=8-c%8,d=8*Math.ceil(c/8),e=new Uint8Array(d);e.set(x(a));for(a=c;a<d;a++)e[a]=b;return e}function P(a){var c=a.byteLength,b=
8*Math.ceil(c/8),d=new Uint8Array(b);d.set(x(a));for(a=c;a<b;a++)d[a]=0;return d}function ca(a){var c=a.byteLength,b=8-c%8,d=8*Math.ceil(c/8),d=new Uint8Array(d),c=new Uint8Array(d.buffer,c,b);d.set(x(a));B(c);return d}var w=this,I=w.crypto||w.msCrypto,H=w.SyntaxError||Error,s=w.DataError||Error,C=w.NotSupportedError||Error,da=function(){var a=new ArrayBuffer(2);(new DataView(a)).setInt16(0,256,!0);return 256===(new Int16Array(a))[0]}(),y=new Uint8Array([0,0,0,0,0,0,0,0]),F={"E-DEFAULT":[12,4,6,2,
10,5,11,9,14,8,13,7,0,3,15,1,6,8,2,3,9,10,5,12,1,14,4,7,11,13,0,15,11,3,5,8,2,15,10,13,14,1,7,4,12,9,6,0,12,8,2,1,13,4,15,6,7,0,10,5,3,14,9,11,7,15,5,10,8,1,6,13,0,9,3,14,11,4,2,12,5,13,15,6,9,2,12,10,11,7,8,1,4,3,14,0,8,14,2,5,6,9,1,12,15,4,11,0,13,10,3,7,1,7,14,13,0,5,8,3,4,15,10,6,9,12,11,2],"E-TEST":[4,2,15,5,9,1,0,8,14,3,11,12,13,7,10,6,12,9,15,14,8,1,3,10,2,7,4,13,6,0,11,5,13,8,14,12,7,3,9,10,1,5,2,4,6,15,0,11,14,9,11,2,5,15,7,1,0,13,12,6,10,4,3,8,3,14,5,9,6,8,0,13,10,11,7,12,2,1,15,4,8,15,
6,11,1,9,12,5,13,3,7,10,0,14,2,4,9,11,12,0,3,6,7,5,4,8,14,15,1,10,2,13,12,6,5,2,11,0,9,13,3,14,7,10,15,4,1,8],"E-A":[9,6,3,2,8,11,1,7,10,4,14,15,12,0,13,5,3,7,14,9,8,10,15,0,5,2,6,12,11,4,13,1,14,4,6,2,11,3,13,8,12,15,5,10,0,7,1,9,14,7,10,12,13,1,3,9,0,2,11,4,15,8,5,6,11,5,1,9,8,13,15,0,14,4,2,3,12,7,10,6,3,10,13,12,1,2,0,11,7,5,9,4,8,15,14,6,1,13,2,9,7,10,6,0,8,12,4,5,15,3,11,14,11,10,15,5,0,12,14,8,6,2,3,9,1,7,13,4],"E-B":[8,4,11,1,3,5,0,9,2,14,10,12,13,6,7,15,0,1,2,10,4,13,5,12,9,7,3,15,11,8,6,
14,14,12,0,10,9,2,13,11,7,5,8,15,3,6,1,4,7,5,0,13,11,6,1,2,3,10,12,15,4,14,9,8,2,7,12,15,9,5,10,11,1,4,0,13,6,8,14,3,8,3,2,6,4,13,14,11,12,1,7,15,10,0,9,5,5,2,10,11,9,1,12,3,7,4,13,0,6,15,8,14,0,4,11,14,8,3,7,1,10,2,9,6,15,13,5,12],"E-C":[1,11,12,2,9,13,0,15,4,5,8,14,10,7,6,3,0,1,7,13,11,4,5,2,8,14,15,12,9,10,6,3,8,2,5,0,4,9,15,10,3,7,12,13,6,14,1,11,3,6,0,1,5,13,10,8,11,2,9,7,14,15,12,4,8,13,11,0,4,5,1,2,9,3,12,14,6,15,10,7,12,9,11,1,8,14,2,4,7,3,6,5,10,0,15,13,10,9,6,8,13,14,2,0,15,3,5,11,4,1,12,
7,7,4,0,5,10,2,15,14,12,6,1,11,13,9,3,8],"E-D":[15,12,2,10,6,4,5,0,7,9,14,13,1,11,8,3,11,6,3,4,12,15,14,2,7,13,8,0,5,10,9,1,1,12,11,0,15,14,6,5,10,13,4,8,9,3,7,2,1,5,14,12,10,7,0,13,6,2,11,4,9,3,15,8,0,12,8,9,13,2,10,11,7,3,6,5,4,14,15,1,8,0,15,3,2,5,14,11,1,10,4,7,12,9,13,6,3,0,6,15,1,14,9,2,13,8,12,4,11,10,5,7,1,10,6,8,15,11,0,4,12,3,5,9,7,13,2,14],"E-SC":[3,6,1,0,5,7,13,9,4,11,8,12,14,15,2,10,7,1,5,2,8,11,9,12,13,0,3,10,15,14,4,6,15,1,4,6,12,8,9,2,14,3,7,10,11,13,5,0,3,4,15,12,5,9,14,0,6,8,7,10,
1,11,13,2,6,9,0,7,11,8,4,12,2,14,10,15,1,13,5,3,6,1,2,15,0,11,9,12,7,13,10,5,8,4,14,3,0,2,14,12,9,1,4,7,3,15,6,8,10,13,11,5,5,2,11,8,4,12,7,1,10,6,14,0,9,3,13,15],"E-Z":[1,8,5,7,12,11,6,12,7,14,13,15,8,3,8,4,14,2,15,5,2,5,2,6,13,5,6,10,1,8,3,2,0,6,9,8,13,2,9,10,5,9,2,1,4,15,10,5,8,1,12,6,15,10,5,11,3,12,10,13,6,13,12,9,4,15,11,0,7,14,1,14,15,4,7,9,0,1,14,8,10,11,8,3,10,7,4,13,6,0,1,14,5,4,7,7,9,13,4,11,3,12,11,0,12,10,3,4,14,9,13,3,11,3,14,2,9,6,0,15,2,7,0,12,11,0,15,1],"D-TEST":[4,10,9,2,13,8,0,
14,6,11,1,12,7,15,5,3,14,11,4,12,6,13,15,10,2,3,8,1,0,7,5,9,5,8,1,13,10,3,4,2,14,15,12,7,6,0,9,11,7,13,10,1,0,8,9,15,14,4,6,12,11,2,5,3,6,12,7,1,5,15,13,8,4,10,9,14,0,3,11,2,4,11,10,0,7,2,1,13,3,6,8,5,9,12,15,14,13,11,4,1,3,15,5,9,0,10,14,7,6,8,2,12,1,15,13,0,5,7,10,4,9,2,3,14,6,11,8,12],"D-A":[10,4,5,6,8,1,3,7,13,12,14,0,9,2,11,15,5,15,4,0,2,13,11,9,1,7,6,3,12,14,10,8,7,15,12,14,9,4,1,0,3,11,5,2,6,10,8,13,4,10,7,12,0,15,2,8,14,1,6,5,13,11,9,3,7,6,4,11,9,12,2,10,1,8,0,14,15,13,3,5,7,6,2,4,13,9,15,
0,10,1,5,11,8,14,12,3,13,14,4,1,7,0,5,10,3,12,8,15,6,2,9,11,1,3,10,9,5,11,4,15,8,6,7,14,13,0,2,12],"D-SC":[11,13,7,0,5,4,1,15,9,14,6,10,3,12,8,2,1,2,7,9,13,11,15,8,14,12,4,0,5,6,10,3,5,1,13,3,15,6,12,7,9,8,11,2,4,14,0,10,13,1,11,4,9,12,14,0,7,5,8,15,6,2,10,3,2,13,10,15,9,11,3,7,8,12,5,14,6,0,1,4,0,4,6,12,5,3,8,13,10,11,15,2,1,9,7,14,1,3,12,8,10,6,11,0,2,14,7,9,15,4,5,13,10,11,6,0,1,3,4,7,14,13,5,15,8,2,9,12]},aa=new Uint8Array([105,0,114,34,100,201,4,35,141,58,219,150,70,233,42,196,24,254,172,148,
0,237,7,18,192,134,220,194,239,76,169,43]);return function(a){if(!da)throw new C("Big endian platform not supported");a=a||{};this.bitLength=a.length||256;this.blockLength=this.bitLength/4;this.name=(a.name||"GOST 28147")+"-"+(a.version||1989)%100+"-"+("MAC"===a.mode?"MAC-"+(a.macLength||this.bitLength/8):"KW"===a.mode||a.keyWrapping?("NO"!==(a.keyWrapping||"NO")?a.keyWrapping:"")+"KW":(a.block||"ECB")+("CFB"===a.block?"-"+(a.shiftBits||this.blockLength):"")+(a.padding?"-"+(a.padding||("CNT"===a.block||
"CFB"===a.block?"NO":"ZERO"))+"PADDING":"")+("NO"!==(a.keyMeshing||"NO")?"-CPKEYMESHING":""))+("string"===typeof a.sBox?"/"+a.sBox:"");switch(a.version||1989){case 1989:break;default:throw new C("Algorithm version "+a.version+" not supported");}switch(a.mode||a.keyWrapping&&"KW"||"ES"){case "ES":switch(a.block||"ECB"){case "ECB":this.encrypt=D;this.decrypt=E;break;case "CNT":this.decrypt=this.encrypt=L;break;case "CBC":this.encrypt=R;this.decrypt=S;break;case "CFB":this.encrypt=J;this.decrypt=Q;this.shiftBits=
a.shiftBits||this.blockLength;break;default:throw new C("Block mode "+a.block+" not supported");}switch(a.keyMeshing){case "CP":this.keyMeshing=$}switch(a.padding){case "PKCS5P":this.padding=ba;break;case "ZERO":this.padding=P;break;case "RANDOM":this.padding=ca;break;default:this.padding=this.encrypt===J||this.encrypt===L?O:P}this.generateKey=G;break;case "MAC":this.sign=z;this.verify=A;this.generateKey=G;this.macLength=a.macLength||this.bitLength/8;break;case "KW":this.padding=O;switch(a.keyWrapping){case "CP":this.wrapKey=
V;this.unwrapKey=W;this.generateKey=G;break;case "SC":this.wrapKey=X;this.unwrapKey=Y;this.generateKey=Z;break;default:this.wrapKey=T,this.unwrapKey=U}break;default:throw new C("Mode "+a.mode+" not supported");}var c=a.sBox;if(!c)c=F["E-DEFAULT"];else if("string"===typeof c){if(c=c.toUpperCase(),c=F[c],!c)throw new H("Unknown sBox name: "+a.sBox);}else if(!c.length||c.length!==F["E-DEFAULT"].length)throw new H("Length of sBox must be "+F["E-DEFAULT"].length);this.sBox=c;if(a.iv&&(this.iv=new Uint8Array(a.iv),
this.iv.byteLength!==this.blockLength/8))throw new H("Length of iv must be "+this.blockLength+" bits");if(a.ukm&&(this.ukm=new Uint8Array(a.ukm),this.ukm.byteLength!==this.blockLength/8))throw new H("Length of ukm must be "+this.blockLength+" bits");}});
