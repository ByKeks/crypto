/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(u,t){"function"===typeof define&&define.amd?define(t):"object"===typeof exports?module.exports=t():u.gostCoding=t()})(this,function(){function u(c){if(c instanceof ArrayBuffer)return c;if(c&&c.buffer&&c.buffer instanceof ArrayBuffer)return 0===c.byteOffset&&c.byteLength===c.buffer.byteLength?c.buffer:(new Uint8Array(new Uint8Array(c,c.byteOffset,c.byteLength))).buffer;throw new (t.DataError||Error)("ArrayBuffer or TypedArray required");}var t=this,s={Base64:{decode:function(c){c=c.replace(/[^A-Za-z0-9\+\/]/g,
"");for(var p=c.length,q=3*p+1>>2,b=new Uint8Array(q),m,e=0,d=0,g=0;g<p;g++){m=g&3;var a=c.charCodeAt(g),a=64<a&&91>a?a-65:96<a&&123>a?a-71:47<a&&58>a?a+4:43===a?62:47===a?63:0,e=e|a<<18-6*m;if(3===m||1===p-g){for(m=0;3>m&&d<q;m++,d++)b[d]=e>>>(16>>>m&24)&255;e=0}}return b.buffer},encode:function(c){c=new Uint8Array(u(c));for(var p=2,q="",b=c.length,m=0,e=0;e<b;e++)if(p=e%3,0<e&&0===4*e/3%96&&(q+="\r\n"),m|=c[e]<<(16>>>p&24),2===p||1===b-e){for(var d=18;0<=d;d-=6)var g=m>>>d&63,g=26>g?g+65:52>g?g+
71:62>g?g-4:62===g?43:63===g?47:65,q=q+String.fromCharCode(g);m=0}return q.substr(0,q.length-2+p)+(2===p?"":1===p?"=":"==")}}};s.Chars=function(){var c={1026:128,1027:129,8218:130,1107:131,8222:132,8230:133,8224:134,8225:135,8364:136,8240:137,1033:138,8249:139,1034:140,1036:141,1035:142,1039:143,1106:144,8216:145,8217:146,8220:147,8221:148,8226:149,8211:150,8212:151,8482:153,1113:154,8250:155,1114:156,1116:157,1115:158,1119:159,160:160,1038:161,1118:162,1032:163,164:164,1168:165,166:166,167:167,1025:168,
169:169,1028:170,171:171,172:172,173:173,174:174,1031:175,176:176,177:177,1030:178,1110:179,1169:180,181:181,182:182,183:183,1105:184,8470:185,1108:186,187:187,1112:188,1029:189,1109:190,1111:191},p={},q;for(q in c)p[c[q]]=q;return{decode:function(b,m){m=(m||"win1251").toLowerCase().replace("-","");for(var e=[],d=0,g=b.length;d<g;d++){var a=b.charCodeAt(d);if("utf8"===m)128>a?e.push(a):(2048>a?e.push(192+(a>>>6)):(65536>a?e.push(224+(a>>>12)):(2097152>a?e.push(240+(a>>>18)):(67108864>a?e.push(248+
(a>>>24)):(e.push(252+(a>>>30)),e.push(128+(a>>>24&63))),e.push(128+(a>>>18&63))),e.push(128+(a>>>12&63))),e.push(128+(a>>>6&63))),e.push(128+(a&63)));else if("unicode"===m||"ucs2"===m||"utf16"===m)if(55296>a||57344<=a&&65536>=a)e.push(a>>>8),e.push(a&255);else{if(65536<=a&&1114112>a){var a=a-65536,f=((1047552&a)>>10)+55296,a=(1023&a)+56320;e.push(f>>>8);e.push(f&255);e.push(a>>>8);e.push(a&255)}}else"utf32"===m||"ucs4"===m?(e.push(a>>>24&255),e.push(a>>>16&255),e.push(a>>>8&255),e.push(a&255)):"win1251"===
m?(128<=a&&(a=1040<=a&&1104>a?a-848:c[a]||0),e.push(a)):e.push(a&255)}return(new Uint8Array(e)).buffer},encode:function(b,c){c=(c||"win1251").toLowerCase().replace("-","");for(var e=[],d=new Uint8Array(u(b)),g=0,a=d.length;g<a;g++){var f=d[g];if("utf8"===c)f=252<=f&&254>f&&g+5<a?1073741824*(f-252)+(d[++g]-128<<24)+(d[++g]-128<<18)+(d[++g]-128<<12)+(d[++g]-128<<6)+d[++g]-128:f>>248&&252>f&&g+4<a?(f-248<<24)+(d[++g]-128<<18)+(d[++g]-128<<12)+(d[++g]-128<<6)+d[++g]-128:f>>240&&248>f&&g+3<a?(f-240<<18)+
(d[++g]-128<<12)+(d[++g]-128<<6)+d[++g]-128:224<=f&&240>f&&g+2<a?(f-224<<12)+(d[++g]-128<<6)+d[++g]-128:192<=f&&224>f&&g+1<a?(f-192<<6)+d[++g]-128:f;else if("unicode"===c||"ucs2"===c||"utf16"===c){if(f=(f<<8)+d[++g],55296<=f&&57344>f)var k=f-55296<<10,f=d[++g],f=(f<<8)+d[++g],f=k+(f-56320)+65536}else"utf32"===c||"ucs4"===c?(f=(f<<8)+d[++g],f=(f<<8)+d[++g],f=(f<<8)+d[++g]):"win1251"===c&&128<=f&&(f=192<=f&&256>f?f+848:p[f]||0);e.push(String.fromCharCode(f))}return e.join("")}}}();s.Hex={decode:function(c,
p){c=c.replace(/[^A-fa-f0-9]/g,"");var q=Math.ceil(c.length/2),b=new Uint8Array(q);c=(0<c.length%2?"0":"")+c;if(p&&("string"!==typeof p||0>p.toLowerCase().indexOf("little")))for(var m=0;m<q;m++)b[m]=parseInt(c.substr(2*(q-m-1),2),16);else for(m=0;m<q;m++)b[m]=parseInt(c.substr(2*m,2),16);return b.buffer},encode:function(c,p){var q=[],b=new Uint8Array(u(c)),m=b.length;if(p&&("string"!==typeof p||0>p.toLowerCase().indexOf("little")))for(var e=0;e<m;e++){var d=m-e-1;q[d]=(0<d&&0===d%32?"\r\n":"")+("00"+
b[e].toString(16)).slice(-2)}else for(e=0;e<m;e++)q[e]=(0<e&&0===e%32?"\r\n":"")+("00"+b[e].toString(16)).slice(-2);return q.join("")}};s.Int16={decode:function(c){c=(c||"").replace(/[^\-A-fa-f0-9]/g,"");0===c.length&&(c="0");var p=!1;"-"===c.charAt(0)&&(p=!0,c=c.substring(1));for(;"0"===c.charAt(0)&&1<c.length;)c=c.substring(1);c=(0<c.length%2?"0":"")+c;if(!p&&!/^[0-7]/.test(c)||p&&!/^[0-7]|8[0]+$/.test(c))c="00"+c;for(var q=c.length/2,b=new Uint8Array(q),m=0,q=q-1;0<=q;--q){var e=parseInt(c.substr(2*
q,2),16);p&&0<e+m&&(e=256-e-m,m=1);b[q]=e}return b.buffer},encode:function(c){c=new Uint8Array(u(c));if(0===c.length)return"0x00";for(var p=[],q=127<c[0],b=0,m=c.length-1;0<=m;--m){var e=c[m];q&&0<e+b&&(e=256-e-b,b=1);p[m]=("00"+e.toString(16)).slice(-2)}for(p=p.join("");"0"===p.charAt(0);)p=p.substring(1);return(q?"-":"")+"0x"+p}};s.BER=function(){function c(b,m){"undefined"===typeof b||null===b?b=new String(""):"string"===typeof b?b=new String(b):"number"===typeof b?b=new Number(b):"boolean"===
typeof b&&(b=new Boolean(b));var e=b.tagClass=b.tagClass||0,d;0===e&&(d=b.tagNumber);if("undefined"===typeof d)if(b instanceof String)d=0===e?""===b.toString()?5:/^\-?0x[0-9a-fA-F]+$/.test(b)?2:/^(\d+\.)+\d+$/.test(b)?6:/^[01]+$/.test(b)?3:/^(true|false)$/.test(b)?1:/^[0-9a-fA-F]+$/.test(b)?4:19:/^[0-9a-fA-F]+$/.test(b)?4:19;else if(b instanceof Number)d=2;else if(b instanceof Date)d=24;else if(b instanceof Boolean)d=1;else if(b instanceof Array)d=16;else if(b instanceof ArrayBuffer||b.buffer instanceof
ArrayBuffer)d=4;else throw new (t.DataError||Error)("Unrecognized type for "+b);var g=b.tagConstructed;"undefined"===typeof g&&(g=b.tagConstructed=b instanceof Array);var a;if(b instanceof ArrayBuffer||b.buffer instanceof ArrayBuffer){if(a=new Uint8Array(u(b)),3===d){var f=new Uint8Array(u(a));a=new Uint8Array(f.length+1);a[0]=0;a.set(f,1)}}else if(g)if(b instanceof Array){a=0;for(var k=[],h=f=0,n=b.length;h<n;h++)k[h]=c(b[h],m),a+=k[h].length;g&&"CER"===m&&(k[n]=new Uint8Array(2),a+=2);a=new Uint8Array(a);
h=0;for(n=k.length;h<n;h++)a.set(k[h],f),f+=k[h].length}else throw new (t.DataError||Error)("Constracted block can't be primitive");else switch(d){case 1:a=new Uint8Array(1);a[0]="true"===b.toString()?1:0;break;case 2:case 10:a=s.Int16.decode(b instanceof Number?"0x"+b.toString(16):b.toString());break;case 3:if("string"===typeof b||b instanceof String)for(h=7-(b.length+7)%8,n=Math.ceil(b.length/8),a=new Uint8Array(n+1),a[0]=h,h=0;h<n;h++){for(k=f=0;8>k;k++)var l=8*h+k,f=(f<<1)+(l<b.length?"1"===b.charAt(l)?
1:0:0);a[h+1]=f}break;case 4:a=s.Hex.decode(b instanceof Number?b.toString(16):b);break;case 6:f=b.match(/\d+/g);a=[];for(h=1;h<f.length;h++){n=+f[h];l=[];1===h&&(n+=40*f[0]);do l.push(n&127),n>>>=7;while(n);for(k=l.length-1;0<=k;--k)a.push(l[k]+(0===k?0:128))}a=new Uint8Array(a);break;case 12:a=s.Chars.decode(b,"utf8");break;case 18:case 22:case 19:case 20:case 21:case 25:case 26:case 27:h=0;for(n=b.length;h<n;h++)255<b.charCodeAt(h)&&(d=12);a=12===d?s.Chars.decode(b,"utf8"):s.Chars.decode(b,"ascii");
break;case 23:case 24:a=new Date(b);a.setMinutes(a.getMinutes()+a.getTimezoneOffset());a=(23===d?a.getYear().toString().slice(-2):a.getFullYear().toString())+("00"+(a.getMonth()+1)).slice(-2)+("00"+a.getDate()).slice(-2)+("00"+a.getHours()).slice(-2)+("00"+a.getMinutes()).slice(-2)+("00"+a.getSeconds()).slice(-2)+"Z";a=s.Chars.decode(a,"ascii");break;case 28:a=s.Chars.decode(b,"utf32");break;case 30:a=s.Chars.decode(b,"utf16")}a||(a=new Uint8Array(0));a instanceof ArrayBuffer&&(a=new Uint8Array(a));
b.tagNumber=0===e?d:d=b.tagNumber||0;b.content=a;h=[];n=3===e?192:2===e?128:1===e?64:0;g&&(n|=32);if(31>d)h.push(n|d&31);else{n|=31;h.push(n);n=d;f=[];do f.push(n&127),n>>>=7;while(n);for(k=f.length-1;0<=k;--k)h.push(f[k]+(0===k?0:128))}if(g&&"CER"===m)h.push(128);else if(g=a.length,127<g){n=g;g=[];do g.push(n&255),n>>>=8;while(n);h.push(g.length+128);for(k=g.length-1;0<=k;--k)h.push(g[k])}else h.push(g);g=b.header=new Uint8Array(h);b.typeName=1===e?"Application_"+d:2===e?"["+d.toString()+"]":3===
e?"Private_"+d:q[d]||"Universal_"+d.toString();e=new Uint8Array(g.length+a.length);e.set(g,0);e.set(a,g.length);return e}function p(b,c){var e=c||0,d=b[e++],g=d>>6,a=0!==(d&32),f=d&31;if(31===f){f=0;do{if(9007199254740864<f)throw new (t.DataError||Error)("Convertor not supported tag number more then (2^53 - 1) at position "+c);d=b[e++];f=(f<<7)+(d&127)}while(d&128)}var d=b[e++],k=d&127;if(k!==d){if(6<k)throw new (t.DataError||Error)("Length over 48 bits not supported at position "+c);if(0===k)k=null;
else{for(var h=d=0;h<k;++h)d=(d<<8)+b[e++];k=d}}var n=e,h=null;if(a)if(h=[],null!==k){for(d=n+k;e<d;){var l=p(b,e);h.push(l);e+=l.header.length+l.content.length}if(e!==d)throw new (t.DataError||Error)("Content size is not correct for container starting at offset "+n);}else try{for(;;){l=p(b,e);e+=l.header.length+l.content.length;if(0===l.tagClass&&0===l.tagNumber)break;h.push(l)}k=e-n}catch(u){throw new (t.DataError||Error)("Exception "+u+" while decoding undefined length content at offset "+n);}l=
new String("");e=new Uint8Array(b.buffer,c,n-c);d=new Uint8Array(b.buffer,n,k);if(null===h){if(null===k)throw new (t.DataError||Error)("Invalid tag with undefined length at offset "+n);if(0===g)switch(f){case 1:l=new Boolean(0!==b[n]);break;case 2:case 10:if(6<k)l=new String(s.Int16.encode(d));else{var r=d[0];127<d[0]&&(r-=256);for(h=1;h<k;h++)r=256*r+d[h];l=new Number(r)}break;case 3:if(5<k)l=(new Uint8Array(d.subarray(1))).buffer;else{n=d[0];l=[];for(h=k-1;1<=h;--h){for(k=d[h];8>n;++n)l.push(k>>
n&1?"1":"0");n=0}l=new String(l.reverse().join(""))}break;case 4:l=(new Uint8Array(d)).buffer;break;case 6:for(var l="",v=0,w=0,h=0;h<k;++h)r=d[h],v=(v<<7)+(r&127),w+=7,r&128||(""===l?(r=80>v?40>v?0:1:2,l=r+"."+(v-40*r)):l+="."+v.toString(),w=v=0);if(0<w)throw new (t.DataError||Error)("Incompleted OID at offset "+n);l=new String(l);break;case 16:case 17:l=[];break;case 12:l=new String(s.Chars.encode(d,"utf8"));break;case 18:case 19:case 20:case 21:case 22:case 25:case 26:case 27:l=new String(s.Chars.encode(d,
"ascii"));break;case 28:l=new String(s.Chars.encode(d,"utf32"));break;case 30:l=new String(s.Chars.encode(d,"utf16"));break;case 23:case 24:k=23===f;l=s.Chars.encode(d,"ascii");r=(k?/^(\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/:/^(\d\d\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/).exec(l);if(!r)throw new (t.DataError||
Error)('Unrecognized time format "'+l+'" at offset '+n);k&&(r[1]=+r[1],r[1]+=70>r[1]?2E3:1900);l=new Date(r[1],+r[2]-1,+r[3],+(r[4]||0),+(r[5]||0),+(r[6]||0),+(r[7]||0));k=l.getTimezoneOffset();if(r[8]||23===f)"Z"!==r[8].toUpperCase()&&r[9]&&(k+=parseInt(r[9])),l.setMinutes(l.getMinutes()-k)}else l=(new Uint8Array(d)).buffer}else l=h;k=1===g?"Application_"+f:2===g?"["+f.toString()+"]":3===g?"Private_"+f:q[f]||"Universal_"+f.toString();l.tagConstructed=a;l.tagClass=g;l.tagNumber=f;l.header=e;l.content=
d;l.typeName=k;return l}var q={0:"EOC",1:"BOOLEAN",2:"INTEGER",3:"BIT STRING",4:"OCTET STRING",5:"NULL",6:"OBJECT IDENTIFIER",7:"ObjectDescriptor",8:"EXTERNAL",9:"REAL",10:"ENUMERATED",11:"EMBEDDED PDV",12:"UTF8String",16:"SEQUENCE",17:"SET",18:"NumericString",19:"PrintableString",20:"TeletexString",21:"VideotexString",22:"IA5String",23:"UTCTime",24:"GeneralizedTime",25:"GraphicString",26:"VisibleString",27:"GeneralString",28:"UniversalString",30:"BMPString"};return{encode:function(b,m){return c(b,
m).buffer},decode:function(b){return p(new Uint8Array(u(b)),0)}}}();s.PEM={encode:function(c,p){return(p?"-----BEGIN "+p.toUpperCase()+"-----\r\n":"")+s.Base64.encode(c instanceof ArrayBuffer?c:s.BER.encode(c))+(p?"\r\n-----END "+p.toUpperCase()+"-----":"")},decode:function(c,p,q){var b=/([A-Za-z0-9\+\/\s\=]+)/g.exec(c);b[1].length!==c.length&&(b=!1);!b&&p&&(b=(new RegExp("-----\\s?BEGIN "+p.toUpperCase()+"-----([A-Za-z0-9\\+\\/\\s\\=]+)-----\\s?END "+p.toUpperCase()+"-----","g")).exec(c));b||(b=
RegExp("-----\\s?BEGIN [A-Z0-9\\s]+-----([A-Za-z0-9\\+\\/\\s\\=]+)-----\\s?END [A-Z0-9\\s]+-----","g").exec(c));if(b)c=b[1];else throw new (t.DataError||Error)("Not valid PEM format");c=s.Base64.decode(c);q&&(c=s.BER.decode(c));return c}};return s});
