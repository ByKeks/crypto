/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(n,p){"function"===typeof define&&define.amd?define(["gostCrypto","gostASN1","gostCert","gostCMS"],p):"object"===typeof exports?module.exports=p(require("gostCrypto"),require("gostASN1"),require("gostCert"),require("gostCMS")):n.GostKeys=p(n.gostCrypto,n.GostASN1,n.GostCert,n.GostCMS)})(this,function(n){function p(a){for(var b=1,c=arguments.length;b<c;b++){var e=arguments[b];if("object"===typeof e)for(var d in e)e.hasOwnProperty(d)&&(a[d]=e[d])}return a}function E(a,b,c){for(var e in b){var d=
a,f=e,g=b[e];"object"!==typeof g&&(g={value:g});void 0!==c&&(g.enumerable=c);y.defineProperty(d,f,g)}}function w(a,b,c,e){"function"!==typeof b&&(e=c,c=b,b=function(){a.apply(this,arguments)});b.prototype=y.create(a.prototype,{constructor:{value:b},superclass:{value:a.prototype}});c&&E(b.prototype,c,!0);if(a!==y)for(var d in a)b[d]=a[d];b.super=a;e&&E(b,e,!0);return b}function F(a){a=new Uint8Array(a);n.getRandomValues(a);return a.buffer}function l(a){try{a()}catch(b){}}function J(a){var b=new N;
a&&b.setDate(b.getDate()+a);return b}function z(a,b){var c=new Uint8Array(a),e=new Uint8Array(b);if(c.length!==e.length)return!1;for(var d=0,f=c.length;d<f;d++)if(c[d]!==e[d])return!1;return!0}function O(a){switch(a.id){case "pbewithSHAAnd40BitRC2-CBC":case "pbeWithSHAAnd128BitRC2-CBC":return 8;case "pbeUnknownGost":return 16;case "sha1":return 20;default:return 32}}function G(a,b){if(!b)return new P(0);if(0<=a.name.indexOf("CPKDF")){for(var c=[],e=0;e<b.length;e++){var d=b.charCodeAt(e);c.push(d&
255);c.push(d>>>8&255);c.push(0);c.push(0)}return(new Uint8Array(c)).buffer}return 0<=a.name.indexOf("PFXKDF")?C.Chars.decode(b+"\x00","unicode"):C.Chars.decode(b,"utf8")}function u(){}function x(a){h.PrivateKeyInfo.call(this,a)}function K(a){h.EncryptedPrivateKeyInfo.call(this,a)}function D(a){if(a){var b=this;["mk.db3","masks.db3","kek.opq","rand.opq"].forEach(function(c){b[c]=a[c]})}}function H(a,b){h.GostWrappedPrivateKey.call(this,a);D.call(this,b)}function L(a){a&&(this.header=h.GostKeyContainer.decode(a.header),
this.name=h.GostKeyContainerName.decode(a.name),this.primary=h.GostPrivateKeys.decode(a.primary),this.masks=h.GostPrivateMasks.decode(a.masks),a.primary2&&a.masks2&&(this.primary2=h.GostPrivateKeys.decode(a.primary2),this.masks2=h.GostPrivateMasks.decode(a.masks2)))}function M(a){h.PFX.call(this,a||{vesion:3,authSafe:{contentType:"data"}})}var k=this.Promise,y=this.Object,P=this.ArrayBuffer,N=this.Date,f=n.subtle,h=n.asn1,C=n.coding,q=n.security.providers,r=n.cert,A=n.cms,B={providerName:"CP-01",
days:7305};u.prototype.options=B;w(h.PrivateKeyInfo,x,{getPrivateKey:function(){var a="rsaEncryption"===this.privateKeyAlgorithm.id?["sign"]:["sign","deriveKey","deriveBits"];return f.importKey("pkcs8",this.encode(),this.privateKeyAlgorithm,"true",a)},setPrivateKey:function(a){var b=this;return f.exportKey("pkcs8",a).then(function(a){h.PrivateKeyInfo.call(b,a);return b})},generate:function(a,b){var c=this;return(new k(l)).then(function(){a instanceof r.Request||(a=new r.Request(a));return a.generate(b)}).then(function(b){h.PrivateKeyInfo.call(c,
b);return a})}});u.prototype.PKCS8=x;w(h.EncryptedPrivateKeyInfo,K,{getKey:function(a){var b=this,c;return(new k(l)).then(function(){c=new A.EncryptedDataContentInfo({contentType:"encryptedData",version:0,encryptedContentInfo:{contentType:"data",contentEncryptionAlgorithm:b.encryptionAlgorithm,encryptedContent:b.encryptedData}});return c.getEnclosed(a)}).then(function(a){return x.decode(a.content)})},getPrivateKey:function(a){return this.getKey(a).then(function(a){return a.getPrivateKey()})},setKey:function(a,
b,c){var e=this,d;return(new k(l)).then(function(){a=new x(a);d=new A.EncryptedDataContentInfo;return d.encloseContent(b,a.encode(),c||B.providerName)}).then(function(){e.encryptionAlgorithm=d.encryptedContentInfo.contentEncryptionAlgorithm;e.encryptedData=d.encryptedContentInfo.encryptedContent;return e})},setPrivateKey:function(a,b,c){var e=this;return(new x).setPrivateKey(a).then(function(a){return e.setKey(a,b,c)})},generate:function(a,b,c,e){var d=this;return(new k(l)).then(function(){a instanceof
r.Request||(a=new r.Request(a));return a.generate(c)}).then(function(a){return d.setKey(a,b,e)}).then(function(){return a})}});u.prototype.PKCS8Encrypted=K;w(y,D,{getEncryptionKey:function(a){var b=q["SC-01"].wrapping,c=q["SC-01"].encryption,e=q["SC-01"].derivation,d=this["masks.db3"],v=this["mk.db3"],g=this["kek.opq"];return(new k(l)).then(function(){if(!d||!v||!g)throw Error("Not enougth key container files");if(32<d.byteLength){if(a)return f.importKey("raw",C.Chars.decode(a),e,!1,["deriveKey",
"deriveBits"]).then(function(a){return f.deriveKey(p(e,{salt:new Uint8Array([0,0,0,0,0,0,0,0])}),a,c,!1,["decrypt"])}).then(function(a){return(new A.EncryptedDataContentInfo(d)).getEnclosed(a)}).then(function(a){return a.verify()}).then(function(a){return a.content});throw Error("Key password is required");}if(a)throw Error("Key password is not required");return d}).then(function(a){d=a;a=new Uint8Array(v.byteLength+d.byteLength);a.set(new Uint8Array(v),0);a.set(new Uint8Array(d),v.byteLength);return f.importKey("raw",
a.buffer,b,!1,["unwrapKey"])}).then(function(a){return f.unwrapKey("raw",g,a,b,c,!1,["wrapKey","unwrapKey"])})},generateContainer:function(a){var b=this,c=q["SC-01"].wrapping,e=q["SC-01"].encryption,d=q["SC-01"].derivation,v=q["SC-01"].digest,g,h;return(new k(l)).then(function(){return f.generateKey(c,!0,["wrapKey"])}).then(function(c){h=c;c=h.buffer.byteLength;b["mk.db3"]=(new Uint8Array(new Uint8Array(h.buffer,0,c-32))).buffer;c=(new Uint8Array(new Uint8Array(h.buffer,c-32,32))).buffer;if(a){var g=
new A.EncryptedDataContentInfo,k=new A.DigestedDataContentInfo;return k.encloseContent(c,v).then(function(){k={contentType:"digestedData",content:k.encode()};return f.importKey("raw",C.Chars.decode(a),d,!1,["deriveKey","deriveBits"])}).then(function(a){return f.deriveKey(p(d,{salt:new Uint8Array([0,0,0,0,0,0,0,0])}),a,e,!1,["encrypt"])}).then(function(a){return g.encloseContent(k,a,e)}).then(function(){return g.encode()})}return c}).then(function(a){b["masks.db3"]=a;return f.generateKey(e,!1,["wrapKey",
"unwrapKey"])}).then(function(a){g=a;return f.wrapKey("raw",a,h,c)}).then(function(a){b["kek.opq"]=a;return f.generateKey(e,!1,["wrapKey","unwrapKey"])}).then(function(a){return f.wrapKey("raw",a,h,c)}).then(function(a){b["rand.opq"]=a;return g})}});u.prototype.SignalComKeyContainer=D;w(h.GostWrappedPrivateKey,H,{getKey:function(a){return this.getPrivateKey(a).then(function(a){return(new x).setPrivateKey(a)})},getPrivateKey:function(a){var b=this,c=q["SC-01"].wrapping,e;return(new k(l)).then(function(){return b.getEncryptionKey(a,
!0)}).then(function(a){return f.unwrapKey("raw",b.privateKeyWrapped,a,c,b.privateKeyAlgorithm,!0,["sign","deriveKey","deriveBits"])}).then(function(a){return(e=b.attributes&&b.attributes["id-sc-gostR3410-2001-publicKey"])?f.generateKey(p(a.algorithm,{ukm:a.buffer}),a.extractable,a.usages):{privateKey:a}}).then(function(a){if(e&&!z(a.publicKey.buffer,e))throw Error("Check public key failed");return a.privateKey})},setKey:function(a,b){var c=this;return(new x(a)).getPrivateKey().then(function(a){return c.setPrivateKey(a,
b)})},setPrivateKey:function(a,b){var c=this,e=q["SC-01"].wrapping,d;return(new k(l)).then(function(){return c.getEncryptionKey(b)["catch"](function(){return c.generateContainer(b)})}).then(function(b){return f.wrapKey("raw",a,b,e)}).then(function(b){d=b;return f.generateKey(p(a.algorithm,{ukm:a.buffer}),!0,["sign","verify"])}).then(function(b){c.object={version:0,privateKeyAlgorithm:a.algorithm,privateKeyWrapped:d,attributes:{"id-sc-gostR3410-2001-publicKey":b.publicKey.buffer}};return c})},changePassword:function(a,
b){var c=this;return c.getPrivateKey(a).then(function(a){return c.setPrivateKey(a,b)})},generate:function(a,b,c){var e=this,d;return(new k(l)).then(function(){a instanceof r.Request||(a=new r.Request(a));return a.generate(c)}).then(function(a){d=a;return e.setKey(d,b)}).then(function(){return a})}});E(H.prototype,D.prototype);u.prototype.SignalComPrivateKeyInfo=H;w(y,L,function(){function a(a){return 0<=a.name.indexOf("-512")||512===a.length}function b(a){return!(0<=a.name.indexOf("-94")||0<=a.name.indexOf("-2001")||
1994===a.version||2001===a.version)}function c(a,c,I){var d={name:"CPKDF",hash:b(a)?"GOST R 34.11-256":"GOST R 34.11-94/"+(a.sBox||"D-A"),salt:I,iterations:c?2E3:2};return f.importKey("raw",G(d,c),d,!1,["deriveKey","deriveBits"]).then(function(a){return f.deriveKey(d,a,"GOST 28147",!1,["sign","verify","encrypt","decrypt"])})}function e(a,b,I){var d=p({name:"GOST 28147-MAC"},a.encParams);return c(a,b,I).then(function(a){return f.sign(d,a,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]))})}function d(a,
b){var c=p({name:"GOST 28147-MAC"},a.encParams),d=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);return f.importKey("raw",d,c,!1,["sign"]).then(function(a){return f.sign(c,a,b.encode())})}function v(a,b,c){var d=p({name:"GOST 28147-MAC"},a.encParams);a=64===b.byteLength?(new Uint8Array(new Uint8Array(b,32,32))).buffer:b;return f.importKey("raw",a,d,!1,["sign"]).then(function(a){return f.sign(d,a,c)})}function g(b){var c=F(a(b)?64:32),d=F(12);return v(b,c,d).then(function(a){return new h.GostPrivateMasks({mask:c,
randomStatus:d,hmacRandom:a})})}function n(a){return f.generateKey(p(a.algorithm,{ukm:a.buffer}),!0,["sign","verify"]).then(function(a){return(new Uint8Array(new Uint8Array(a.publicKey.buffer,0,8))).buffer})}function q(a,b,c,d,e){var m={name:"GOST 28147-ECB",sBox:a.encParams&&a.encParams.sBox},t=p(a,{mode:"KW"}),g;t.name=t.name.replace("-DH","");var h;return f.decrypt(m,b,c).then(function(a){h=a;return f.importKey("raw",d,t,"false",["sign","unwrapKey"])}).then(function(b){return f.unwrapKey("raw",
h,b,t,a,"true",["sign"])}).then(function(a){g=a;return n(g)}).then(function(a){if(!z(a,e))throw Error("Incorrect fp");return g})}function u(a,b,c,d){var e={name:"GOST 28147-ECB",sBox:a.encParams&&a.encParams.sBox},m=p(a,{mode:"KW"});m.name=m.name.replace("-DH","");return f.importKey("raw",d,m,!1,["sign","wrapKey"]).then(function(a){return f.wrapKey("raw",c,a,m)}).then(function(a){return f.encrypt(e,b,a)})}function w(a,b,d,e,s){var f=a.primaryPrivateKeyParameters.privateKeyAlgorithm;return(new k(l)).then(function(){if(b.hmacKey)throw Error("Old key format");
if(12>d.randomStatus.byteLength)throw Error("Invalid random status length");return v(f,d.mask,d.randomStatus)}).then(function(a){if(!z(a,d.hmacRandom))throw Error("Imita for mask is invalid");return c(f,e,new Uint8Array(d.randomStatus,0,12))}).then(function(c){return s&&b.secondaryKey?q(a.secondaryPrivateKeyParameters.privateKeyAlgorithm,c,b.secondaryKey,d.mask,a.secondaryFP):q(f,c,b.primaryKey,d.mask,a.primaryFP)})}function y(a,b,d,e,f,g){return c(a,e,new Uint8Array(d.randomStatus,0,12)).then(function(b){return u(a,
b,g,d.mask)}).then(function(a){b||(b=new h.GostPrivateKeys);f?b.secondaryKey=a:b.primaryKey=a;return b})}return{getKey:function(a,b){return this.getPrivateKey(a,b).then(function(a){return(new x).setPrivateKey(a)})},getPrivateKey:function(a,b){var c=this,d=c.header.keyContainerContent;return w(d,c.primary,c.masks,a,b)["catch"](function(e){if(c.primary2&&c.masks2)return w(d,c.primary2,c.masks2,a,b);throw e;})},getCertificate:function(a){var b=this.header.keyContainerContent;return(new k(l)).then(function(){return a?
new r.X509(b.secondaryCertificate):new r.X509(b.primaryCertificate)})},getContainerName:function(){return this.name.containerName},setKey:function(a,b,c,d){var e=this;return(new x(a)).getPrivateKey().then(function(a){return e.setPrivateKey(a,b,c,d)})},setPrivateKey:function(a,b,c,f){var s=this,m,t;return(new k(l)).then(function(){s.header=s.header||new h.GostKeyContainer({keyContainerContent:{containerAlgoritmIdentifier:{algorithm:"id-CryptoPro-GostPrivateKeys-V2-Full"},attributes:["kccaReservePrimary",
"kccaPrimaryKeyAbsent"],extensions:{keyValidity:{notAfter:J(f||B.days)}}}});m=s.header.keyContainerContent;var b=c?m.secondaryPrivateKeyParameters:m.primaryPrivateKeyParameters;if(b)t=b.privateKeyAlgorithm;else if(t=p(a.algorithm,{sBox:"D-A",encParams:{block:"CFB",sBox:"E-A",keyMeshing:"CP"}}),b={attributes:["pkaExportable","pkaExchange","pkaDhAllowed"],privateKeyAlgorithm:t},c){if(!m.primaryPrivateKeyParameters)throw Error("Primary key must be defined first");m.secondaryPrivateKeyParameters=b}else m.primaryPrivateKeyParameters=
b,b=m.attributes.indexOf("kccaPrimaryKeyAbsent"),0<=b&&m.attributes.splice(b,1);var d=[];[0,1].forEach(function(a){var b="masks"+(0<a?"2":"");s[b]||d.push(g(t).then(function(a){s[b]=a}))});return k.all(d)}).then(function(){var d=[];[0,1].forEach(function(e){var f="primary"+(0<e?"2":"");d.push(y(t,s[f],s["masks"+(0<e?"2":"")],b,c,a).then(function(a){s[f]=a}))});return k.all(d)}).then(function(){return n(a).then(function(a){c?m.secondaryFP=a:m.primaryFP=a})}).then(function(){var a=m.attributes.indexOf("kccaSoftPassword");
if(b)return 0>a&&m.attributes.push("kccaSoftPassword"),e(t,b,m.primaryFP);0<=a&&m.attributes.splice(a,1)}).then(function(a){a&&(m.hmacPassword=a);return d(t,m)}).then(function(a){s.header.hmacKeyContainerContent=a;return s})},setCertificate:function(a,b,c){var e=this,f,g;return(new k(l)).then(function(){e.header=e.header||new h.GostKeyContainer({keyContainerContent:{containerAlgoritmIdentifier:{algorithm:"id-CryptoPro-GostPrivateKeys-V2-Full"},attributes:["kccaReservePrimary","kccaPrimaryKeyAbsent"],
extensions:{keyValidity:{notAfter:J(c||B.days)}}}});f=e.header.keyContainerContent;a=new r.X509(a);g=f.primaryPrivateKeyParameters&&f.primaryPrivateKeyParameters.privateKeyAlgorithm||p(a.subjectPublicKeyInfo.algorithm,{sBox:"D-A",encParams:{block:"CFB",sBox:"E-A",keyMeshing:"CP"}});return a.getPublicKey()}).then(function(c){if(b){if(f.secondaryFP&&!z(f.secondaryFP,new Uint8Array(c.buffer,0,f.secondaryFP.byteLength)))throw Error("The public key of the certificate does not match the private key");f.secondaryCertificate=
a}else{if(f.primaryFP&&!z(f.primaryFP,new Uint8Array(c.buffer,0,f.primaryFP.byteLength)))throw Error("The public key of the certificate does not match the private key");f.primaryCertificate=a}return d(g,f)}).then(function(a){e.header.hmacKeyContainerContent=a;return e})},setContainerName:function(a){this.name=new h.GostKeyContainerName({containerName:a})},verify:function(a){var b=this,c,f;return(new k(l)).then(function(){c=b.header.keyContainerContent;f=c.primaryPrivateKeyParameters.privateKeyAlgorithm;
return d(f,c)}).then(function(d){if(!z(d,b.header.hmacKeyContainerContent))throw Error("Container is not valid.");d=0<=c.attributes.indexOf("kccaSoftPassword");if(!a&&d)throw Error("Password is required");if(a&&!d)throw Error("Password is not reqiured.");return a?e(f,a,c.primaryFP).then(function(a){if(!z(a,c.hmacPassword))throw Error("Password is not valid.");return b}):b})},changePassword:function(a,b){var c=this,d;return(new k(l)).then(function(){d=c.header.keyContainerContent;if(!d.primaryPrivateKeyParameters)throw Error("Private key not yet defined");
return c.getPrivateKey(a).then(function(a){return c.setPrivateKey(a,b)})}).then(function(){return d.secondaryPrivateKeyParameters?c.getPrivateKey(a,!0).then(function(a){return c.setPrivateKey(a,b,!0)}):c})},generate:function(a,b,c){var d=this,e,f;return(new k(l)).then(function(){a instanceof r.Request||(a=new r.Request(a));return a.generate(c)}).then(function(a){f=a;return d.setKey(f,b)}).then(function(){e=new r.X509(a);return e.sign(f)}).then(function(){return d.setCertificate(e)}).then(function(){return a})},
encode:function(a){return{header:this.header.encode(a),name:this.name.encode(a),masks:this.masks.encode(a),primary:this.primary.encode(a),masks2:this.masks2.encode(a),primary2:this.primary2.encode(a)}}}}());u.prototype.CryptoProKeyContainer=L;w(h.PFX,M,{encloseContent:function(a,b,c){var e=this;return(new k(l)).then(function(){a=new h.AuthenticatedSafe(a);e.authSafe={contentType:"data",content:a.encode()};if(void 0!==b){var d,k,g,l;(l=c?q[c]:q[B.providerName])?(d=l.digest,g=l.derivation,k=l.hmac):
(d=c,g={name:0<=d.name.indexOf("SHA")?"PFXKDF":"PBKDF2",hash:d,iterations:2E3,diversifier:3},k={name:"HMAC",hash:d});g=p(g,{salt:F(O(d))});return f.importKey("raw",G(g,b),g,!1,["deriveKey"]).then(function(a){return f.deriveKey(g,a,k,!1,["verify"])}).then(function(a){return f.sign(k,a,e.autoSafe.content)}).then(function(a){e.macData={mac:{digestAlgorithm:d,digest:a},macSalt:g.salt,iterations:g.iterations};return e})}})},verify:function(a){var b=this,c=b.authSafe;return(new k(l)).then(function(){if("data"===
c.contentType){if(b.macData){if("string"!==typeof a)throw Error("Password must be defined for the MAC verification");var e=b.macData.mac.digestAlgorithm,d={name:0<=e.name.indexOf("SHA")?"PFXKDF":"PBKDF2",hash:e,salt:b.macData.macSalt,iterations:b.macData.iterations,diversifier:3},h={name:"HMAC",hash:e};return f.importKey("raw",G(d,a),d,!1,["deriveKey"]).then(function(a){return f.deriveKey(d,a,h,!1,["verify"])}).then(function(a){return f.verify(h,a,b.macData.mac.digest,c.content)}).then(function(a){if(!a)throw Error("MAC is not verified");
return b})}}else throw Error("Unsupported format");})}});u.prototype.PKCS12=M;n.keys=new u;return u});
