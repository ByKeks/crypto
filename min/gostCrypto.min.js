/*
 2014, Rudolf Nickolaev. All rights reserved.
*/
(function(s,h){"function"===typeof define&&define.amd?define(["gostRandom"],h):"object"===typeof exports?module.exports=h(require("gostRandom")):s.gostCrypto=h(s.gostRandom)})(this,function(s){function h(a,c){if("string"===typeof a||a instanceof String)a={name:a};var d=a.name;if(!d)throw new u("Algorithm name not defined");var e=d.split("/"),e=e[0].split("-").concat(e.slice(1)),b={},d=e[0].replace(/[\.\s]/g,""),e=e.slice(1);if(0<=d.indexOf("GOST")&&0<=d.indexOf("28147"))b={name:"GOST 28147",version:1989,
mode:(a.mode||("sign"===c||"verify"===c?"MAC":"wrapKey"===c||"unwrapKey"===c?"KW":"ES")).toUpperCase(),length:a.length||256};else if(0<=d.indexOf("GOST")&&0<=d.indexOf("3411"))b={name:"GOST R 34.11",version:2012,mode:(a.mode||("deriveKey"===c||"deriveBits"===c?"KDF":"sign"===c||"verify"===c?"HMAC":"HASH")).toUpperCase(),length:a.length||256};else if(0<=d.indexOf("GOST")&&0<=d.indexOf("3410"))b={name:"GOST R 34.10",version:2012,mode:(a.mode||("deriveKey"===c||"deriveBits"===c?"DH":"SIGN")).toUpperCase(),
length:a.length||256};else throw new m("Algorithm not supported");e.forEach(function(a){a=a.toUpperCase();if(/^[0-9]+$/.test(a))if(0<=["8","16","32","64"].indexOf(a))if("ES"===b.mode&&"CFB"===b.block)b.shiftBits=parseInt(a);else if("MAC"===b.mode)b.macLength=parseInt(a);else throw new m("Algorithm "+b.name+" mode "+a+" not supported");else 0<="89 94 01 12 14 1989 1994 2001 2012 2014".split(" ").indexOf(a)?(a=parseInt(a),b.version=1900>a?80>a?2E3+a:1900+a:a):0<=["256","512"].indexOf(a)?b.length=parseInt(a):
0<=["1000","2000"].indexOf(a)&&(b.iterations=parseInt(a));else if(0<="E-DEFAULT E-TEST E-A E-B E-C E-D E-SC E-Z D-TEST D-A D-SC".split(" ").indexOf(a))b.sBox=a;else if(0<="S-TEST S-A S-B S-C S-D X-A X-B X-C".split(" ").indexOf(a))b.namedParam=a;else if(0<="S-256-TEST S-256-A S-256-B S-256-C P-256 T-512-TEST T-512-A T-512-B X-256-A X-256-B T-256-TEST T-256-A T-256-B S-256-B T-256-C S-256-C".split(" ").indexOf(a))b.namedCurve=a;else if("GOST 28147"===b.name)if(0<=["ES","MAC","KW"].indexOf(a))b.mode=
a;else if(0<=["ECB","CFB","CNT","CBC"].indexOf(a))b.mode="ES",b.block=a;else if(0<=["CPKW","NOKW","SCKW"].indexOf(a))b.mode="KW",b.keyWrapping=a.replace("KW","");else if(0<=["ZEROPADDING","PKCS5PADDING","NOPADDING","RANDOMPADDING"].indexOf(a))b.padding=a.replace("PADDING","");else if(0<=["NOKM","CPKM"].indexOf(a))b.keyMeshing=a.replace("KM","");else throw new m("Algorithm "+b.name+" mode "+a+" not supported");else if("GOST R 34.11"===b.name)if(0<=["HASH","KDF","HMAC","PBKDF2"].indexOf(a))b.mode=a;
else throw new m("Algorithm "+b.name+" mode "+a+" not supported");else if("GOST R 34.10"===b.name){var c=a.replace(/[\.\s]/g,"");if(0<=c.indexOf("GOST")&&0<=c.indexOf("3411"))b.hash=a;else if(["SIGN","DH"].indexOf(a))b.mode=a;else throw new m("Algorithm "+b.name+" mode "+a+" not supported");}});"ES"===b.mode&&"generateKey"!==c&&(b.block=a.block||b.block||"ECB",b.padding=a.padding||b.padding||("CBC"===b.block||"ECB"===b.block?"ZERO":"NO"),"CFB"===b.block&&(b.shiftBits=a.shiftBits||b.shiftBits||64),
b.keyMeshing=(a.keyMeshing||b.keyMeshing||"NO").toUpperCase());"KW"===b.mode&&(b.keyWrapping=(a.keyWrapping||b.keyWrapping||"NO").toUpperCase());"GOST 28147"===b.name&&1989===b.version?b.sBox=a.sBox||b.sBox||"E-DEFAULT":"GOST R 34.11"===b.name&&1994===b.version?b.sBox=a.sBox||b.sBox||"D-A":"GOST R 34.10"===b.name&&1994===b.version?(b.sBox=a.sBox||b.sBox||"D-A",b.namedParam=a.namedParam||b.namedParam||("EC-DH"===b.mode?"X-A":"S-A")):"GOST R 34.10"===b.name&&2001===b.version?(b.sBox=a.sBox||b.sBox||
"D-A",b.namedCurve=a.namedCurve||b.namedCurve||(256===b.length?"EC-DH"===b.mode?"X-256-A":"S-256-A":"T-512-A"===b.mode)):"GOST R 34.10"===b.name&&2012===b.version&&(b.namedCurve=a.namedCurve||b.namedCurve||(256===b.length?"EC-DH"===b.mode?"X-256-A":"S-256-A":"T-512-A"===b.mode));switch(b.mode){case "DH":a.ukm&&(b.ukm=a.ukm);a["public"]&&(b["public"]=a["public"]);break;case "SIGN":case "KW":a.ukm&&(b.ukm=a.ukm);break;case "ES":case "MAC":a.iv&&(b.iv=a.iv);break;case "PBKDF2":a.salt&&(b.salt=a.salt);
a.iterations&&(b.iterations=a.iterations);break;case "KDF":a.label&&(b.label=a.label),a.contex&&(b.context=a.contex)}if(c&&("ES"!==b.mode&&"SIGN"!==b.mode&&"MAC"!==b.mode&&"HMAC"!==b.mode&&"KW"!==b.mode&&"generateKey"===c||"ES"!==b.mode&&("encrypt"===c||"decrypt"===c)||"SIGN"!==b.mode&&"MAC"!==b.mode&&"HMAC"!==b.mode&&("sign"===c||"verify"===c)||"HASH"!==b.mode&&"digest"===c||"KW"!==b.mode&&("wrapKey"===c||"unwrapKey"===c)||"DH"!==b.mode&&"PBKDF2"!==b.mode&&"KDF"!==b.mode&&("deriveKey"===c||"deriveBits"===
c)))throw new m("Algorithm mode "+b.mode+" not valid for method "+c);a.hash&&(b.hash=a.hash);b.hash&&(b.hash=h(b.hash,"digest"));a.id&&(b.id=a.id);return b}function n(a){return k&&k.subtle&&a&&(("string"===typeof a||a instanceof String)&&-1===a.toUpperCase().indexOf("GOST")||a.name&&-1===a.name.toUpperCase().indexOf("GOST")||a.hash&&a.hash.name&&-1===a.hash.name.toUpperCase().indexOf("GOST"))}function D(a,c,d){if(!a.algorithm)throw new u("Key algorithm not defined");if(!a.algorithm.name)throw new u("Key algorithm name not defined");
var e=a.algorithm.name,b="GOST 28147"===e,f="GOST R 34.11"===e,p="GOST R 34.10"===e;if(!b&&!p&&!f)throw new m("Key algorithm "+e+" is unsupproted");var h=a.algorithm.version;if(d&&e!==d.name&&h!==d.version)throw new u("Key algorithm "+e+"-"+h+" not compatible with algorithm "+d.name+"-"+d.version);if(!a.type)throw new u("Key type not defined");if((b||f)&&"secret"!==a.type||p&&"public"!==a.type&&"private"!==a.type)throw new E("Key type "+a.type+" is not valid for algorithm "+e);if(!a.usages||!a.usages.indexOf)throw new u("Key usages not defined");
d=0;for(e=a.usages.length;d<e;d++)if(b=a.usages[d],("wrapKey"===b||"unwrapKey"===b||"encrypt"===b||"decrypt"===b)&&"secret"!==a.type||"sign"===b&&"public"===a.type||"verify"===b&&"private"===a.type)throw new G("Key type "+a.type+" is not valid for "+b);if(c&&-1===a.usages.indexOf(c))throw new F("Key usages is not contain method "+c);if(!a.buffer)throw new u("Key buffer is not defined");c=8*a.buffer.byteLength;if("secret"===a.type&&256!==c&&(0<=a.usages.indexOf("encrypt")||0<=a.usages.indexOf("decrypt"))||
"private"===a.type&&256!==c&&512!==c||"public"===a.type&&512!==c&&1024!==c)throw new u("Key buffer has wrong size "+c+" bit");}function q(a,c,d){D(d,a,c);if(c){var e;switch(c.mode){case "ES":e=["sBox","keyMeshing","padding","block"];break;case "SIGN":e=["namedCurve","namedParam","sBox"];break;case "MAC":e=["sBox"];break;case "KW":e=["keyWrapping","ukm"];break;case "DH":e=["namedCurve","namedParam","sBox","ukm"];break;case "PBKDF2":e=["sBox","iterations","salt"];break;case "KDF":e=["context","label"]}e&&
e.forEach(function(a){d.algorithm[a]&&(c[a]=d.algorithm[a])})}return d.buffer}function x(a,c,d,e,b){a={type:b||"secret",extractable:c||"false",algorithm:a,usages:d||[],buffer:e};D(a);return a}function H(a,c,d,e,b){if(!d||!d.indexOf)throw new u("Key usages not defined");var f=d.filter(function(a){return"sign"!==a});d=d.filter(function(a){return"verify"!==a});return{publicKey:x(a,c,f,e,"public"),privateKey:x(a,c,d,b,"private")}}function y(){for(var a=0,c=arguments.length;a<c;a++){var d=arguments[a].split("."),
d=z+d[0]+A+"."+d[1],e=document.querySelector('script[src="'+d+'"]');e||(e=document.createElement("script"),e.setAttribute("src",d),document.head.appendChild(e))}}function t(a,c,d){return new Promise(function(e,b){try{if(w){var h=++I;v.push({id:h,resolve:e,reject:b});w.postMessage({id:h,algorithm:a,method:c,args:d})}else f.gostEngine?e(f.gostEngine.execute(a,c,d)):b(new B("Module gostEngine not found"))}catch(p){b(p)}})}function r(a){try{a()}catch(c){}}function g(){}var f=this,k=f.crypto||f.msCrypto,
u=f.SyntaxError||Error,E=f.DataError||Error,m=f.NotSupportedError||Error,B=f.OperationError||Error,G=f.InvalidAccessError||Error,F=f.InvalidAccessError||Error;f.Promise||(f.Promise=function(){function a(a){return a&&null===a.oncomplete&&null===a.onerror?new c(function(c,b){a.oncomplete=function(){c(a.result)};a.onerror=function(){b(new B(a.toString()))}}):a}function c(d){function e(a){try{a()}catch(b){}}var b="pending",f,h=[],k=[];try{d(function(a){"pending"===b&&(b="fulfilled",f=a,h.forEach(e))},
function(a){"pending"===b&&(b="rejected",f=a,k.forEach(e))})}catch(l){"pending"===b&&(b="rejected",f=l,k.forEach(e))}this.then=function(d,e){return new c(function(c,l){function g(){var b;try{b=d?d(f):f}catch(e){l(e);return}(b=a(b))&&b.then&&b.then.call?b.then(c,l):c(b)}function m(){var b;try{b=e?e(f):f}catch(d){l(d);return}(b=a(b))&&b.then&&b.then.call?b.then(c,l):l(b)}"fulfilled"===b?g():"rejected"===b?m():(h.push(g),k.push(m))})};this["catch"]=function(a){return this.then(void 0,a)}}c.all=function(a){return new c(function(c,
b){function f(a){l++;return function(b){k[a]=b;l--;0===l&&c(k)}}function h(a){0<l&&b(a);l=0}for(var k=[],l=0,g=0,m=a.length;g<m;g++){var n=a[g];n.then&&n.then.call?n.then(f(g),h):k[g]=n}0===l&&c(k)})};return c}());var z="",A="";"undefined"!==typeof document&&function(){for(var a=/^(.*)gostCrypto(.*)\.js$/i,c=document.querySelectorAll("script"),d=0,e=c.length;d<e;d++){var b=c[d].getAttribute("src");if(b=a.exec(b))z=b[1],A=b[2]}}();var w,v=[],I=0;if(!f.importScripts&&!f.gostEngine)try{w=new Worker(z+
"gostEngine"+A+".js"),w.onmessage=function(a){for(var c=a.data.id,d=0,e=v.length;d<e&&v[d].id!==c;d++);d<e&&(c=v[d],v.splice(d,1),a.data.error?c.reject(new B(a.data.error)):c.resolve(a.data.result))},w.onerror=function(a){for(var c=0,d=v.length;c<d;c++)v[c].reject(a.error);v=[]}}catch(J){w=!1}f.importScripts||(f.importScripts=y);w||f.gostEngine||y("gostEngine.js");g.prototype.encrypt=function(a,c,d){return(new Promise(r)).then(function(){if(n(a))return k.subtle.encrypt(a,c,d);a=h(a,"encrypt");return t(a,
"encrypt",[q("encrypt",a,c),d])})};g.prototype.decrypt=function(a,c,d){return(new Promise(r)).then(function(){if(n(a))return k.subtle.decrypt(a,c,d);a=h(a,"decrypt");return t(a,"decrypt",[q("decrypt",a,c),d])})};g.prototype.sign=function(a,c,d){return(new Promise(r)).then(function(){if(n(a))return k.subtle.sign(a,c,d);a=h(a,"sign");return t(a,"sign",[q("sign",a,c),d])})};g.prototype.verify=function(a,c,d,e){return(new Promise(r)).then(function(){if(n(a))return k.subtle.verify(a,c,d,e);a=h(a,"verify");
return t(a,"verify",[q("verify",a,c),d,e])})};g.prototype.digest=function(a,c){return(new Promise(r)).then(function(){if(n(a))return k.subtle.digest(a,c);a=h(a,"digest");return t(a,"digest",[c])})};g.prototype.generateKey=function(a,c,d){return(new Promise(r)).then(function(){if(n(a))return k.subtle.generateKey(a,c,d);a=h(a,"generateKey");return t(a,"generateKey",[]).then(function(e){return e.publicKey&&e.privateKey?H(a,c,d,e.publicKey,e.privateKey):x(a,c,d,e)})})};g.prototype.deriveKey=function(a,
c,d,e,b){return(new Promise(r)).then(function(){if(n(a))return k.subtle.deriveKey(a,c,d,e,b);a=h(a,"deriveKey");d=h(d,"generateKey");a["public"]&&(a["public"].algorithm=h(a["public"].algorithm),a["public"]=q("deriveKey",a,a["public"]));return t(a,"deriveKey",[q("deriveKey",a,c)]).then(function(a){return x(d,e,b,a)})})};g.prototype.deriveBits=function(a,c,d){return(new Promise(r)).then(function(){if(n(a))return k.subtle.deriveBits(a,c,d);a=h(a,"deriveBits");a["public"]&&(a["public"]=q("deriveBits",
a,a["public"]));return t(a,"deriveBits",[q("deriveBits",a,c),d])})};g.prototype.importKey=function(a,c,d,e,b){return(new Promise(r)).then(function(){if(n(d))return k.subtle.importKey(a,c,d,e,b);var g,p,q;if("raw"===a)d=h(d,"importKey"),q=c,b&&b.indexOf&&(p=d.name.toUpperCase().replace(/[\.\s]/g,""),0<=p.indexOf("3410")&&0<=b.indexOf("sign")?g="private":0<=p.indexOf("3410")&&0<=b.indexOf("verify")&&(g="public"));else{if("pkcs8"===a&&f.gostSyntax&&f.gostCoding)p=f.gostSyntax.GostPrivateKeyInfo.decode(c);
else if("spki"===a&&f.gostSyntax&&f.gostCoding)p=f.gostSyntax.GostSubjectPublicKeyInfo.decode(c);else throw new m("Key format not supported");d=h(p.algorithm,"importKey");q=p.buffer;g=p.type;e=e||p.extractable;if(b)for(var l=0;l<b.length;l++){if(0>p.usages.indexOf(b[l]))throw E("Key usage not valid for this key");}else b=p.usages}return x(d,e,b,q,g)})};g.prototype.exportKey=function(a,c){return(new Promise(r)).then(function(){if(c&&n(c.algorithm))return k.subtle.exportKey(a,c);if(!c.extractable)throw new F("Key not extractable");
var d=q(null,null,c);if("raw"===a)return d;if("pkcs8"===a&&c.algorithm&&c.algorithm.id&&f.gostSyntax&&f.gostCoding)return f.gostSyntax.GostPrivateKeyInfo.encode(c);if("spki"===a&&c.algorithm&&c.algorithm.id&&f.gostSyntax&&f.gostCoding)return f.gostSyntax.GostSubjectPublicKeyInfo.encode(c);throw new m("Key format not supported");})};g.prototype.wrapKey=function(a,c,d,e){return(new Promise(r)).then(function(){if(n(e))return k.subtle.wrapKey(a,c,d,e);e=h(e,"wrapKey");return t(e,"wrapKey",[q("wrapKey",
e,d),q(null,null,c)]).then(function(b){if("raw"===a)return b;throw new m("Key format not supported");})})};g.prototype.unwrapKey=function(a,c,d,e,b,f,g){return(new Promise(r)).then(function(){if(n(e))return k.subtle.unwrapKey(a,c,d,e,b,f,g);e=h(e,"unwrapKey");b=h(b,"importKey");if("raw"!==a)throw new m("Key format not supported");return t(e,"unwrapKey",[q("unwrapKey",e,d),c]).then(function(a){var c;if(b&&b.name){var d=b.name.toUpperCase().replace(/[\.\s]/g,"");0<=d.indexOf("3410")&&0<=g.indexOf("sign")?
c="private":0<=d.indexOf("3410")&&0<=g.indexOf("verify")&&(c="public")}return x(b,f,g,a,c)})})};var C={};C.subtle=new g;s||k&&k.getRandomValues||y("gostRandom.js");C.getRandomValues=function(a){s=s||f.gostRandom;!s&&k&&k.getRandomValues&&(s=k);if(s)s.getRandomValues(a);else throw new m("Random generator not found");};return C});
