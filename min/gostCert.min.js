/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(m,u){"function"===typeof define&&define.amd?define(["gostCrypto","gostASN1"],u):"object"===typeof exports?module.exports=u(require("gostCrypto"),require("gostASN1")):m.GostCert=u(m.gostCrypto,m.GostASN1)})(this,function(m){function u(a){for(var b=1,c=arguments.length;b<c;b++){var d=arguments[b];if("object"===typeof d)for(var e in d)d.hasOwnProperty(e)&&(a[e]=d[e])}return a}function t(a){var b=function(){};b.prototype=a.prototype;for(var b=[new b],c=1;c<arguments.length;c++)b.push(arguments[c]);
return u.apply(this,b)}function v(a){var b=new P;b.setHours(0,0,0,0);a&&b.setDate(b.getDate()+a);return b}function q(a){try{a()}catch(b){}}function Q(){var a=new Uint8Array(4);m.getRandomValues(a);a[0]&=127;return R.Int16.encode(a)}function B(a,b){for(var c in a)if(a[c]!==b[c])return!1;for(c in b)if(a[c]!==b[c])return!1;return!0}function x(a,b){var c=a.extensions&&a.extensions.subjectKeyIdentifier,d;if((d=a&&b&&(!b.issuer||B(a.issuer,b.issuer))&&(!b.serialNumber||H(a.serialNumber,b.serialNumber)))&&
!(d=!b.subjectKeyIdentifier))a:if(d=b.subjectKeyIdentifier,c=new Uint8Array(c),d=new Uint8Array(d),c.length!==d.length)d=!1;else{for(var e=0,g=c.length;e<g;e++)if(c[e]!==d[e]){d=!1;break a}d=!0}return d&&(!b.subject||B(a.subject,b.subject))&&(!b.date||a.notBefore.getTime()<=b.date.getTime()&&a.notAfter.getTime()>b.date.getTime())}function C(a,b,c){a={subject:a.issuer,date:c};if(b=b&&b.authorityKeyIdentifier)a.subjectKeyIdentifier=b.keyIdentifier,b.authorityCertIssuer&&b.authorityCertIssuer[0]&&b.authorityCertSerialNumber&&
(a.issuer=b.authorityCertIssuer[0],a.serialNumber=b.authorityCertSerialNumber);return a}function z(a,b){for(var c=[],d=0,e=a.length;d<e;d++)x(a[d],b)&&c.push(a[d]);return c}function I(a,b){return(!b.issuer||B(a.issuer,b.issuer))&&(!b.date||a.thisUpdate.getTime()<b.date.getTime())}function J(a,b){for(var c=[],d=0,e=a.length;d<e;d++)I(a[d],b)&&c.push(a[d]);return c}function E(a){a=a.id;for(var b in s){var c=s[b];if(c.publicKey.id===a)return c}}function K(a,b,c){for(var d in b){var e=a,g=d,h=b[d];"object"!==
typeof h&&(h={value:h});void 0!==c&&(h.enumerable=c);y.defineProperty(e,g,h)}}function t(a,b,c,d){"function"!==typeof b&&(d=c,c=b,b=function(){a.apply(this,arguments)});b.prototype=y.create(a.prototype,{constructor:{value:b},superclass:{value:a.prototype}});c&&K(b.prototype,c,!0);if(a!==y)for(var e in a)b[e]=a[e];b.super=a;d&&K(b,d,!0);return b}function r(){}function L(a){try{f.CertificationRequest.call(this,a,!0)}catch(b){a=a||{},f.CertificationRequest.call(this,{version:0,subject:a.subject||l.subject,
subjectPublicKeyInfo:a.subjectPublicKeyInfo||{algorithm:{id:"noSignature"},subjectPublicKey:new D(0)},attributes:a.attributes||{extensionRequest:{keyUsage:l.userKeyUsage,extKeyUsage:l.userExtKeyUsage}},signatureAlgorithm:{id:"noSignature"},signatureValue:new D(0)})}}function M(a,b){this.certificates=a;this.crls=b}function N(a){this.certStore=a}function F(){}function O(a,b,c){this.trustedCACerts=a||[];this.requireCRL=b||!1;this.requireCA=c||!0}var n=this.Promise,y=this.Object,D=this.ArrayBuffer,P=
this.Date,k=m.subtle,R=m.coding,f=m.asn1,s=m.security.providers,H=function(){var a=function(a){var b=typeof a;return"undefined"===b||""===a?"0":"number"===b||a instanceof Number?a.toString(16).toLowerCase():a.replace("0x","").toLowerCase()},b=function(a,b){return(Array(b+1).join("0")+a).slice(-b)};return function(c,d){c=a(c);d=a(d);var e=Math.max(c.length,d.length);return b(c,e)===b(d,e)}}(),l={providerName:"CP-01",subject:{countryName:"RU",commonName:"Anonymous"},caKeyUsage:"digitalSignature nonRepudiation keyEncipherment dataEncipherment keyAgreement keyCertSign cRLSign".split(" "),
caExtKeyUsage:"serverAuth clientAuth codeSigning emailProtection ipsecEndSystem ipsecTunnel ipsecUser timeStamping OCSPSigning".split(" "),userKeyUsage:["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement"],userExtKeyUsage:["clientAuth","emailProtection"],days:7305};r.prototype.options=l;var w=function(a){try{f.Certificate.call(this,a,!0)}catch(b){try{a=new f.CertificationRequest(a,!0)}catch(c){}a=a||{};f.Certificate.call(this,{version:2,serialNumber:a.serialNumber||
Q(),signature:a.signature||{id:"noSignature"},issuer:a.subject||l.subject,notBefore:a.notBefore||v(),notAfter:a.notAfter||v(a.days||l.days),subject:a.subject||l.subject,subjectPublicKeyInfo:a.subjectPublicKeyInfo||{algorithm:{id:"noSignature"},subjectPublicKey:new D(0)},extensions:a.attributes&&(a.attributes.extensionRequest||a.attributes.msCertExtensions)||a.extensions,signatureAlgorithm:{id:"noSignature"},signatureValue:new D(0)})}};t(f.Certificate,w,{sign:function(a,b){var c=this,d=c.subjectPublicKeyInfo;
return(new n(q)).then(function(){if(!d||!d.algorithm||"noSignature"===d.algorithm)throw Error("Key pair was not generated for the certificate");if(!a)throw Error("The private key of the issuer is not defined");b=b||c;return k.digest("SHA-1",d.subjectPublicKey)}).then(function(d){var g=b.getProvider()||s[l.providerName];c.signature&&"noSignature"!==c.signature.id||(c.signature=g.signature);c.signatureAlgorithm=c.signature;c.issuer=b.subject;c.extensions||(c.extensions={});var g=c.extensions,h=b.extensions;
if(c===b)g.keyUsage=g.keyUsage||l.caKeyUsage,g.extKeyUsage=g.extKeyUsage||l.caExtKeyUsage,g.basicConstraints=g.basicConstraints||{cA:!0};else{if(!b.checkUsage("keyCertSign",c.notBefore))throw Error("The issuer's certificate is not valid for signing a certificate");g.keyUsage=g.keyUsage||l.userKeyUsage;g.extKeyUsage=g.extKeyUsage||l.userExtKeyUsage;g.basicConstraints=g.basicConstraints||{cA:0<=g.keyUsage.indexOf("keyCertSign")};if(g.basicConstraints.cA){var G=h&&h.basicConstraints&&h.pathLenConstraint;
if(void 0!==G)if(0<G)g.basicConstraints.pathLenConstraint=G-1;else throw Error("Path length constraint exceeded");}}g.subjectKeyIdentifier=d;h&&h.subjectKeyIdentifier&&(g.authorityKeyIdentifier={keyIdentifier:h.subjectKeyIdentifier,authorityCertIssuer:[b.issuer],authorityCertSerialNumber:b.serialNumber});return k.importKey("pkcs8",f.PrivateKeyInfo.encode(a),a.privateKeyAlgorithm,!1,["sign"])}).then(function(a){return k.sign(c.signatureAlgorithm,a,f.TBSCertificate.encode(c))}).then(function(a){c.signatureValue=
a;return c})},generate:function(a){var b=this,c,d;(d=a?s[a]:this.getProvider()||s[l.providerName])&&(a=u(d.publicKey,{privateKey:d.privateKey}));return(new n(q)).then(function(){return k.generateKey(a,"true",["sign","verify"])}).then(function(a){c=a.privateKey;return k.exportKey("spki",a.publicKey)}).then(function(a){b.subjectPublicKeyInfo=new f.SubjectPublicKeyInfo(a);return k.exportKey("pkcs8",c)}).then(function(a){return new f.PrivateKeyInfo(a)})},getPublicKey:function(){var a=this.subjectPublicKeyInfo,
b="rsaEncryption"===a.algorithm.id?["verify"]:["verify","deriveKey","deriveBits"];return k.importKey("spki",f.SubjectPublicKeyInfo.encode(a),a.algorithm,"false",b)},getProvider:function(){return E(this.subjectPublicKeyInfo.algorithm)},verify:function(a,b,c){var d=this,e=d.extensions;return(new n(q)).then(function(){c=c||v();if(d.notBefore.getTime()>c.getTime()||d.notAfter.getTime()<=c.getTime())throw Error("The certificate has not yet started or expired");for(var b in e)if(e[b].critical&&0>"authorityKeyIdentifier subjectKeyIdentifier keyUsage certificatePolicies policyMappings basicConstraints nameConstraints policyConstraints extKeyUsage".split(" ").indexOf(b))throw Error("The critical extension '"+
b+"' is unrecognized");b=C(d,e,d.notBefore);!a&&x(d,b)&&(a=d);if(a){if(!x(a,b)||!a.checkUsage("keyCertSign",d.notBefore))throw Error("The issuer's certificate is not valid");return a.verifySignature(f.TBSCertificate.encode(d),d.signatureValue,d.signatureAlgorithm)}return!0}).then(function(a){if(!a)throw Error("The certificate has invalid signature");if(b){if(!I(b,{issuer:d.issuer,date:c}))throw Error("The issuer's CRL is not valid");if(b.isRevoked(d.serialNumber))throw Error("The certificate is revoked");
}return d})},verifySignature:function(a,b,c){return this.getPublicKey().then(function(d){return k.verify(c,d,b,a)})},checkUsage:function(a,b){var c=this.extensions;b=b||v();return this.notBefore.getTime()<=b.getTime()&&this.notAfter.getTime()>b.getTime()&&(!c||!(0<["keyCertSign","cRLSign"].indexOf(a)&&c.basicConstraints&&!c.basicConstraints.cA||c.keyUsage&&0>c.keyUsage.indexOf(a)&&c.extKeyUsage&&0>c.extKeyUsage.indexOf(a)))}});r.prototype.X509=w;var A=function(a){A.super.call(this,a);this.version||
(this.version=1);this.revokedCertificates||(this.revokedCertificates=[]);this.thisUpdate||(this.thisUpdate=v())};t(f.CertificateList,A,{sign:function(a,b){var c=this;return(new n(q)).then(function(){if(!a)throw Error("The issuer's private key is not defined");if(!b)throw Error("The issuer's certificate is not defined");if(!c.issuer)c.issuer=b.issuer;else if(!B(c.issuer,b.issuer))throw Error("The CRL prototype and authority certificate have different issuers");if(!b.checkUsage("cRLSign",c.thisUpdate))throw Error("The issuer's certificate is not valid for signing a CRL");
var d=b.getProvider()||s[l.providerName];c.signature||(c.signature=d.signature);c.signatureAlgorithm=c.signature;c.issuer=b.subject;c.crlExtensions||(c.crlExtensions={});var d=c.crlExtensions,e=b.extensions;e&&e.subjectKeyIdentifier&&(d.authorityKeyIdentifier={keyIdentifier:e.subjectKeyIdentifier,authorityCertIssuer:[b.issuer],authorityCertSerialNumber:b.serialNumber});d.cRLNumber=d.cRLNumber||0;return k.importKey("pkcs8",f.PrivateKeyInfo.encode(a),a.privateKeyAlgorithm,!1,["sign"])}).then(function(a){return k.sign(c.signatureAlgorithm,
a,f.TBSCertList.encode(c))}).then(function(a){c.signatureValue=a;return c})},verify:function(a,b){var c=this,d=c.crlExtensions;return(new n(q)).then(function(){b=b||v();if(!c.thisUpdate.getTime()>b.getTime())throw Error("The CRL has not yet started");if(a){if(!x(a,C(c,d,c.thisUpdate))||!a.checkUsage("cRLSign",c.thisUpdate))throw Error("The issuer's certificate is not valid");if(!c.signatureValue||!c.signatureAlgorithm)throw Error("The has no signature");return a.verifySignature(f.TBSCertList.encode(c),
c.signatureValue,c.signatureAlgorithm)}}).then(function(a){if(!a)throw Error("The CRL has invalid signature");return c})},isRevoked:function(a,b){var c=this.revokedCertificates;b=b||v();for(var d=0;d<c.length;d++)if(b.getTime()>=c[d].revocationDate.getTime()&&H(c[d].userCertificate,a))return!0;return!1}});r.prototype.CRL=A;t(f.CertificationRequest,L,{generate:function(a){var b=this,c,d;(d=a?s[a]:this.getProvider()||s[l.providerName])&&(a=u(d.publicKey,{privateKey:d.privateKey}));return(new n(q)).then(function(){return k.generateKey(a,
"true",["sign","verify"])}).then(function(a){c=a.privateKey;return k.exportKey("spki",a.publicKey)}).then(function(a){b.subjectPublicKeyInfo=new f.SubjectPublicKeyInfo(a);return k.exportKey("pkcs8",c)}).then(function(a){c=new f.PrivateKeyInfo(a);return b.sign(c)}).then(function(){return c})},getProvider:function(){return E(this.subjectPublicKeyInfo.algorithm)},sign:function(a){var b=this,c=b.subjectPublicKeyInfo;return(new n(q)).then(function(){if(!c||!c.algorithm||"noSignature"===c.algorithm)throw Error("Key pair was not generated for the certificate");
if(!a)throw Error("The private key is not defined");var d=E(c.algorithm)||s[l.providerName];b.signatureAlgorithm=d.signature;return k.importKey("pkcs8",f.PrivateKeyInfo.encode(a),a.privateKeyAlgorithm,!1,["sign"])}).then(function(a){return k.sign(b.signatureAlgorithm,a,f.CertificationRequestInfo.encode(b))}).then(function(a){b.signatureValue=a;return b})},verify:function(){var a=this,b=a.subjectPublicKeyInfo;return(new n(q)).then(function(){return k.importKey("spki",f.SubjectPublicKeyInfo.encode(b),
b.algorithm,"false",["verify"])}).then(function(b){return k.verify(a.signatureAlgorithm,b,a.signatureValue,f.CertificationRequestInfo.encode(a))}).then(function(b){if(!b)throw Error("The certification request has invalid signature");return a})}});r.prototype.Request=L;t(y,M,{getCertificates:function(a){return z(this.certificates,a)},getCRLs:function(a){return J(this.certificates,a)}});r.prototype.CertStore=M;t(y,N,{build:function(a,b){var c=this;return(new n(q)).then(function(){for(var d=new w(a),
e=[],g=!1,h=[];d;){var f=[],k=[];e.push(d);if(!g){var f=c.certStore.getCRLs({issuer:d.issuer,date:b}),l=C(d,d.extensions,d.notBefore);x(d,l)?g=!0:k=c.certStore.getCertificates(l)}k=0<k.length&&new w(k[0]);(f=0<f.length&&new A(f[0]))&&h.push(f.verify(k,b));h.push(d.verify(k,f,b));d=k}if(!g)throw Error("Root certificate is not found");return n.all(h).then(function(a){for(var b=0;b<a;b++)if(!a[b])throw Error("Certification path is not validated");return e})})}});r.prototype.CertPath=N;t(y,F,{getValidCertificate:function(a,
b,c){}});r.prototype.CertificateTrustPolicy=F;t(F,O,{getValidCertificate:function(a,b,c,d){var e=this,g;return(new n(q)).then(function(){b=b||[];c=c||[];var h=z(e.trustedCACerts,a);if(0<h.length)return new w(h[0]);h=z(b,a);if(0!==h.length){var h=new w(h[0]),f=!1,k=[];for(g=[];h;){var l=[],p=[];g.push(h);if(!f){l=J(c,{issuer:h.issuer,date:d});if(0===l.length&&e.requireCRL)return;a=C(h,h.extensions,h.notBefore);p=z(e.trustedCACerts,a);if(0===p.length){if(!x(h,a))if(p=z(b,a),0<p.length){var m=p[0].extensions;
if(e.requireCA&&(!m||!m.basicConstraints||!m.basicConstraints.cA||void 0!==m.basicConstraints.pathLenConstraint&&m.basicConstraints.pathLenConstraint<g.length-1))return}else return}else f=!0}p=0<p.length&&new w(p[0]);(l=0<l.length&&new A(l[0]))&&k.push(l.verify(p,d));k.push(h.verify(p,l,d));h=p}if(!f)throw Error("Trusted root certificate is not found");return n.all(k).then(function(a){for(var b=0;b<a;b++)if(!a[b])throw Error("Certification path is not validated");return g[0]})}})}});r.prototype.TrustedCAPolicy=
O;m.cert=new r;return r});
