<!DOCTYPE html>
<!-- saved from url=(0014)about:internet -->
<html>
    <head>
        <title>WebCrypto GOST: CMS Signed data</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.00, maximum-scale=1.00, user-scalable=0" />
        <script src="scripts/prettify/prettify.js"></script>
        <script src="scripts/prettify/lang-css.js"></script>
        <script src="scripts/gost/gostCrypto.js"></script>
        <script src="scripts/gost/gostCoding.js"></script>
        <script src="scripts/gost/gostObject.js"></script>
        <script src="scripts/gost/gostSyntax.js"></script>
        <script src="scripts/gost/gostPKIX.js"></script>
        <script src="scripts/filesaver/FileSaver.js"></script>
        <script src="scripts/gost/gostViewer.js"></script>
        <link type="text/css" rel="stylesheet" href="styles/prettify.css">
        <link type="text/css" rel="stylesheet" href="styles/main.css">
    </head>
    <body>
        <div class="page art05">
            <h1><a href="index.html">WebCrypto GOST</a>: CMS Signed data</h1>
            <p class="note">The tool is intended for experimentation with data processing</p>
            <article>
                <h2>Sign sample data</h2>
                <section>
                    <label for="provider"><strong>Algorithm</strong> parameters for selected provider</label>
                    <select class="value" id="provider">
                        <option value="TC-256" selected>GOST R 34.10-2012 256 TC26</option>
                        <option value="TC-512">GOST R 34.10-2012 512 TC26</option>
                        <option value="CP-01">GOST R 34.10-2001 CryptoPro</option>
                        <option value="SC-01">GOST R 34.10-2001 SignalCom</option>
                        <option value="RSA-2048">RSASSA PKCS#1 v1.5 2048/SHA256</option>
                        <option value="ECDSA-256">ECDSA secp256r1/SHA256</option>
                    </select>
                    <label for="signType">Choice <strong>signing mode</strong></label>
                    <select class="value" id="signType">
                        <option value="'DETACHED'" selected>Detached signature</option>
                        <option value="undefined">Signed data</option>
                        <option value="'CERTPATH'">Signed data with cert path</option>
                        <option value="'ATTRS'">Signed attributes with digisted data</option>
                        <option value="['ATTRS','DETACHED']">Detached signed attributes</option>
                        <option value="['CERTPATH','ATTRS']">Signed attributes and cert path</option>
                    </select>
                    <span class="label"><strong>Root CA Certificate & Private key</strong> from previous PKI example</span>
                    <pre contenteditable id="certAndKeyCA" class="encoded"></pre>
                    <div class="fileButton">
                        <button id="loadButton">Load from file</button>
                        <input type="file" onchange="
                                    var reader = new FileReader();
                                    reader.onload = function(e) {
                                        certAndKeyCA.textContent = e.target.result;
                                    };
                                    reader.readAsText(this.files[0]);"/>
                    </div>
                    <button onclick="
var pki = new GostPKIX(provider.value, 'PEM');
pki.createCertificate({
    subject: {
        countryName: 'RU',
        stateOrProvinceName: 'С.Питербургъ',
        organizationName: 'Современник',
        organizationalUnitName: 'Руководство',
        title: 'Редактор',
        commonName: 'Пушкин Александр Сергеевич'
    }
}, 'Pushkin').then(function(data) {
    certAndKeyCA.textContent = data;
    
    return pki.exportKey('Pushkin');
}).then(function(data) {
    
    certAndKeyCA.textContent += '\r\n\r\n' + data;
}, function(reason) {
    alert(reason.message);
});">Generate new one</button>
                    <button onclick="certAndKeyCA.innerHTML = ''">Clear</button>
                    <span class="label"><strong>Signer Certificate & Private key</strong> from previous PKI example</span>
                    <pre contenteditable id="signerCert" class="encoded"></pre>
                    <div class="fileButton">
                        <button>Load from file</button>
                        <input type="file" onchange="
                                    var reader = new FileReader();
                                    reader.onload = function(e) {
                                        signerCert.textContent = e.target.result;
                                    };
                                    reader.readAsText(this.files[0]);"/>
                    </div>
                    <button onclick="
var pki = new GostPKIX(provider.value, 'PEM');
pki.importCertificate(certAndKeyCA.textContent, 'Pushkin').then(function() {
    return pki.importKey(certAndKeyCA.textContent, 'Pushkin');
}).then(function() {
    return pki.createRequest({subject: {
        countryName: 'RU',
        stateOrProvinceName: 'С.Питербургъ',
        organizationName: 'Современник',
        organizationalUnitName: 'Действующие лица',
        title: 'Филосов и публицист',
        commonName: 'Евгеній Онѣгинъ'}}, 'Onegin');
}).then(function() {
    return pki.issueCertificate({}, 'Onegin', 'Pushkin');
}).then(function(data) {
    signerCert.textContent = data;
    return pki.exportKey('Onegin');
}).then(function(data) {
    
    signerCert.textContent += '\r\n\r\n' + data;
}, function(reason) {
    alert(reason.message);
});">Requet and Issue new one</button>
                    <button onclick="signerCert.innerHTML = ''">Clear</button>
                    <span class="label"><strong>Data</strong> for signature</span>
                    <pre contenteditable id="message" class="content">
Не мысля гордый свет забавить,
Вниманье дружбы возлюбя,
Хотел бы я тебе представить
Залог достойнее тебя,
Достойнее души прекрасной,
Святой исполненной мечты,
Поэзии живой и ясной,
Высоких дум и простоты;
Но так и быть — рукой пристрастной
Прими собранье пестрых глав,
Полусмешных, полупечальных,
Простонародных, идеальных,
Небрежный плод моих забав,
Бессонниц, легких вдохновений,
Незрелых и увядших лет,
Ума холодных наблюдений
И сердца горестных замет.</pre>   
                    <button onclick="(new Function(signMethod.textContent))()">Create signature</button>
                    <span class="label"><strong>Data signature</strong> CMS PKCS#7 format</span>
                    <pre contenteditable id="signedData" class="encoded"></pre>
                    <button onclick="
                            saveAs(new Blob([gostCoding.Chars.decode(signedData.textContent, 'ascii')], {type: 'text/plain'}), 'data.sig');
                            ">Save contents to file</button>
                    <button onclick="signedData.innerHTML = ''">Clear</button>
                    <button onclick="gostViewer.openASN1(signedData)">View ASN.1</button>
                    <button onclick="gostViewer.openSyntax(signedData, 'ContentInfo')">View JSON</button>
                    <span class="label">Sign data method</span>
                    <pre contenteditable id="signMethod" class="procedure prettyprint">
// Import root CA certificate
var pki = new GostPKIX(provider.value, 'PEM');
var mode = eval(signType.value);
pki.importCertificate(certAndKeyCA.textContent, 'Pushkin').then(function() {
    
    // Import signer certificate
    return pki.importCertificate(signerCert.textContent, 'Onegin');
}).then(function() {

    // Import signer private key
    return pki.importKey(signerCert.textContent, 'Onegin');
}).then(function() {

    var modes = arguments[0];
    var content = gostCoding.Chars.decode(message.textContent, 'utf-8');

    // Sign data
    return pki.signData(content, mode, 'Onegin');
}).then(function(data) {

    // Output signed data
    signedData.textContent = data;

}, function(reason) {
    alert(reason.message);
});</pre>
                </section>
                <h2>Verify signature</h2>
                <section>
                    <button onclick="(new Function(verifyMethod.textContent))()">Import and verify</button>
                    <button onclick="verified.value = ''">Clear</button>
                    <label for="verified">Is all signaturies verified and valid?</label>
                    <input class="value" id="verified"/>
                    <span class="label">Signed data verification method</span>
                    <pre contenteditable id="verifyMethod" class="procedure prettyprint">
// Import certificate
var pki = new GostPKIX(provider.value, 'PEM');
var mode = eval(signType.value);
pki.importCertificate(certAndKeyCA.textContent, 'Pushkin').then(function() {

    // Load signer certificate for test if no cert path in signed data
    if (mode !== 'CERTPATH' && (mode || []).indexOf('CERTPATH') < 0)
        return pki.importCertificate(signerCert.textContent, 'Onegin');
}).then(function() {

    // Verify signed data
    var data = signedData.textContent;
    var content = gostCoding.Chars.decode(message.textContent, 'utf-8');
    return pki.verifyData(data, content)
}).then(function(data) {

    // Signed data extrated == signature verified
    verified.value = 'Yes: Signature verified';

}, function(reason) {
    
    // Reject if signature not verified
    verified.value = 'No: ' + reason.message;
});</pre>
                </section>
            </article>
        </div>
        <script> prettyPrint();</script>
    </body>
</html>
