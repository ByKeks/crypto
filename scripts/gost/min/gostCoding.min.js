/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(B,s){"function"===typeof define&&define.amd?define(["gostCrypto"],s):"object"===typeof exports?module.exports=s(require("gostCrypto")):B.GostCoding=s(B.gostCrypto)})(this,function(B){function s(c){if(c instanceof v)return c;if(c&&c.buffer&&c.buffer instanceof v)return 0===c.byteOffset&&c.byteLength===c.buffer.byteLength?c.buffer:(new Uint8Array(new Uint8Array(c,c.byteOffset,c.byteLength))).buffer;throw new y("CryptoOperationData required");}function A(){}var y=this.DataError||this.Error,
v=this.ArrayBuffer,C=this.Date,D={decode:function(c){c=c.replace(/[^A-Za-z0-9\+\/]/g,"");for(var m=c.length,p=3*m+1>>2,q=new Uint8Array(p),g,a=0,h=0,e=0;e<m;e++){g=e&3;var d=c.charCodeAt(e),d=64<d&&91>d?d-65:96<d&&123>d?d-71:47<d&&58>d?d+4:43===d?62:47===d?63:0,a=a|d<<18-6*g;if(3===g||1===m-e){for(g=0;3>g&&h<p;g++,h++)q[h]=a>>>(16>>>g&24)&255;a=0}}return q.buffer},encode:function(c){c=new Uint8Array(s(c));for(var m=2,p="",q=c.length,g=0,a=0;a<q;a++)if(m=a%3,0<a&&0===4*a/3%96&&(p+="\r\n"),g|=c[a]<<
(16>>>m&24),2===m||1===q-a){for(var h=18;0<=h;h-=6)var e=g>>>h&63,e=26>e?e+65:52>e?e+71:62>e?e-4:62===e?43:63===e?47:65,p=p+String.fromCharCode(e);g=0}return p.substr(0,p.length-2+m)+(2===m?"":1===m?"=":"==")}};A.prototype.Base64=D;var z=function(){var c={1026:128,1027:129,8218:130,1107:131,8222:132,8230:133,8224:134,8225:135,8364:136,8240:137,1033:138,8249:139,1034:140,1036:141,1035:142,1039:143,1106:144,8216:145,8217:146,8220:147,8221:148,8226:149,8211:150,8212:151,8482:153,1113:154,8250:155,1114:156,
1116:157,1115:158,1119:159,160:160,1038:161,1118:162,1032:163,164:164,1168:165,166:166,167:167,1025:168,169:169,1028:170,171:171,172:172,173:173,174:174,1031:175,176:176,177:177,1030:178,1110:179,1169:180,181:181,182:182,183:183,1105:184,8470:185,1108:186,187:187,1112:188,1029:189,1109:190,1111:191},m={},p;for(p in c)m[c[p]]=p;return{decode:function(q,g){g=(g||"win1251").toLowerCase().replace("-","");for(var a=[],h=0,e=q.length;h<e;h++){var d=q.charCodeAt(h);if("utf8"===g)128>d?a.push(d):(2048>d?
a.push(192+(d>>>6)):(65536>d?a.push(224+(d>>>12)):(2097152>d?a.push(240+(d>>>18)):(67108864>d?a.push(248+(d>>>24)):(a.push(252+(d>>>30)),a.push(128+(d>>>24&63))),a.push(128+(d>>>18&63))),a.push(128+(d>>>12&63))),a.push(128+(d>>>6&63))),a.push(128+(d&63)));else if("unicode"===g||"ucs2"===g||"utf16"===g)if(55296>d||57344<=d&&65536>=d)a.push(d>>>8),a.push(d&255);else{if(65536<=d&&1114112>d){var d=d-65536,b=((1047552&d)>>10)+55296,d=(1023&d)+56320;a.push(b>>>8);a.push(b&255);a.push(d>>>8);a.push(d&255)}}else"utf32"===
g||"ucs4"===g?(a.push(d>>>24&255),a.push(d>>>16&255),a.push(d>>>8&255),a.push(d&255)):"win1251"===g?(128<=d&&(d=1040<=d&&1104>d?d-848:c[d]||0),a.push(d)):a.push(d&255)}return(new Uint8Array(a)).buffer},encode:function(c,g){g=(g||"win1251").toLowerCase().replace("-","");for(var a=[],h=new Uint8Array(s(c)),e=0,d=h.length;e<d;e++){var b=h[e];if("utf8"===g)b=252<=b&&254>b&&e+5<d?1073741824*(b-252)+(h[++e]-128<<24)+(h[++e]-128<<18)+(h[++e]-128<<12)+(h[++e]-128<<6)+h[++e]-128:b>>248&&252>b&&e+4<d?(b-248<<
24)+(h[++e]-128<<18)+(h[++e]-128<<12)+(h[++e]-128<<6)+h[++e]-128:b>>240&&248>b&&e+3<d?(b-240<<18)+(h[++e]-128<<12)+(h[++e]-128<<6)+h[++e]-128:224<=b&&240>b&&e+2<d?(b-224<<12)+(h[++e]-128<<6)+h[++e]-128:192<=b&&224>b&&e+1<d?(b-192<<6)+h[++e]-128:b;else if("unicode"===g||"ucs2"===g||"utf16"===g){if(b=(b<<8)+h[++e],55296<=b&&57344>b)var k=b-55296<<10,b=h[++e],b=(b<<8)+h[++e],b=k+(b-56320)+65536}else"utf32"===g||"ucs4"===g?(b=(b<<8)+h[++e],b=(b<<8)+h[++e],b=(b<<8)+h[++e]):"win1251"===g&&128<=b&&(b=192<=
b&&256>b?b+848:m[b]||0);a.push(String.fromCharCode(b))}return a.join("")}}}();A.prototype.Chars=z;var G={decode:function(c,m){c=c.replace(/[^A-fa-f0-9]/g,"");var p=Math.ceil(c.length/2),q=new Uint8Array(p);c=(0<c.length%2?"0":"")+c;if(m&&("string"!==typeof m||0>m.toLowerCase().indexOf("little")))for(var g=0;g<p;g++)q[g]=parseInt(c.substr(2*(p-g-1),2),16);else for(g=0;g<p;g++)q[g]=parseInt(c.substr(2*g,2),16);return q.buffer},encode:function(c,m){var p=[],q=new Uint8Array(s(c)),g=q.length;if(m&&("string"!==
typeof m||0>m.toLowerCase().indexOf("little")))for(var a=0;a<g;a++){var h=g-a-1;p[h]=(0<h&&0===h%32?"\r\n":"")+("00"+q[a].toString(16)).slice(-2)}else for(a=0;a<g;a++)p[a]=(0<a&&0===a%32?"\r\n":"")+("00"+q[a].toString(16)).slice(-2);return p.join("")}};A.prototype.Hex=G;var E={decode:function(c){c=(c||"").replace(/[^\-A-fa-f0-9]/g,"");0===c.length&&(c="0");var m=!1;"-"===c.charAt(0)&&(m=!0,c=c.substring(1));for(;"0"===c.charAt(0)&&1<c.length;)c=c.substring(1);c=(0<c.length%2?"0":"")+c;if(!m&&!/^[0-7]/.test(c)||
m&&!/^[0-7]|8[0]+$/.test(c))c="00"+c;for(var p=c.length/2,q=new Uint8Array(p),g=0,p=p-1;0<=p;--p){var a=parseInt(c.substr(2*p,2),16);m&&0<a+g&&(a=256-a-g,g=1);q[p]=a}return q.buffer},encode:function(c){c=new Uint8Array(s(c));if(0===c.length)return"0x00";for(var m=[],p=127<c[0],q=0,g=c.length-1;0<=g;--g){var a=c[g];p&&0<a+q&&(a=256-a-q,q=1);m[g]=("00"+a.toString(16)).slice(-2)}for(m=m.join("");"0"===m.charAt(0);)m=m.substring(1);return(p?"-":"")+"0x"+m}};A.prototype.Int16=E;var F=function(){function c(q,
g){var a=q.object;void 0===a&&(a=q);var h=q.tagClass=q.tagClass||0;if(0===h){var e=q.tagNumber;if("undefined"===typeof e)if("string"===typeof a)e=""===a?5:/^\-?0x[0-9a-fA-F]+$/.test(a)?2:/^(\d+\.)+\d+$/.test(a)?6:/^[01]+$/.test(a)?3:/^(true|false)$/.test(a)?1:/^[0-9a-fA-F]+$/.test(a)?4:19;else if("number"===typeof a)e=2;else if("boolean"===typeof a)e=1;else if(a instanceof Array)e=16;else if(a instanceof C)e=24;else if(a instanceof v||a&&a.buffer instanceof v)e=4;else throw new y("Unrecognized type for "+
a);}var d=q.tagConstructed;"undefined"===typeof d&&(d=q.tagConstructed=a instanceof Array);var b;if(a instanceof v||a&&a.buffer instanceof v)b=new Uint8Array(s(a)),3===e&&(a=new Uint8Array(s(b)),b=new Uint8Array(a.length+1),b[0]=0,b.set(a,1));else if(d)if(a instanceof Array){for(var k=0,n=[],m=0,l=0,f=a.length;l<f;l++)n[l]=c(a[l],g),k+=n[l].length;17===e&&n.sort(function(a,b){for(var c=0,d=Math.min(a.length,b.length);c<d;c++){var e=a[c]-b[c];if(0!==e)return e}return a.length-b.length});"CER"===g&&
(n[f]=new Uint8Array(2),k+=2);b=new Uint8Array(k);l=0;for(f=n.length;l<f;l++)b.set(n[l],m),m+=n[l].length}else throw new y("Constracted block can't be primitive");else switch(e){case 1:b=new Uint8Array(1);b[0]=a?255:0;break;case 2:case 10:b=E.decode("number"===typeof a?"0x"+a.toString(16):a);break;case 3:if("string"===typeof a)for(l=7-(a.length+7)%8,f=Math.ceil(a.length/8),b=new Uint8Array(f+1),b[0]=l,l=0;l<f;l++){for(k=n=0;8>k;k++)var u=8*l+k,n=(n<<1)+(u<a.length?"1"===a.charAt(u)?1:0:0);b[l+1]=
n}break;case 4:b=G.decode("number"===typeof a?a.toString(16):a);break;case 6:a=a.match(/\d+/g);b=[];for(l=1;l<a.length;l++){f=+a[l];n=[];1===l&&(f+=40*a[0]);do n.push(f&127),f>>>=7;while(f);for(k=n.length-1;0<=k;--k)b.push(n[k]+(0===k?0:128))}b=new Uint8Array(b);break;case 12:b=z.decode(a,"utf8");break;case 18:case 22:case 19:case 20:case 21:case 25:case 26:case 27:l=0;for(f=a.length;l<f;l++)255<a.charCodeAt(l)&&(e=12);b=12===e?z.decode(a,"utf8"):z.decode(a,"ascii");break;case 23:case 24:b=a.original;
if(!b){b=new C(a);b.setMinutes(b.getMinutes()+b.getTimezoneOffset());for(f=b.getMilliseconds().toString();0<f.length&&"0"===f.charAt(f.length-1);)f=f.substring(0,f.length-1);0<f.length&&(f="."+f);b=(23===e?b.getYear().toString().slice(-2):b.getFullYear().toString())+("00"+(b.getMonth()+1)).slice(-2)+("00"+b.getDate()).slice(-2)+("00"+b.getHours()).slice(-2)+("00"+b.getMinutes()).slice(-2)+("00"+b.getSeconds()).slice(-2)+f+"Z"}b=z.decode(b,"ascii");break;case 28:b=z.decode(a,"utf32");break;case 30:b=
z.decode(a,"utf16")}b||(b=new Uint8Array(0));b instanceof v&&(b=new Uint8Array(b));if(!d&&"CER"===g)switch(e){case 3:u=1;case 4:case 12:case 18:case 19:case 20:case 21:case 22:case 25:case 26:case 27:case 28:case 30:u=u||0;k=0;n=[];m=0;l=u;for(f=b.length;l<f;l+=1E3-u)n[l]=c({object:new Unit8Array(b.buffer,l,Math.min(1E3-u,f-l)),tagNumber:e,tagClass:0,tagConstructed:!1},g),k+=n[l].length;n[f]=new Uint8Array(2);b=new Uint8Array(k+2);l=0;for(f=n.length;l<f;l++)b.set(n[l],m),m+=n[l].length}q.tagNumber=
0===h?e:e=q.tagNumber||0;q.content=b;u=[];f=3===h?192:2===h?128:1===h?64:0;d&&(f|=32);if(31>e)u.push(f|e&31);else{f|=31;u.push(f);f=e;l=[];do l.push(f&127),f>>>=7;while(f);for(k=l.length-1;0<=k;--k)u.push(l[k]+(0===k?0:128))}if(d&&"CER"===g)u.push(128);else if(d=b.length,127<d){f=d;d=[];do d.push(f&255),f>>>=8;while(f);u.push(d.length+128);for(k=d.length-1;0<=k;--k)u.push(d[k])}else u.push(d);d=q.header=new Uint8Array(u);q.typeName=1===h?"Application_"+e:2===h?"["+e.toString()+"]":3===h?"Private_"+
e:p[e]||"Universal_"+e.toString();h=new Uint8Array(d.length+b.length);h.set(d,0);h.set(b,d.length);return h}function m(c,g){var a=g||0,h=c[a++],e=h>>6,d=0!==(h&32),b=h&31;if(31===b){b=0;do{if(9007199254740864<b)throw new y("Convertor not supported tag number more then (2^53 - 1) at position "+g);h=c[a++];b=(b<<7)+(h&127)}while(h&128)}var h=c[a++],k=h&127;if(k!==h){if(6<k)throw new y("Length over 48 bits not supported at position "+g);if(0===k)k=null;else{for(var n=h=0;n<k;++n)h=(h<<8)+c[a++];k=h}}var x=
a,l=null;if(d)if(l=[],null!==k){for(h=x+k;a<h;){var f=m(c,a);l.push(f);a+=f.header.length+f.content.length}if(a!==h)throw new y("Content size is not correct for container starting at offset "+x);}else try{for(;;){f=m(c,a);a+=f.header.length+f.content.length;if(0===f.tagClass&&0===f.tagNumber)break;l.push(f)}k=a-x}catch(u){throw new y("Exception "+u+" while decoding undefined length content at offset "+x);}var w="",a=new Uint8Array(c.buffer,g,x-g),t=h=new Uint8Array(c.buffer,x,k);if(null!==l&&0===
e){var r;switch(b){case 3:r=1;case 4:case 12:case 18:case 19:case 20:case 21:case 22:case 25:case 26:case 27:case 28:case 30:r=r||0;if(0===l.length)throw new y("No constructed encoding content of string type at offset "+x);for(var k=r,n=0,s=l.length;n<s;n++){f=l[n];if(f.tagClass!==e||f.tagNumber!==b||f.tagConstructed)throw new y("Invalid constructed encoding of string type at offset "+x);k+=f.content.length-r}for(var t=new Uint8Array(k),n=0,s=l.length,v=r;n<s;n++)f=l[n],0<r?t.set(f.content.subarray(1),
v):t.set(f.content,v),v+=f.content.length-r;d=!1;l=null}}if(null===l){if(null===k)throw new y("Invalid tag with undefined length at offset "+x);if(0===e)switch(b){case 1:w=0!==t[0];break;case 2:case 10:if(6<k)w=E.encode(t);else{r=t[0];127<t[0]&&(r-=256);for(n=1;n<k;n++)r=256*r+t[n];w=r}break;case 3:if(5<k)w=(new Uint8Array(t.subarray(1))).buffer;else{x=t[0];f=[];for(n=k-1;1<=n;--n){k=t[n];for(v=x;8>v;++v)f.push(k>>v&1?"1":"0");x=0}w=f.reverse().join("")}break;case 4:w=(new Uint8Array(t)).buffer;break;
case 6:f="";for(n=l=s=0;n<k;++n)r=t[n],s=(s<<7)+(r&127),l+=7,r&128||(""===f?(r=80>s?40>s?0:1:2,f=r+"."+(s-40*r)):f+="."+s.toString(),l=s=0);if(0<l)throw new y("Incompleted OID at offset "+x);w=f;break;case 16:case 17:w=[];break;case 12:w=z.encode(t,"utf8");break;case 18:case 19:case 20:case 21:case 22:case 25:case 26:case 27:w=z.encode(t,"ascii");break;case 28:w=z.encode(t,"utf32");break;case 30:w=z.encode(t,"utf16");break;case 23:case 24:k=23===b;f=z.encode(t,"ascii");r=(k?/^(\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/:
/^(\d\d\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/).exec(f);if(!r)throw new y('Unrecognized time format "'+f+'" at offset '+x);k&&(r[1]=+r[1],r[1]+=50>r[1]?2E3:1900);k=new C(r[1],+r[2]-1,+r[3],+(r[4]||0),+(r[5]||0),+(r[6]||0),+(r[7]||0));n=k.getTimezoneOffset();if(r[8]||23===b)"Z"!==r[8].toUpperCase()&&r[9]&&(n+=parseInt(r[9])),k.setMinutes(k.getMinutes()-n);k.original=f;w=k}else w=(new Uint8Array(t)).buffer}else w=
l;return{tagConstructed:d,tagClass:e,tagNumber:b,header:a,content:h,typeName:1===e?"Application_"+b:2===e?"["+b.toString()+"]":3===e?"Private_"+b:p[b]||"Universal_"+b.toString(),object:w}}var p={0:"EOC",1:"BOOLEAN",2:"INTEGER",3:"BIT STRING",4:"OCTET STRING",5:"NULL",6:"OBJECT IDENTIFIER",7:"ObjectDescriptor",8:"EXTERNAL",9:"REAL",10:"ENUMERATED",11:"EMBEDDED PDV",12:"UTF8String",16:"SEQUENCE",17:"SET",18:"NumericString",19:"PrintableString",20:"TeletexString",21:"VideotexString",22:"IA5String",23:"UTCTime",
24:"GeneralizedTime",25:"GraphicString",26:"VisibleString",27:"GeneralString",28:"UniversalString",30:"BMPString"};return{encode:function(m,g){return c(m,g).buffer},decode:function(c){return m(new Uint8Array(s(c)),0)}}}();A.prototype.BER=F;A.prototype.PEM={encode:function(c,m){return(m?"-----BEGIN "+m.toUpperCase()+"-----\r\n":"")+D.encode(c instanceof v?c:F.encode(c))+(m?"\r\n-----END "+m.toUpperCase()+"-----":"")},decode:function(c,m,p,q){var g=/([A-Za-z0-9\+\/\s\=]+)/g.exec(c);g[1].length!==c.length&&
(g=!1);!g&&m&&(g=(new RegExp("-----\\s?BEGIN "+m.toUpperCase()+"-----([A-Za-z0-9\\+\\/\\s\\=]+)-----\\s?END "+m.toUpperCase()+"-----","g")).exec(c));g||(g=/-----\s?BEGIN [A-Z0-9\s]+-----([A-Za-z0-9\+\/\s\=]+)-----\s?END [A-Z0-9\s]+-----/g.exec(c));c=g&&g[1+(q||0)];if(!c)throw new y("Not valid PEM format");c=D.decode(c);p&&(c=F.decode(c));return c}};B.coding=new A;return A});
