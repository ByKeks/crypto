/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(m,v){"function"===typeof define&&define.amd?define(["gostCrypto","gostASN1"],v):"object"===typeof exports?module.exports=v(require("gostCrypto"),require("gostASN1")):m.GostCert=v(m.gostCrypto,m.GostASN1)})(this,function(m){function v(a){for(var b=1,c=arguments.length;b<c;b++){var d=arguments[b];if("object"===typeof d)for(var f in d)d.hasOwnProperty(f)&&(a[f]=d[f])}return a}function t(a){var b=function(){};b.prototype=a.prototype;for(var b=[new b],c=1;c<arguments.length;c++)b.push(arguments[c]);
return v.apply(this,b)}function w(a){var b=new P;b.setHours(0,0,0,0);a&&b.setDate(b.getDate()+a);return b}function n(a){try{a()}catch(b){}}function Q(){var a=new Uint8Array(4);m.getRandomValues(a);a[0]&=127;return R.Int16.encode(a)}function B(a,b){for(var c in a)if(a[c]!==b[c])return!1;for(c in b)if(a[c]!==b[c])return!1;return!0}function x(a,b){var c=a.extensions&&a.extensions.subjectKeyIdentifier,d;if((d=a&&b&&(!b.issuer||B(a.issuer,b.issuer))&&(!b.serialNumber||H(a.serialNumber,b.serialNumber)))&&
!(d=!b.subjectKeyIdentifier))a:if(d=b.subjectKeyIdentifier,c=new Uint8Array(c),d=new Uint8Array(d),c.length!==d.length)d=!1;else{for(var f=0,k=c.length;f<k;f++)if(c[f]!==d[f]){d=!1;break a}d=!0}return d&&(!b.subject||B(a.subject,b.subject))&&(!b.date||a.notBefore.getTime()<=b.date.getTime()&&a.notAfter.getTime()>b.date.getTime())}function C(a,b,c){a={subject:a.issuer,date:c};if(b=b&&b.authorityKeyIdentifier)a.subjectKeyIdentifier=b.keyIdentifier,b.authorityCertIssuer&&b.authorityCertIssuer[0]&&b.authorityCertSerialNumber&&
(a.issuer=b.authorityCertIssuer[0],a.serialNumber=b.authorityCertSerialNumber);return a}function A(a,b){for(var c=[],d=0,f=a.length;d<f;d++)x(a[d],b)&&c.push(a[d]);return c}function I(a,b){return(!b.issuer||B(a.issuer,b.issuer))&&(!b.date||a.thisUpdate.getTime()<b.date.getTime())}function J(a,b){for(var c=[],d=0,f=a.length;d<f;d++)I(a[d],b)&&c.push(a[d]);return c}function E(a){a=a.id;for(var b in s){var c=s[b];if(c.publicKey.id===a)return c}}function K(a,b,c){for(var d in b){var f=a,k=d,g=b[d];"object"!==
typeof g&&(g={value:g});void 0!==c&&(g.enumerable=c);y.defineProperty(f,k,g)}}function t(a,b,c,d){"function"!==typeof b&&(d=c,c=b,b=function(){a.apply(this,arguments)});b.prototype=y.create(a.prototype,{constructor:{value:b},superclass:{value:a.prototype}});c&&K(b.prototype,c,!0);if(a!==y)for(var f in a)b[f]=a[f];b.super=a;d&&K(b,d,!0);return b}function r(){}function L(a){try{e.CertificationRequest.call(this,a,!0)}catch(b){a=a||{},e.CertificationRequest.call(this,{version:0,subject:a.subject||l.subject,
subjectPublicKeyInfo:a.subjectPublicKeyInfo||{algorithm:{id:"noSignature"},subjectPublicKey:new D(0)},attributes:a.attributes||{extensionRequest:{keyUsage:l.userKeyUsage,extKeyUsage:l.userExtKeyUsage}},signatureAlgorithm:{id:"noSignature"},signatureValue:new D(0)})}}function M(a,b){this.certificates=a||[];this.crls=b||[]}function N(a){this.certStore=a}function F(){}function O(a,b,c){this.trustedCACerts=a||[];this.requireCRL=b||!1;this.requireCA=c||!0}var p=this.Promise,y=this.Object,D=this.ArrayBuffer,
P=this.Date,h=m.subtle,R=m.coding,e=m.asn1,s=m.security.providers,H=function(){var a=function(a){var b=typeof a;return"undefined"===b||""===a?"0":"number"===b||a instanceof Number?a.toString(16).toLowerCase():a.replace("0x","").toLowerCase()},b=function(a,b){return(Array(b+1).join("0")+a).slice(-b)};return function(c,d){c=a(c);d=a(d);var f=Math.max(c.length,d.length);return b(c,f)===b(d,f)}}(),l={providerName:"CP-01",subject:{countryName:"RU",commonName:"Anonymous"},caKeyUsage:"digitalSignature nonRepudiation keyEncipherment dataEncipherment keyAgreement keyCertSign cRLSign".split(" "),
caExtKeyUsage:"serverAuth clientAuth codeSigning emailProtection ipsecEndSystem ipsecTunnel ipsecUser timeStamping OCSPSigning".split(" "),userKeyUsage:["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement"],userExtKeyUsage:["clientAuth","emailProtection"],days:7305};r.prototype.options=l;var u=function(a){try{e.Certificate.call(this,a,!0)}catch(b){try{a=new e.CertificationRequest(a,!0)}catch(c){}a=a||{};e.Certificate.call(this,{version:2,serialNumber:a.serialNumber||
Q(),signature:a.signature||{id:"noSignature"},issuer:a.subject||l.subject,notBefore:a.notBefore||w(),notAfter:a.notAfter||w(a.days||l.days),subject:a.subject||l.subject,subjectPublicKeyInfo:a.subjectPublicKeyInfo||{algorithm:{id:"noSignature"},subjectPublicKey:new D(0)},extensions:a.attributes&&(a.attributes.extensionRequest||a.attributes.msCertExtensions)||a.extensions,signatureAlgorithm:{id:"noSignature"},signatureValue:new D(0)})}};t(e.Certificate,u,{sign:function(a,b){var c=this,d=c.subjectPublicKeyInfo;
return(new p(n)).then(function(){if(!d||!d.algorithm||"noSignature"===d.algorithm)throw Error("Key pair was not generated for the certificate");if(!a)throw Error("The private key of the issuer is not defined");b=b||c;return h.digest("SHA-1",d.subjectPublicKey)}).then(function(d){var k=b.getProvider()||s[l.providerName];c.signature&&"noSignature"!==c.signature.id||(c.signature=k.signature);c.signatureAlgorithm=c.signature;c.issuer=b.subject;c.extensions||(c.extensions={});var k=c.extensions,g=b.extensions;
if(c===b)k.keyUsage=k.keyUsage||l.caKeyUsage,k.extKeyUsage=k.extKeyUsage||l.caExtKeyUsage,k.basicConstraints=k.basicConstraints||{cA:!0};else{if(!b.checkUsage("keyCertSign",c.notBefore))throw Error("The issuer's certificate is not valid for signing a certificate");k.keyUsage=k.keyUsage||l.userKeyUsage;k.extKeyUsage=k.extKeyUsage||l.userExtKeyUsage;k.basicConstraints=k.basicConstraints||{cA:0<=k.keyUsage.indexOf("keyCertSign")};if(k.basicConstraints.cA){var G=g&&g.basicConstraints&&g.pathLenConstraint;
if(void 0!==G)if(0<G)k.basicConstraints.pathLenConstraint=G-1;else throw Error("Path length constraint exceeded");}}k.subjectKeyIdentifier=d;g&&g.subjectKeyIdentifier&&(k.authorityKeyIdentifier={keyIdentifier:g.subjectKeyIdentifier,authorityCertIssuer:[b.issuer],authorityCertSerialNumber:b.serialNumber});return h.importKey("pkcs8",e.PrivateKeyInfo.encode(a),a.privateKeyAlgorithm,!1,["sign"])}).then(function(a){return h.sign(c.signatureAlgorithm,a,e.TBSCertificate.encode(c))}).then(function(a){c.signatureValue=
a;return c})},generate:function(a){var b=this,c,d;(d=a?s[a]:this.getProvider()||s[l.providerName])&&(a=v(d.publicKey,{privateKey:d.privateKey}));return(new p(n)).then(function(){return h.generateKey(a,"true",["sign","verify"])}).then(function(a){c=a.privateKey;return h.exportKey("spki",a.publicKey)}).then(function(a){b.subjectPublicKeyInfo=new e.SubjectPublicKeyInfo(a);return h.exportKey("pkcs8",c)}).then(function(a){return new e.PrivateKeyInfo(a)})},getPublicKey:function(){var a=this.subjectPublicKeyInfo,
b="rsaEncryption"===a.algorithm.id?["verify"]:["verify","deriveKey","deriveBits"];return h.importKey("spki",e.SubjectPublicKeyInfo.encode(a),a.algorithm,"false",b)},getProvider:function(){return E(this.subjectPublicKeyInfo.algorithm)},verify:function(a,b,c){var d=this,f=d.extensions;return(new p(n)).then(function(){c=c||w();if(d.notBefore.getTime()>c.getTime()||d.notAfter.getTime()<=c.getTime())throw Error("The certificate has not yet started or expired");for(var b in f)if(f[b].critical&&0>"authorityKeyIdentifier subjectKeyIdentifier keyUsage certificatePolicies policyMappings basicConstraints nameConstraints policyConstraints extKeyUsage".split(" ").indexOf(b))throw Error("The critical extension '"+
b+"' is unrecognized");b=C(d,f,d.notBefore);!a&&x(d,b)&&(a=d);if(a){if(!x(a,b)||!a.checkUsage("keyCertSign",d.notBefore))throw Error("The issuer's certificate is not valid");return a.verifySignature(e.TBSCertificate.encode(d),d.signatureValue,d.signatureAlgorithm)}return!0}).then(function(a){if(!a)throw Error("The certificate has invalid signature");if(b){if(!I(b,{issuer:d.issuer,date:c}))throw Error("The issuer's CRL is not valid");if(b.isRevoked(d.serialNumber))throw Error("The certificate is revoked");
}return d})},verifySignature:function(a,b,c){return this.getPublicKey().then(function(d){return h.verify(c,d,b,a)})},checkUsage:function(a,b){var c=this.extensions;b=b||w();return this.notBefore.getTime()<=b.getTime()&&this.notAfter.getTime()>b.getTime()&&(!c||!(0<["keyCertSign","cRLSign"].indexOf(a)&&c.basicConstraints&&!c.basicConstraints.cA||c.keyUsage&&0>c.keyUsage.indexOf(a)&&c.extKeyUsage&&0>c.extKeyUsage.indexOf(a)))}});r.prototype.X509=u;var z=function(a){z.super.call(this,a);this.version||
(this.version=1);this.revokedCertificates||(this.revokedCertificates=[]);this.thisUpdate||(this.thisUpdate=w())};t(e.CertificateList,z,{sign:function(a,b){var c=this;return(new p(n)).then(function(){if(!a)throw Error("The issuer's private key is not defined");if(!b)throw Error("The issuer's certificate is not defined");if(!c.issuer)c.issuer=b.issuer;else if(!B(c.issuer,b.issuer))throw Error("The CRL prototype and authority certificate have different issuers");if(!b.checkUsage("cRLSign",c.thisUpdate))throw Error("The issuer's certificate is not valid for signing a CRL");
var d=b.getProvider()||s[l.providerName];c.signature||(c.signature=d.signature);c.signatureAlgorithm=c.signature;c.issuer=b.subject;c.crlExtensions||(c.crlExtensions={});var d=c.crlExtensions,f=b.extensions;f&&f.subjectKeyIdentifier&&(d.authorityKeyIdentifier={keyIdentifier:f.subjectKeyIdentifier,authorityCertIssuer:[b.issuer],authorityCertSerialNumber:b.serialNumber});d.cRLNumber=d.cRLNumber||0;return h.importKey("pkcs8",e.PrivateKeyInfo.encode(a),a.privateKeyAlgorithm,!1,["sign"])}).then(function(a){return h.sign(c.signatureAlgorithm,
a,e.TBSCertList.encode(c))}).then(function(a){c.signatureValue=a;return c})},verify:function(a,b){var c=this,d=c.crlExtensions;return(new p(n)).then(function(){b=b||w();if(!c.thisUpdate.getTime()>b.getTime())throw Error("The CRL has not yet started");if(a){if(!x(a,C(c,d,c.thisUpdate))||!a.checkUsage("cRLSign",c.thisUpdate))throw Error("The issuer's certificate is not valid");if(!c.signatureValue||!c.signatureAlgorithm)throw Error("The has no signature");return a.verifySignature(e.TBSCertList.encode(c),
c.signatureValue,c.signatureAlgorithm)}}).then(function(a){if(!a)throw Error("The CRL has invalid signature");return c})},isRevoked:function(a,b){var c=this.revokedCertificates;b=b||w();for(var d=0;d<c.length;d++)if(b.getTime()>=c[d].revocationDate.getTime()&&H(c[d].userCertificate,a))return!0;return!1}});r.prototype.CRL=z;t(e.CertificationRequest,L,{generate:function(a){var b=this,c,d;(d=a?s[a]:this.getProvider()||s[l.providerName])&&(a=v(d.publicKey,{privateKey:d.privateKey}));return(new p(n)).then(function(){return h.generateKey(a,
"true",["sign","verify"])}).then(function(a){c=a.privateKey;return h.exportKey("spki",a.publicKey)}).then(function(a){b.subjectPublicKeyInfo=new e.SubjectPublicKeyInfo(a);return h.exportKey("pkcs8",c)}).then(function(a){c=new e.PrivateKeyInfo(a);return b.sign(c)}).then(function(){return c})},getProvider:function(){return E(this.subjectPublicKeyInfo.algorithm)},sign:function(a){var b=this,c=b.subjectPublicKeyInfo;return(new p(n)).then(function(){if(!c||!c.algorithm||"noSignature"===c.algorithm)throw Error("Key pair was not generated for the certificate");
if(!a)throw Error("The private key is not defined");var d=E(c.algorithm)||s[l.providerName];b.signatureAlgorithm=d.signature;return h.importKey("pkcs8",e.PrivateKeyInfo.encode(a),a.privateKeyAlgorithm,!1,["sign"])}).then(function(a){return h.sign(b.signatureAlgorithm,a,e.CertificationRequestInfo.encode(b))}).then(function(a){b.signatureValue=a;return b})},verify:function(){var a=this,b=a.subjectPublicKeyInfo;return(new p(n)).then(function(){return h.importKey("spki",e.SubjectPublicKeyInfo.encode(b),
b.algorithm,"false",["verify"])}).then(function(b){return h.verify(a.signatureAlgorithm,b,a.signatureValue,e.CertificationRequestInfo.encode(a))}).then(function(b){if(!b)throw Error("The certification request has invalid signature");return a})}});r.prototype.Request=L;t(y,M,{getCertificates:function(a){return A(this.certificates,a)},getCRLs:function(a){return J(this.certificates,a)},load:function(a){var b=new e.ContentInfo(a);a=b.certificates;for(var b=b.crls,c=0;c<a.length;c++)this.certificates.push(new u(a[c]));
for(c=0;c<b.length;c++)this.crls.push(new z(b[c]));return this},store:function(){return new e.ContentInfo({contentType:"signedData",version:0,digestAlgorithms:[],encapContentInfo:{contentType:"data"},certificates:this.certs,crls:this.crls,signerInfos:[]})}});r.prototype.CertStore=M;t(y,N,{build:function(a,b){var c=this;return(new p(n)).then(function(){for(var d=new u(a),f=[],k=!1,g=[];d;){var e=[],h=[];f.push(d);if(!k){var e=c.certStore.getCRLs({issuer:d.issuer,date:b}),l=C(d,d.extensions,d.notBefore);
x(d,l)?k=!0:h=c.certStore.getCertificates(l)}h=0<h.length&&new u(h[0]);(e=0<e.length&&new z(e[0]))&&g.push(e.verify(h,b));g.push(d.verify(h,e,b));d=h}if(!k)throw Error("Root certificate is not found");return p.all(g).then(function(a){for(var b=0;b<a;b++)if(!a[b])throw Error("Certification path is not validated");return f})})}});r.prototype.CertPath=N;t(y,F,{getValidCertificate:function(a,b,c){}});r.prototype.CertificateTrustPolicy=F;t(F,O,{getValidCertificate:function(a,b,c,d){var f=this,e;return(new p(n)).then(function(){b=
b||[];c=c||[];var g=A(f.trustedCACerts,a);if(0<g.length)return new u(g[0]);g=A(b,a);if(0!==g.length){var g=new u(g[0]),h=!1,l=[];for(e=[];g;){var m=[],q=[];e.push(g);if(!h){m=J(c,{issuer:g.issuer,date:d});if(0===m.length&&f.requireCRL)return;a=C(g,g.extensions,g.notBefore);q=A(f.trustedCACerts,a);if(0===q.length){if(!x(g,a))if(q=A(b,a),0<q.length){var n=q[0].extensions;if(f.requireCA&&(!n||!n.basicConstraints||!n.basicConstraints.cA||void 0!==n.basicConstraints.pathLenConstraint&&n.basicConstraints.pathLenConstraint<
e.length-1))return}else return}else h=!0}q=0<q.length&&new u(q[0]);(m=0<m.length&&new z(m[0]))&&l.push(m.verify(q,d));l.push(g.verify(q,m,d));g=q}if(!h)throw Error("Trusted root certificate is not found");return p.all(l).then(function(a){for(var b=0;b<a;b++)if(!a[b])throw Error("Certification path is not validated");return e[0]})}})}});r.prototype.TrustedCAPolicy=O;m.cert=new r;return r});
