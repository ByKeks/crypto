/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(x,f){"function"===typeof define&&define.amd?define(["gostRandom"],f):"object"===typeof exports?module.exports=f(require("gostRandom")):x.gostCrypto=f(x.GostRandom)})(this,function(x){function f(a,c){if("string"===typeof a||a instanceof String)a={name:a};var d=a.name;if(!d)throw new u("Algorithm name not defined");var e=d.split("/"),e=e[0].split("-").concat(e.slice(1)),b={},d=e[0].replace(/[\.\s]/g,""),e=e.slice(1);if(0<=d.indexOf("28147"))b={name:"GOST 28147",version:1989,mode:(a.mode||
("sign"===c||"verify"===c?"MAC":"wrapKey"===c||"unwrapKey"===c?"KW":"ES")).toUpperCase(),length:a.length||64};else if(0<=d.indexOf("3412"))b={name:"GOST R 34.12",version:2015,mode:(a.mode||("sign"===c||"verify"===c?"MAC":"wrapKey"===c||"unwrapKey"===c?"KW":"ES")).toUpperCase(),length:a.length||64};else if(0<=d.indexOf("3411"))b={name:"GOST R 34.11",version:2012,mode:(a.mode||("deriveKey"===c||"deriveBits"===c?"KDF":"sign"===c||"verify"===c?"HMAC":"HASH")).toUpperCase(),length:a.length||256};else if(0<=
d.indexOf("3410"))b={name:"GOST R 34.10",version:2012,mode:(a.mode||("deriveKey"===c||"deriveBits"===c?"DH":"SIGN")).toUpperCase(),length:a.length||256};else if(0<=d.indexOf("SHA"))b={name:"SHA",version:160===(a.length||160)?1:2,mode:(a.mode||("deriveKey"===c||"deriveBits"===c?"KDF":"sign"===c||"verify"===c?"HMAC":"HASH")).toUpperCase(),length:a.length||160};else if(0<=d.indexOf("RC2"))b={name:"RC2",version:1,mode:(a.mode||("sign"===c||"verify"===c?"MAC":"wrapKey"===c||"unwrapKey"===c?"KW":"ES")).toUpperCase(),
length:a.length||32};else if(0<=d.indexOf("PBKDF2"))b=f(a.hash,"digest"),b.mode="PBKDF2";else if(0<=d.indexOf("PFXKDF"))b=f(a.hash,"digest"),b.mode="PFXKDF";else if(0<=d.indexOf("CPKDF"))b=f(a.hash,"digest"),b.mode="CPKDF";else if(0<=d.indexOf("HMAC"))b=f(a.hash,"digest"),b.mode="HMAC";else throw new q("Algorithm not supported");e.forEach(function(a){a=a.toUpperCase();if(/^[0-9]+$/.test(a))if(0<=["8","16","32"].indexOf(a)||"128"===b.length&&"64"===a)if("ES"===b.mode)b.shiftBits=parseInt(a);else if("MAC"===
b.mode)b.macLength=parseInt(a);else throw new q("Algorithm "+b.name+" mode "+a+" not supported");else 0<="89 94 01 12 15 1989 1994 2001 2012 2015".split(" ").indexOf(a)?(a=parseInt(a),b.version=1900>a?80>a?2E3+a:1900+a:a):0<=["1"].indexOf(a)&&"SHA"===b.name?(b.version=1,b.length=160):0<=["256","384","512"].indexOf(a)&&"SHA"===b.name?(b.version=2,b.length=parseInt(a)):0<=["40","128"].indexOf(a)&&"RC2"===b.name?(b.version=1,b.length=parseInt(a)):0<=["64","128","256","512"].indexOf(a)?b.length=parseInt(a):
0<=["1000","2000"].indexOf(a)&&(b.iterations=parseInt(a));else if(0<="E-TEST E-A E-B E-C E-D E-SC E-Z D-TEST D-A D-SC".split(" ").indexOf(a))b.sBox=a;else if(0<="S-TEST S-A S-B S-C S-D X-A X-B X-C".split(" ").indexOf(a))b.namedParam=a;else if(0<="S-256-TEST S-256-A S-256-B S-256-C P-256 T-512-TEST T-512-A T-512-B X-256-A X-256-B T-256-TEST T-256-A T-256-B S-256-B T-256-C S-256-C".split(" ").indexOf(a))b.namedCurve=a;else if(0<=["SC","CP"].indexOf(a))b.procreator=a;else if("GOST 28147"===b.name||"GOST R 34.12"===
b.name||"RC2"===b.name)if(0<=["ES","MAC","KW","MASK"].indexOf(a))b.mode=a;else if(0<=["ECB","CFB","OFB","CTR","CBC"].indexOf(a))b.mode="ES",b.block=a;else if(0<=["CPKW","NOKW","SCKW"].indexOf(a))b.mode="KW",b.keyWrapping=a.replace("KW","");else if(0<=["ZEROPADDING","PKCS5PADDING","NOPADDING","RANDOMPADDING","BITPADDING"].indexOf(a))b.padding=a.replace("PADDING","");else if(0<=["NOKM","CPKM"].indexOf(a))b.keyMeshing=a.replace("KM","");else throw new q("Algorithm "+b.name+" mode "+a+" not supported");
else if("GOST R 34.11"===b.name||"SHA"===b.name)if(0<="HASH KDF HMAC PBKDF2 PFXKDF CPKDF".split(" ").indexOf(a))b.mode=a;else throw new q("Algorithm "+b.name+" mode "+a+" not supported");else if("GOST R 34.10"===b.name){var c=a.replace(/[\.\s]/g,"");if(0<=c.indexOf("GOST")&&0<=c.indexOf("3411"))b.hash=a;else if(["SIGN","DH","MASK"].indexOf(a))b.mode=a;else throw new q("Algorithm "+b.name+" mode "+a+" not supported");}});b.procreator=b.procreator||"CP";switch(b.name){case "GOST 28147":case "GOST R 34.12":b.keySize=
32;break;case "RC2":b.keySize=Math.ceil(b.length/8);break;case "GOST R 34.11":case "SHA":b.keySize=b.length/8;break;case "GOST R 34.10":b.keySize=b.length/(1994===b.version?4:8)}if("ES"===b.mode&&(a.block&&(b.block=a.block),b.block&&(b.block=b.block.toUpperCase()),a.padding&&(b.padding=a.padding),b.padding&&(b.padding=b.padding.toUpperCase()),a.shiftBits&&(b.shiftBits=a.shiftBits),a.keyMeshing&&(b.keyMeshing=a.keyMeshing),b.keyMeshing&&(b.keyMeshing=b.keyMeshing.toUpperCase()),"importKey"!==c&&"generateKey"!==
c)){b.block=b.block||"ECB";b.padding=b.padding||("CBC"===b.block||"ECB"===b.block?"ZERO":"NO");if("CFB"===b.block||"OFB"===b.block)b.shiftBits=b.shiftBits||b.length;b.keyMeshing=b.keyMeshing||"NO"}"KW"===b.mode&&(a.keyWrapping&&(b.keyWrapping=a.keyWrapping),b.keyWrapping&&(b.keyWrapping=b.keyWrapping.toUpperCase()),"importKey"!==c&&"generateKey"!==c&&(b.keyWrapping=b.keyWrapping||"NO"));"sBox namedParam namedCurve curve param modulusLength".split(" ").forEach(function(c){a[c]&&(b[c]=a[c])});"importKey"!==
c&&"generateKey"!==c&&("GOST 28147"===b.name?b.sBox=b.sBox||("SC"===b.procreator?"E-SC":"E-A"):"GOST R 34.12"===b.name&&64===b.length?b.sBox="E-Z":"GOST R 34.11"===b.name&&1994===b.version?b.sBox=b.sBox||("SC"===b.procreator?"D-SC":"D-A"):"GOST R 34.10"===b.name&&1994===b.version?b.namedParam=b.namedParam||("DH"===b.mode?"X-A":"S-A"):"GOST R 34.10"===b.name&&2001===b.version?b.namedCurve=b.namedCurve||(256===b.length?"SC"===b.procreator?"P-256":"DH"===b.mode?"X-256-A":"S-256-A":"T-512-A"===b.mode):
"GOST R 34.10"===b.name&&2012===b.version&&(b.namedCurve=b.namedCurve||(256===b.length?"SC"===b.procreator?"P-256":"DH"===b.mode?"X-256-A":"S-256-A":"T-512-A"===b.mode)));switch(b.mode){case "DH":a.ukm&&(b.ukm=a.ukm);a["public"]&&(b["public"]=a["public"]);break;case "MASK":a.inverse&&(b.inverse=a.inverse);break;case "SIGN":case "KW":a.ukm&&(b.ukm=a.ukm);break;case "ES":case "MAC":a.iv&&(b.iv=a.iv);break;case "KDF":a.label&&(b.label=a.label);a.contex&&(b.context=a.contex);break;case "PBKDF2":a.salt&&
(b.salt=a.salt);a.iterations&&(b.iterations=a.iterations);a.diversifier&&(b.diversifier=a.diversifier);break;case "PFXKDF":a.salt&&(b.salt=a.salt);a.iterations&&(b.iterations=a.iterations);a.diversifier&&(b.diversifier=a.diversifier);break;case "CPKDF":a.salt&&(b.salt=a.salt),a.iterations&&(b.iterations=a.iterations)}if(c&&("ES"!==b.mode&&"SIGN"!==b.mode&&"MAC"!==b.mode&&"HMAC"!==b.mode&&"KW"!==b.mode&&"DH"!==b.mode&&"MASK"!==b.mode&&"generateKey"===c||"ES"!==b.mode&&("encrypt"===c||"decrypt"===c)||
"SIGN"!==b.mode&&"MAC"!==b.mode&&"HMAC"!==b.mode&&("sign"===c||"verify"===c)||"HASH"!==b.mode&&"digest"===c||"KW"!==b.mode&&"MASK"!==b.mode&&("wrapKey"===c||"unwrapKey"===c)||"DH"!==b.mode&&"PBKDF2"!==b.mode&&"PFXKDF"!==b.mode&&"CPKDF"!==b.mode&&"KDF"!==b.mode&&("deriveKey"===c||"deriveBits"===c)))throw new q("Algorithm mode "+b.mode+" not valid for method "+c);a.hash&&(b.hash=a.hash);b.hash&&(("string"===typeof b.hash||b.hash instanceof String)&&b.procreator&&(b.hash=b.hash+"/"+b.procreator),b.hash=
f(b.hash,"digest"));a.id&&(b.id=a.id);return b}function l(a){if(!k||!k.subtle||!a)return!1;var c="string"===typeof a||a instanceof String?c=a:a.name;if(!c)return!1;c=c.toUpperCase();return(0<=c.indexOf("KDF")||0<=c.indexOf("HMAC"))&&a.hash?l(a.hash):-1===c.indexOf("GOST")&&-1===c.indexOf("SHA-1")&&-1===c.indexOf("RC2")&&-1===c.indexOf("?DES")}function C(a,c){if(!a.algorithm)throw new u("Key algorithm not defined");if(!a.algorithm.name)throw new u("Key algorithm name not defined");var d=a.algorithm.name,
e="GOST 28147"===d||"GOST R 34.12"===d||"RC2"===d,b="GOST R 34.11"===d||"SHA"===d,n="GOST R 34.10"===d;if(!e&&!n&&!b)throw new q("Key algorithm "+d+" is unsupproted");if(!a.type)throw new u("Key type not defined");if((e||b)&&"secret"!==a.type||n&&"public"!==a.type&&"private"!==a.type)throw new D("Key type "+a.type+" is not valid for algorithm "+d);if(!a.usages||!a.usages.indexOf)throw new u("Key usages not defined");d=0;for(e=a.usages.length;d<e;d++)if(b=a.usages[d],("encrypt"===b||"decrypt"===b)&&
"secret"!==a.type||"sign"===b&&"public"===a.type||"verify"===b&&"private"===a.type)throw new H("Key type "+a.type+" is not valid for "+b);if(c&&-1===a.usages.indexOf(c))throw new E("Key usages is not contain method "+c);if(!a.buffer)throw new u("Key buffer is not defined");d=8*a.buffer.byteLength;e=8*a.algorithm.keySize;if("secret"===a.type&&d!==(e||256)&&(0<=a.usages.indexOf("encrypt")||0<=a.usages.indexOf("decrypt"))||"private"===a.type&&256!==d&&512!==d||"public"===a.type&&512!==d&&1024!==d)throw new u("Key buffer has wrong size "+
d+" bit");}function p(a,c,d){C(d,a);if(c){var e;switch(c.mode){case "ES":e=["sBox","keyMeshing","padding","block"];break;case "SIGN":e="namedCurve namedParam sBox curve param modulusLength".split(" ");break;case "MAC":e=["sBox"];break;case "MASK":e=["inverse"];break;case "KW":e=["keyWrapping","ukm"];break;case "DH":e="namedCurve namedParam sBox ukm curve param modulusLength".split(" ");break;case "KDF":e=["context","label"];break;case "PBKDF2":e=["sBox","iterations","salt"];break;case "PFXKDF":e=
["sBox","iterations","salt","diversifier"];break;case "CPKDF":e=["sBox","salt"]}e&&e.forEach(function(a){d.algorithm[a]&&(c[a]=d.algorithm[a])})}return d.buffer}function y(a,c,d,e,b){a={type:b||("GOST R 34.10"===a.name?"private":"secret"),extractable:c||"false",algorithm:a,usages:d||[],buffer:e};C(a);return a}function I(a,c,d,e,b,n){if(!e||!e.indexOf)throw new u("Key usages not defined");var f=e.filter(function(a){return"sign"!==a});e=e.filter(function(a){return"verify"!==a});return{publicKey:y(a,
d,f,b,"public"),privateKey:y(c,d,e,n,"private")}}function F(a){a instanceof ArrayBuffer&&(a=new Uint8Array(a));for(var c=new Uint8Array(a.length),d=0,e=a.length;d<e;d++)c[e-d-1]=a[d];return c.buffer}function G(){for(var a=0,c=arguments.length;a<c;a++){var d=arguments[a].split("."),d=z+d[0]+A+"."+d[1],e=document.querySelector('script[src="'+d+'"]');e||(e=document.createElement("script"),e.setAttribute("src",d),document.head.appendChild(e))}}function s(a,c,d){return new Promise(function(e,b){try{if(w){var n=
++J;v.push({id:n,resolve:e,reject:b});w.postMessage({id:n,algorithm:a,method:c,args:d})}else g.gostEngine?e(g.gostEngine.execute(a,c,d)):b(new B("Module gostEngine not found"))}catch(f){b(f)}})}function r(a){try{a()}catch(c){}}function h(){}var g=this,k=g.crypto||g.msCrypto,u=g.SyntaxError||Error,D=g.DataError||Error,q=g.NotSupportedError||Error,B=g.OperationError||Error,H=g.InvalidAccessError||Error,E=g.InvalidAccessError||Error;g.Promise||(g.Promise=function(){function a(a){return a&&null===a.oncomplete&&
null===a.onerror?new c(function(c,b){a.oncomplete=function(){c(a.result)};a.onerror=function(){b(new B(a.toString()))}}):a}function c(d){function e(a){try{a()}catch(b){}}var b="pending",n,f=[],g=[];try{d(function(a){"pending"===b&&(b="fulfilled",n=a,f.forEach(e))},function(a){"pending"===b&&(b="rejected",n=a,g.forEach(e))})}catch(m){"pending"===b&&(b="rejected",n=m,g.forEach(e))}this.then=function(d,e){return new c(function(c,m){function k(){var b;try{b=d?d(n):n}catch(e){m(e);return}(b=a(b))&&b.then&&
b.then.call?b.then(c,m):c(b)}function l(){var b;try{b=e?e(n):n}catch(d){m(d);return}(b=a(b))&&b.then&&b.then.call?b.then(c,m):m(b)}"fulfilled"===b?k():"rejected"===b?l():(f.push(k),g.push(l))})};this["catch"]=function(a){return this.then(void 0,a)}}c.all=function(a){return new c(function(c,b){function n(a){m++;return function(b){g[a]=b;m--;0===m&&c(g)}}function f(a){0<m&&b(a);m=0}for(var g=[],m=0,k=0,l=a.length;k<l;k++){var h=a[k];h.then&&h.then.call?h.then(n(k),f):g[k]=h}0===m&&c(g)})};return c}());
var z="",A="";"undefined"!==typeof document&&function(){for(var a=/^(.*)gostCrypto(.*)\.js$/i,c=document.querySelectorAll("script"),d=0,e=c.length;d<e;d++){var b=c[d].getAttribute("src");if(b=a.exec(b))z=b[1],A=b[2]}}();var w,v=[],J=0;if(!g.importScripts&&!g.gostEngine)try{w=new Worker(z+"gostEngine"+A+".js"),w.onmessage=function(a){for(var c=a.data.id,d=0,e=v.length;d<e&&v[d].id!==c;d++);d<e&&(c=v[d],v.splice(d,1),a.data.error?c.reject(new B(a.data.error)):c.resolve(a.data.result))},w.onerror=function(a){for(var c=
0,d=v.length;c<d;c++)v[c].reject(a.error);v=[]}}catch(K){w=!1}g.importScripts||(g.importScripts=G);w||g.gostEngine||G("gostEngine.js");var t={};h.prototype.encrypt=function(a,c,d){return(new Promise(r)).then(function(){if(l(a))return k.subtle.encrypt(a,c,d);a=f(a,"encrypt");return s(a,"encrypt",[p("encrypt",a,c),d])})};h.prototype.decrypt=function(a,c,d){return(new Promise(r)).then(function(){if(l(a))return k.subtle.decrypt(a,c,d);a=f(a,"decrypt");return s(a,"decrypt",[p("decrypt",a,c),d])})};h.prototype.sign=
function(a,c,d){return(new Promise(r)).then(function(){if(l(a))return k.subtle.sign(a,c,d);a=f(a,"sign");return s(a,"sign",[p("sign",a,c),d]).then(function(c){return"SC"===a.procreator&&"SIGN"===a.mode?t.asn1.GostSignature.encode(c):c})})};h.prototype.verify=function(a,c,d,e){return(new Promise(r)).then(function(){if(l(a))return k.subtle.verify(a,c,d,e);a=f(a,"verify");return s(a,"verify",[p("verify",a,c),"SC"===a.procreator&&"SIGN"===a.mode?t.asn1.GostSignature.decode(d):d,e])})};h.prototype.digest=
function(a,c){return(new Promise(r)).then(function(){if(l(a))return k.subtle.digest(a,c);a=f(a,"digest");return s(a,"digest",[c])})};h.prototype.generateKey=function(a,c,d){return(new Promise(r)).then(function(){if(l(a))return k.subtle.generateKey(a,c,d);var e=a.privateKey,b=a.publicKey;a=f(a,"generateKey");e=e?f(e,"generateKey"):a;b=b?f(b,"generateKey"):a;return s(a,"generateKey",[]).then(function(f){return f.publicKey&&f.privateKey?I(b,e,c,d,f.publicKey,f.privateKey):y(a,c,d,f)})})};h.prototype.deriveKey=
function(a,c,d,e,b){return(new Promise(r)).then(function(){if(l(a))return k.subtle.deriveKey(a,c,d,e,b);a=f(a,"deriveKey");d=f(d,"generateKey");a.keySize=d.keySize;a["public"]&&(a["public"].algorithm=f(a["public"].algorithm),a["public"]=p("deriveKey",a,a["public"]));return s(a,"deriveKey",[p("deriveKey",a,c)]).then(function(a){return y(d,e,b,a)})})};h.prototype.deriveBits=function(a,c,d){return(new Promise(r)).then(function(){if(l(a))return k.subtle.deriveBits(a,c,d);a=f(a,"deriveBits");a["public"]&&
(a["public"]=p("deriveBits",a,a["public"]));return s(a,"deriveBits",[p("deriveBits",a,c),d])})};h.prototype.importKey=function(a,c,d,e,b){return(new Promise(r)).then(function(){if(l(d))return k.subtle.importKey(a,c,d,e,b);var g,h,p;if("raw"===a)d=f(d,"importKey"),p=c,b&&b.indexOf&&(h=d.name.toUpperCase().replace(/[\.\s]/g,""),0<=h.indexOf("3410")&&0<=b.indexOf("sign")?g="private":0<=h.indexOf("3410")&&0<=b.indexOf("verify")&&(g="public"));else{if("pkcs8"===a)h=t.asn1.GostPrivateKeyInfo.decode(c).object;
else if("spki"===a)h=t.asn1.GostSubjectPublicKeyInfo.decode(c).object;else throw new q("Key format not supported");d=f(h.algorithm,"importKey");p=h.buffer;g=h.type;!1!==e&&(e=e||h.extractable);if(b)for(var m=0;m<b.length;m++){if(0>h.usages.indexOf(b[m]))throw D("Key usage not valid for this key");}else b=h.usages}return y(d,e,b,p,g)})};h.prototype.exportKey=function(a,c){return(new Promise(r)).then(function(){if(c&&l(c.algorithm))return k.subtle.exportKey(a,c);if(!c.extractable)throw new E("Key not extractable");
var d=p(null,null,c);if("raw"===a)return d;if("pkcs8"===a&&c.algorithm&&c.algorithm.id)return t.asn1.GostPrivateKeyInfo.encode(c);if("spki"===a&&c.algorithm&&c.algorithm.id)return t.asn1.GostSubjectPublicKeyInfo.encode(c);throw new q("Key format not supported");})};h.prototype.wrapKey=function(a,c,d,e){return(new Promise(r)).then(function(){if(l(e))return k.subtle.wrapKey(a,c,d,e);e=f(e,"wrapKey");var b=p(null,null,c);"SC"===e.procreator&&"private"===c.type&&(b=F(b));return s(e,"wrapKey",[p("wrapKey",
e,d),b]).then(function(b){if("raw"===a)return b;throw new q("Key format not supported");})})};h.prototype.unwrapKey=function(a,c,d,e,b,g,h){return(new Promise(r)).then(function(){if(l(e))return k.subtle.unwrapKey(a,c,d,e,b,g,h);e=f(e,"unwrapKey");b=f(b,"importKey");if("raw"!==a)throw new q("Key format not supported");return s(e,"unwrapKey",[p("unwrapKey",e,d),c]).then(function(a){var c;if(b&&b.name){var d=b.name.toUpperCase().replace(/[\.\s]/g,"");0<=d.indexOf("3410")&&0<=h.indexOf("sign")?c="private":
0<=d.indexOf("3410")&&0<=h.indexOf("verify")&&(c="public")}"SC"===e.procreator&&"private"===c&&(a=F(a));return y(b,g,h,a,c)})})};t.subtle=new h;t.getRandomValues=function(a){var c=(x=x||g.GostRandom)?new x:k;if(c.getRandomValues)c.getRandomValues(a);else throw new q("Random generator not found");};return t});
