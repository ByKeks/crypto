/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(s,h){"function"===typeof define&&define.amd?define(["gostRandom"],h):"object"===typeof exports?module.exports=h(require("gostRandom")):s.gostCrypto=h(s.gostRandom)})(this,function(s){function h(a,c){if("string"===typeof a||a instanceof String)a={name:a};var d=a.name;if(!d)throw new u("Algorithm name not defined");var e=d.split("/"),e=e[0].split("-").concat(e.slice(1)),b={},d=e[0].replace(/[\.\s]/g,""),e=e.slice(1);if(0<=d.indexOf("GOST")&&0<=d.indexOf("28147"))b={name:"GOST 28147",version:1989,
mode:(a.mode||("sign"===c||"verify"===c?"MAC":"wrapKey"===c||"unwrapKey"===c?"KW":"ES")).toUpperCase(),length:a.length||64};else if(0<=d.indexOf("GOST")&&0<=d.indexOf("3411"))b={name:"GOST R 34.11",version:2012,mode:(a.mode||("deriveKey"===c||"deriveBits"===c?"KDF":"sign"===c||"verify"===c?"HMAC":"HASH")).toUpperCase(),length:a.length||256};else if(0<=d.indexOf("GOST")&&0<=d.indexOf("3410"))b={name:"GOST R 34.10",version:2012,mode:(a.mode||("deriveKey"===c||"deriveBits"===c?"DH":"SIGN")).toUpperCase(),
length:a.length||256};else throw new p("Algorithm not supported");e.forEach(function(a){a=a.toUpperCase();if(/^[0-9]+$/.test(a))if(0<=["8","16","32"].indexOf(a)||"128"===b.length&&"64"===a)if("ES"===b.mode)b.shiftBits=parseInt(a);else if("MAC"===b.mode)b.macLength=parseInt(a);else throw new p("Algorithm "+b.name+" mode "+a+" not supported");else 0<="89 94 01 12 15 1989 1994 2001 2012 2015".split(" ").indexOf(a)?(a=parseInt(a),b.version=1900>a?80>a?2E3+a:1900+a:a):0<=["64","128","256","512"].indexOf(a)?
b.length=parseInt(a):0<=["1000","2000"].indexOf(a)&&(b.iterations=parseInt(a));else if(0<="E-DEFAULT E-TEST E-A E-B E-C E-D E-SC E-Z D-TEST D-A D-SC".split(" ").indexOf(a))b.sBox=a;else if(0<="S-TEST S-A S-B S-C S-D X-A X-B X-C".split(" ").indexOf(a))b.namedParam=a;else if(0<="S-256-TEST S-256-A S-256-B S-256-C P-256 T-512-TEST T-512-A T-512-B X-256-A X-256-B T-256-TEST T-256-A T-256-B S-256-B T-256-C S-256-C".split(" ").indexOf(a))b.namedCurve=a;else if(0<=["SC","CP"].indexOf(a))b.procreator=a;else if("GOST 28147"===
b.name)if(0<=["ES","MAC","KW"].indexOf(a))b.mode=a;else if(0<=["ECB","CFB","OFB","CTR","CBC"].indexOf(a))b.mode="ES",b.block=a;else if(0<=["CPKW","NOKW","SCKW"].indexOf(a))b.mode="KW",b.keyWrapping=a.replace("KW","");else if(0<=["ZEROPADDING","PKCS5PADDING","NOPADDING","RANDOMPADDING","BITPADDING"].indexOf(a))b.padding=a.replace("PADDING","");else if(0<=["NOKM","CPKM"].indexOf(a))b.keyMeshing=a.replace("KM","");else throw new p("Algorithm "+b.name+" mode "+a+" not supported");else if("GOST R 34.11"===
b.name)if(0<=["HASH","KDF","HMAC","PBKDF2"].indexOf(a))b.mode=a;else throw new p("Algorithm "+b.name+" mode "+a+" not supported");else if("GOST R 34.10"===b.name){var d=a.replace(/[\.\s]/g,"");if(0<=d.indexOf("GOST")&&0<=d.indexOf("3411"))b.hash=a;else if(["SIGN","DH"].indexOf(a))b.mode=a;else throw new p("Algorithm "+b.name+" mode "+a+" not supported");}});if("ES"===b.mode&&(a.block&&(b.block=a.block),b.block&&(b.block=b.block.toUpperCase()),a.padding&&(b.padding=a.padding),b.padding&&(b.padding=
b.padding.toUpperCase()),a.shiftBits&&(b.shiftBits=a.shiftBits),a.keyMeshing&&(b.keyMeshing=a.keyMeshing),b.keyMeshing&&(b.keyMeshing=b.keyMeshing.toUpperCase()),"importKey"!==c&&"generateKey"!==c)){b.block=b.block||"ECB";b.padding=b.padding||("CBC"===b.block||"ECB"===b.block?"ZERO":"NO");if("CFB"===b.block||"OFB"===b.block)b.shiftBits=b.shiftBits||b.length;b.keyMeshing=b.keyMeshing||"NO"}"KW"===b.mode&&(a.keyWrapping&&(b.keyWrapping=a.keyWrapping),b.keyWrapping&&(b.keyWrapping=b.keyWrapping.toUpperCase()),
"importKey"!==c&&"generateKey"!==c&&(b.keyWrapping=b.keyWrapping||"NO"));a.sBox&&(b.sBox=a.sBox);a.namedParam&&(b.namedParam=a.namedParam);a.namedCurve&&(b.namedCurve=a.namedCurve);"importKey"!==c&&"generateKey"!==c&&("GOST 28147"===b.name&&1989===b.version?b.sBox=b.sBox||("SC"===b.procreator?"E-SC":"E-A"):"GOST 28147"===b.name&&2015===b.version?b.sBox="E-DEFAULT":"GOST R 34.11"===b.name&&1994===b.version?b.sBox=b.sBox||("SC"===b.procreator?"D-SC":"D-A"):"GOST R 34.10"===b.name&&1994===b.version?
b.namedParam=b.namedParam||("EC-DH"===b.mode?"X-A":"S-A"):"GOST R 34.10"===b.name&&2001===b.version?b.namedCurve=b.namedCurve||(256===b.length?"SC"===b.procreator?"P-256":"EC-DH"===b.mode?"X-256-A":"S-256-A":"T-512-A"===b.mode):"GOST R 34.10"===b.name&&2012===b.version&&(b.namedCurve=b.namedCurve||(256===b.length?"SC"===b.procreator?"P-256":"EC-DH"===b.mode?"X-256-A":"S-256-A":"T-512-A"===b.mode)));switch(b.mode){case "DH":a.ukm&&(b.ukm=a.ukm);a["public"]&&(b["public"]=a["public"]);break;case "SIGN":case "KW":a.ukm&&
(b.ukm=a.ukm);break;case "ES":case "MAC":a.iv&&(b.iv=a.iv);break;case "PBKDF2":a.salt&&(b.salt=a.salt);a.iterations&&(b.iterations=a.iterations);break;case "KDF":a.label&&(b.label=a.label),a.contex&&(b.context=a.contex)}if(c&&("ES"!==b.mode&&"SIGN"!==b.mode&&"MAC"!==b.mode&&"HMAC"!==b.mode&&"KW"!==b.mode&&"generateKey"===c||"ES"!==b.mode&&("encrypt"===c||"decrypt"===c)||"SIGN"!==b.mode&&"MAC"!==b.mode&&"HMAC"!==b.mode&&("sign"===c||"verify"===c)||"HASH"!==b.mode&&"digest"===c||"KW"!==b.mode&&("wrapKey"===
c||"unwrapKey"===c)||"DH"!==b.mode&&"PBKDF2"!==b.mode&&"KDF"!==b.mode&&("deriveKey"===c||"deriveBits"===c)))throw new p("Algorithm mode "+b.mode+" not valid for method "+c);a.hash&&(b.hash=a.hash);b.hash&&(b.hash=h(b.hash,"digest"));a.id&&(b.id=a.id);return b}function l(a){return k&&k.subtle&&a&&(("string"===typeof a||a instanceof String)&&-1===a.toUpperCase().indexOf("GOST")||a.name&&-1===a.name.toUpperCase().indexOf("GOST")||a.hash&&a.hash.name&&-1===a.hash.name.toUpperCase().indexOf("GOST"))}function E(a,
c){if(!a.algorithm)throw new u("Key algorithm not defined");if(!a.algorithm.name)throw new u("Key algorithm name not defined");var d=a.algorithm.name,e="GOST 28147"===d,b="GOST R 34.11"===d,f="GOST R 34.10"===d;if(!e&&!f&&!b)throw new p("Key algorithm "+d+" is unsupproted");if(!a.type)throw new u("Key type not defined");if((e||b)&&"secret"!==a.type||f&&"public"!==a.type&&"private"!==a.type)throw new F("Key type "+a.type+" is not valid for algorithm "+d);if(!a.usages||!a.usages.indexOf)throw new u("Key usages not defined");
d=0;for(e=a.usages.length;d<e;d++)if(b=a.usages[d],("wrapKey"===b||"unwrapKey"===b||"encrypt"===b||"decrypt"===b)&&"secret"!==a.type||"sign"===b&&"public"===a.type||"verify"===b&&"private"===a.type)throw new H("Key type "+a.type+" is not valid for "+b);if(c&&-1===a.usages.indexOf(c))throw new G("Key usages is not contain method "+c);if(!a.buffer)throw new u("Key buffer is not defined");d=8*a.buffer.byteLength;if("secret"===a.type&&256!==d&&(0<=a.usages.indexOf("encrypt")||0<=a.usages.indexOf("decrypt"))||
"private"===a.type&&256!==d&&512!==d||"public"===a.type&&512!==d&&1024!==d)throw new u("Key buffer has wrong size "+d+" bit");}function n(a,c,d){E(d,a);if(c){var e;switch(c.mode){case "ES":e=["sBox","keyMeshing","padding","block"];break;case "SIGN":e=["namedCurve","namedParam","sBox"];break;case "MAC":e=["sBox"];break;case "KW":e=["keyWrapping","ukm"];break;case "DH":e=["namedCurve","namedParam","sBox","ukm"];break;case "PBKDF2":e=["sBox","iterations","salt"];break;case "KDF":e=["context","label"]}e&&
e.forEach(function(a){d.algorithm[a]&&(c[a]=d.algorithm[a])})}return d.buffer}function x(a,c,d,e,b){a={type:b||"secret",extractable:c||"false",algorithm:a,usages:d||[],buffer:e};E(a);return a}function I(a,c,d,e,b){if(!d||!d.indexOf)throw new u("Key usages not defined");var f=d.filter(function(a){return"sign"!==a});d=d.filter(function(a){return"verify"!==a});return{publicKey:x(a,c,f,e,"public"),privateKey:x(a,c,d,b,"private")}}function y(){for(var a=0,c=arguments.length;a<c;a++){var d=arguments[a].split("."),
d=z+d[0]+A+"."+d[1],e=document.querySelector('script[src="'+d+'"]');e||(e=document.createElement("script"),e.setAttribute("src",d),document.head.appendChild(e))}}function t(a,c,d){return new Promise(function(e,b){try{if(w){var D=++J;v.push({id:D,resolve:e,reject:b});w.postMessage({id:D,algorithm:a,method:c,args:d})}else f.gostEngine?e(f.gostEngine.execute(a,c,d)):b(new B("Module gostEngine not found"))}catch(m){b(m)}})}function r(a){try{a()}catch(c){}}function g(){}var f=this,k=f.crypto||f.msCrypto,
u=f.SyntaxError||Error,F=f.DataError||Error,p=f.NotSupportedError||Error,B=f.OperationError||Error,H=f.InvalidAccessError||Error,G=f.InvalidAccessError||Error;f.Promise||(f.Promise=function(){function a(a){return a&&null===a.oncomplete&&null===a.onerror?new c(function(c,b){a.oncomplete=function(){c(a.result)};a.onerror=function(){b(new B(a.toString()))}}):a}function c(d){function e(a){try{a()}catch(b){}}var b="pending",f,m=[],h=[];try{d(function(a){"pending"===b&&(b="fulfilled",f=a,m.forEach(e))},
function(a){"pending"===b&&(b="rejected",f=a,h.forEach(e))})}catch(k){"pending"===b&&(b="rejected",f=k,h.forEach(e))}this.then=function(d,e){return new c(function(c,k){function q(){var b;try{b=d?d(f):f}catch(e){k(e);return}(b=a(b))&&b.then&&b.then.call?b.then(c,k):c(b)}function g(){var b;try{b=e?e(f):f}catch(d){k(d);return}(b=a(b))&&b.then&&b.then.call?b.then(c,k):k(b)}"fulfilled"===b?q():"rejected"===b?g():(m.push(q),h.push(g))})};this["catch"]=function(a){return this.then(void 0,a)}}c.all=function(a){return new c(function(c,
b){function f(a){q++;return function(b){h[a]=b;q--;0===q&&c(h)}}function k(a){0<q&&b(a);q=0}for(var h=[],q=0,g=0,p=a.length;g<p;g++){var l=a[g];l.then&&l.then.call?l.then(f(g),k):h[g]=l}0===q&&c(h)})};return c}());var z="",A="";"undefined"!==typeof document&&function(){for(var a=/^(.*)gostCrypto(.*)\.js$/i,c=document.querySelectorAll("script"),d=0,e=c.length;d<e;d++){var b=c[d].getAttribute("src");if(b=a.exec(b))z=b[1],A=b[2]}}();var w,v=[],J=0;if(!f.importScripts&&!f.gostEngine)try{w=new Worker(z+
"gostEngine"+A+".js"),w.onmessage=function(a){for(var c=a.data.id,d=0,e=v.length;d<e&&v[d].id!==c;d++);d<e&&(c=v[d],v.splice(d,1),a.data.error?c.reject(new B(a.data.error)):c.resolve(a.data.result))},w.onerror=function(a){for(var c=0,d=v.length;c<d;c++)v[c].reject(a.error);v=[]}}catch(K){w=!1}f.importScripts||(f.importScripts=y);w||f.gostEngine||y("gostEngine.js");g.prototype.encrypt=function(a,c,d){return(new Promise(r)).then(function(){if(l(a))return k.subtle.encrypt(a,c,d);a=h(a,"encrypt");return t(a,
"encrypt",[n("encrypt",a,c),d])})};g.prototype.decrypt=function(a,c,d){return(new Promise(r)).then(function(){if(l(a))return k.subtle.decrypt(a,c,d);a=h(a,"decrypt");return t(a,"decrypt",[n("decrypt",a,c),d])})};g.prototype.sign=function(a,c,d){return(new Promise(r)).then(function(){if(l(a))return k.subtle.sign(a,c,d);a=h(a,"sign");return t(a,"sign",[n("sign",a,c),d])})};g.prototype.verify=function(a,c,d,e){return(new Promise(r)).then(function(){if(l(a))return k.subtle.verify(a,c,d,e);a=h(a,"verify");
return t(a,"verify",[n("verify",a,c),d,e])})};g.prototype.digest=function(a,c){return(new Promise(r)).then(function(){if(l(a))return k.subtle.digest(a,c);a=h(a,"digest");return t(a,"digest",[c])})};g.prototype.generateKey=function(a,c,d){return(new Promise(r)).then(function(){if(l(a))return k.subtle.generateKey(a,c,d);a=h(a,"generateKey");return t(a,"generateKey",[]).then(function(e){return e.publicKey&&e.privateKey?I(a,c,d,e.publicKey,e.privateKey):x(a,c,d,e)})})};g.prototype.deriveKey=function(a,
c,d,e,b){return(new Promise(r)).then(function(){if(l(a))return k.subtle.deriveKey(a,c,d,e,b);a=h(a,"deriveKey");d=h(d,"generateKey");a["public"]&&(a["public"].algorithm=h(a["public"].algorithm),a["public"]=n("deriveKey",a,a["public"]));return t(a,"deriveKey",[n("deriveKey",a,c)]).then(function(a){return x(d,e,b,a)})})};g.prototype.deriveBits=function(a,c,d){return(new Promise(r)).then(function(){if(l(a))return k.subtle.deriveBits(a,c,d);a=h(a,"deriveBits");a["public"]&&(a["public"]=n("deriveBits",
a,a["public"]));return t(a,"deriveBits",[n("deriveBits",a,c),d])})};g.prototype.importKey=function(a,c,d,e,b){return(new Promise(r)).then(function(){if(l(d))return k.subtle.importKey(a,c,d,e,b);var g,m,n;if("raw"===a)d=h(d,"importKey"),n=c,b&&b.indexOf&&(m=d.name.toUpperCase().replace(/[\.\s]/g,""),0<=m.indexOf("3410")&&0<=b.indexOf("sign")?g="private":0<=m.indexOf("3410")&&0<=b.indexOf("verify")&&(g="public"));else{if("pkcs8"===a&&f.gostSyntax&&f.gostCoding)m=f.gostSyntax.GostPrivateKeyInfo.decode(c);
else if("spki"===a&&f.gostSyntax&&f.gostCoding)m=f.gostSyntax.GostSubjectPublicKeyInfo.decode(c);else throw new p("Key format not supported");d=h(m.algorithm,"importKey");n=m.buffer;g=m.type;e=e||m.extractable;if(b)for(var q=0;q<b.length;q++){if(0>m.usages.indexOf(b[q]))throw F("Key usage not valid for this key");}else b=m.usages}return x(d,e,b,n,g)})};g.prototype.exportKey=function(a,c){return(new Promise(r)).then(function(){if(c&&l(c.algorithm))return k.subtle.exportKey(a,c);if(!c.extractable)throw new G("Key not extractable");
var d=n(null,null,c);if("raw"===a)return d;if("pkcs8"===a&&c.algorithm&&c.algorithm.id&&f.gostSyntax&&f.gostCoding)return f.gostSyntax.GostPrivateKeyInfo.encode(c);if("spki"===a&&c.algorithm&&c.algorithm.id&&f.gostSyntax&&f.gostCoding)return f.gostSyntax.GostSubjectPublicKeyInfo.encode(c);throw new p("Key format not supported");})};g.prototype.wrapKey=function(a,c,d,e){return(new Promise(r)).then(function(){if(l(e))return k.subtle.wrapKey(a,c,d,e);e=h(e,"wrapKey");return t(e,"wrapKey",[n("wrapKey",
e,d),n(null,null,c)]).then(function(b){if("raw"===a)return b;throw new p("Key format not supported");})})};g.prototype.unwrapKey=function(a,c,d,e,b,f,g){return(new Promise(r)).then(function(){if(l(e))return k.subtle.unwrapKey(a,c,d,e,b,f,g);e=h(e,"unwrapKey");b=h(b,"importKey");if("raw"!==a)throw new p("Key format not supported");return t(e,"unwrapKey",[n("unwrapKey",e,d),c]).then(function(a){var c;if(b&&b.name){var d=b.name.toUpperCase().replace(/[\.\s]/g,"");0<=d.indexOf("3410")&&0<=g.indexOf("sign")?
c="private":0<=d.indexOf("3410")&&0<=g.indexOf("verify")&&(c="public")}return x(b,f,g,a,c)})})};var C={};C.subtle=new g;s||k&&k.getRandomValues||y("gostRandom.js");C.getRandomValues=function(a){s=s||f.gostRandom;!s&&k&&k.getRandomValues&&(s=k);if(s)s.getRandomValues(a);else throw new p("Random generator not found");};return C});
